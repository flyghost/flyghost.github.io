###### 802.11（HaLow）协议解析

# 协议简介

## 序言

笔者最近读了一下802.11ah的协议，这里把学习到的内容整理一下。802.11ah是802.11协议族中IoT场景的一个专项协议，其具有两个主要特点：a）**面向“大连接”**，b）**节能低功耗**。802.11ah工作在Sub-1GHz频段的ISM信道上。虽然802.11ah在商业上不是很成功，但是其协议设计中有很多内容还是比较值得借鉴和参考的，本文我们首先整体介绍一下802.11ah的协议。

## 802.11ah和HaLow

802.11ah是协议组的命名，而HaLow是Wi-Fi联盟对于802.11ah协议的命名。HaLow这个命名其实算是非常不错的，有几种说法：

- 1）Low代表的是低功耗，而Ha可以代表"Hay-"或者"Halo"。
- 2）HaLow整体的命名接近于Hello，比较好记。
- 3）Ha还有一种意思可以理解，就是其是倒过来的aH，也就是代表了802.11ah。

至于Wi-Fi联盟为什么命名为HaLow，我目前理解大致就是前面三种原因。

## 802.11ah的定位

802.11ah是802.11协议组为了进军IoT市场，所设计了一个面向大连接IoT的技术协议。该协议是工作在Sub-1G频段的。我们知道802.11协议实际上就是Wi-Fi（主要对象就是无线局域网），不过随着市场的不断发展，802.11协议组也会不断出征，希望占据一些其他领域的网络业务，比如说IoT（即802.11ah），VR/AR这种近距离的图像传输（802.11ad/ay）。这些新扩展的协议往往是基于802.11的核心框架，并加以大刀阔斧的改进，从而为了自己的技术目标服务。所以在学习802.11ah的时候，我们完全需要把它作为一个新的协议来看待，毕竟它的修改体量还是挺大的。不够802.11一以贯之的特点在ah中还是继续存在的，也就是Best-effort。

目前在IoT市场而言，已经有了非常多的网络协议，如下图，大致是一个IoT方面的协议总结：

![img](https://pic2.zhimg.com/80/v2-a14ce504a2efddabc0bdc2144067acb5_720w.jpg)

**802.11ah和802.11ax的关系**：其中我们主要是关心802.11协议关于IoT的部分，这里我们需要注意的是，802.11的IoT布局实际上是分了两个部分的协议：

![img](https://pic3.zhimg.com/80/v2-7a6df876351a8a0efa1b5803fc22385a_720w.jpg)

- 1）**Wi-Fi 6（802.11ax）**，这个是面向了类似智能家居这样的室内场景的IoT，同时追求速率和功耗，其还是工作在2.4GHz和5GHz频段，与当前的802.11协议兼容。Wi-Fi本身是一个范畴面比较多的协议，其既包含了高速率的设计部分，同时也加入了低功耗的功能。具体可以是设备厂商根据自己的需求，选取不同的功能进行扩展开发。
- 2）**HaLow（802.11ah）**，802.11ah实际上是面向传感器网络这一类的场景了，实际上是IoT最经典的传感器网络这个场景。传感器网络的场景有两个特点，a）节点数目多，是一个典型的大连接场景，b）通常传感器都是用电池供电，也就是对于节能的要求更为苛刻。

**802.11ah和802.11af的关系**：802.11ah是工作在Sub-1GH频段的，而还有一个802.11协议也是工作在Sub-1GHz频段，也就是802.11af，前者是为了IoT，后者是为了在电视无线信号的频段上覆盖Wi-Fi类型信号。802.11ah和802.11af的初始定位完全是不同的，一者是IoT，另外一个是偏向了认知无线电了。但是对于很多开发者而言，在Sub-1GHz频段内，接连两个802.11技术的有关协议，其实反而是造成了内部竞争。

另外，关于802.11ah和其他有关的IoT协议之间的关系，可以参考下这张图

![img](https://pic3.zhimg.com/80/v2-5d5060cf5f95b344902ec859711f042e_720w.jpg)参考：https://www.myoschain.com/blog/140120188812001280

总体上而言，这张图的描述是准确的，802.11ah相比于其他的一些协议，从性能上而言，的确是比较平均，而且质量都还是不错。不过最后没有成功的原因，可能还是偏向于实现该技术的成本和稳定性上，802.11ah在我目前看来，其是对802.11协议框架有了较多的改变，其保留了802.11的大框架，但是细节部分实际上做了很多的改变，所以技术成本还是有一些的。

综上，802.11ah是面向"大连接类型"的IoT协议，工作在Sub-1GHz的频带。我们下面大致说民下其协议的具体需求。

## 802.11ah的设计目标

802.11ah的设计目标主要体现在，1）大连接（支持最高8191个节点），2）远距离（单个AP最大1Km的覆盖，支持Relay AP），3）高可靠，4）低功耗，5）安全性好（支持802.11的加密标准），这一系列的特点。从我个人理解而言，我更倾向于把802.11ah的目标说成，是基于802.11的协议框架，面向大连接，远距离，低功耗这个三个因素，做协议的修改。具体设计过程中，我比较倾向于是直接基于802.11ac的协议，引入了大连接，远距离，低功耗这三个特点，实际上，802.11ah和802.11ax的一些技术特征上是类似的，比如TWT，BSS Color，两者都支持，而且实际上ax是借鉴ah的，但是在细节设计上，两者还是有比较大的差异。

具体参数可以参考下图

![img](https://pic3.zhimg.com/80/v2-0b3be6e9b9f911f8a95b3dfe57ba7ae6_720w.jpg)参考：https://www.standardsuniversity.org/e-magazine/august-2016-volume-6/ieee-802-11ah-wi-fi-900-mhz-license-exempt-band-iot-application/

## 802.11ah的技术特点

802.11ah有很多新的技术引入，总体而言可以总结几个特点，1）**物理层的带宽多样性**，2）**对节点进行分组管理，以分组调度的方式进行节能工作**，3）**将MAC层的功能下放到PHY层以提升协议性能**。

![img](https://pic3.zhimg.com/80/v2-384dd6155d49c9c7199430a9d45aa3da_720w.jpg)

具体而言，可以参考上图。802.11ah的协议特点包含了：

- 1）**Channel with SST（Sub-channel Selective Transmission）**：802.11ah支持5种带宽模式，分别是1MHz，2MHz，4MHz，8MHz和16MHz，可以在使用过程中采用SST方式进行选择发送。
- 2）**Relay**：802.11ah是支持Relay AP的，单个AP的覆盖范围最高是1km，所以如果为了扩展更远的距离，那么就需要引入Relay AP。
- 3）**BSS Color**：BSS Color是为了增加信道复用的能力，该技术在Wi-Fi 6中也被引入。其第一次被引入是在802.11ah里面的，目的和Wi-Fi 6是一样的。
- 4）**Group sectorization**：这也是一个分组的方式，扇区分组，是为了提升MAC层性能的一种调度方式。
- 5）**4-Level hierarchical device groups**：这也是一个分组，主要体现在TIM结构上。其是讲分组机制优化到节能工作模式下，通过分组轮询的模式，节省了能耗的同时，能够有序的轮询所有的分组节点。
- 6）**Restrictred Access Window with EDCA**：缩写为RAW，主要描述其在竞争模式下，采用RAW这种改良过的竞争方式，减少“大连接”场景下，因为节点数多所造成的冲突概率大的问题。
- 7）**OFDM with 4 spatial streams**：这个还是为了连接速率，802.11ah继承与802.11ac，最大允许4个空间流。

其余802.11ah还有**双向TXOP优化（Bi Directional TXOP），NDP控制帧优化，Traveling pilots and pilot boosting**等技术特点。技术特点的细节我后面整理的时候，再进行整理，本文就不展开了。

最后就是总结一下，802.11ah从协议设计上而言，确实是对802.11协议框架做了一次非常不错的灵活应用。不过目前IoT市场的主导还是感觉是低成本，而802.11ah一开始的起始点实际上是802.11ac，即其是在802.11ac基础上进行设计的，所以相对成本还是高一些，导致其在IoT的市场上，并没有引起很大的波澜，不过我们主要还是以关注协议设计为主，希望从中能够扩展对802.11协议体系的理解。

# 协议设计目标

## 序言

关于802.11ah这个坑埋了几个月了，还是最近填了吧。本文主要谈一谈802.11ah的设计目标方面的内容，802.11ah的设计目标和具体协议内容还是比较紧密关联的，是一个比较工程型的精巧协议。额，不过这种精巧仅仅是协议设计上而言，是否实用这一点还有待谈论。

## 802.11ah的现状

802.11ah现在在国内应该已经式微了。在802.11ah的PAR时期，其考量中国国内对应的频段是779-787MHz，不过现在这个频段已经被划分给了5G通信了（详见工业和信息化关于调整700MHz频段频率使用规划的通知/工信部无[2020]50号），具体是将703-743/758-798MHz频段划给移动通信系统。

## 为什么要研究802.11ah？

不过为什么要研究802.11ah，或者说关注这个协议呢。笔者观点是，802.11ah是一个非常具备802.11风格的独立协议，具有完整的PHY/MAC改良。另一个同级别的就是802.11ay，也就是毫米波系列了。现在国内大家很多也开始关注到改进802.11协议，或者说想在协议组内积极参与协议的提案，从而802.11ah就是一个比较好的示例。从对比其PAR，到最终实现PAR的几个目标采取的方法，能够获得一些灵感或者思路，或者说理解一些关于802.11的路子。

## 802.11ah的命名

上一篇主要讨论了关于hallow的命名，这里我们看下为什么使用802.11ah这个代号。实际上感觉802.11协议组从以a开始打头的新的一轮协议命名后，其实就是按照字母顺序往后排的。802.11aa，802.11ab，802.11ac，802.11ad，802.11ae，802.11af，802.11ag，然后就是802.11ah了。其中802.11aa，802.11ac，802.11ad，802.11ae，802.11af都是协议名，这些都是具体的协议代号了，而802.11ab，802.11ag很容易和802.11a/b，802.11a/g这样的表述混淆，所以这个代号也没有使用，所以关于Sub-1G频段下的802.11协议就是采用802.11ah的命名了。

## 802.11ah PAR定的设计目标

我们主要关注的是802.11ah的PAR中的Scope部分，其中可以当做有两个部分的说明

![img](https://pic2.zhimg.com/80/v2-78eaff5e50646394bd0436e08c45db2d_720w.jpg)

**第一个部分**是关于802.11ah的工作频段，其定义了802.11ah是在Sub-1G频段下，以OFDM作为物理层机制工作的一种传输协议。而且这里注意，其强调了要考虑到了与802.15.4以及802.15.4g的兼容共存性，采用802.15.4作为物理层技术的典型协议就是zigbee。为什么要强调这一点其实和802.11ah的典型应用场景有关。参考802.11-11/0457r0，我们着重举两个例子：

![img](https://pic4.zhimg.com/80/v2-5e2a5409e509db022583ef15dd025e3b_720w.jpg)

例1是一个智能电网或者说智能仪表的例子，其中多个仪表和控制设备，通过有线或者无线的方式连接到802.11ah的AP上面进行数据交换。这里802.11ah的AP，其实和802.11一般意义上的AP概念差不多，都是无线交换的概念，这里可能会更加偏重于物联网网关一些吧。

![img](https://pic4.zhimg.com/80/v2-a04e0882d268214fa724b748d9cf701b_720w.jpg)

例2是我觉得值得拿出来看一下的，这里更明显是一种物联网网关的概念了。这里是作为一种工业自动化控制的AP出现的，其主要是作为控制中心骨干网络派生出来的AP，用来汇总数据到控制的骨干网络上。802.11ah的AP可以作为1级设备，直接可以与配备了802.11ah终端的控制设备连接，也可以作为2级设备，将其与802.15.4的路由连接起来，再转换为802.11ah的信号反馈到骨干网络上去，让无线传感器之类的设备还是保持现有的802.15.4的物理层技术不变，但是还是引入了802.11ah做汇总的功能。例2就可以对应说明，PAR里面强调的这一句，802.11ah设计时需要考虑到与802.15.4和802.15.4g的兼容问题，这个是与预设场景有关的。

**Remark：关于802.11ah在Sub-1G的工作频段，这里需要注意的是在协议定义中，802.11ah可以使用的是Sub-1G以下非TVWS的频段，因为802.11协议在Sub-1G下还存在一个802.11af的协议标准，两者在频段上是分离的。**

**第二个部分**就是预想的传输速率和传输距离了。预设的传输速率是大于100kbits，传输范围是1km。这个也是一个预设条件，是根据前面说的预设场景所量化的传输指标，并且很多MAC层的机制，也是围绕着这个指标进行考量的。

![img](https://pic1.zhimg.com/80/v2-8027821e7e6b06155e3fd4ac52230954_720w.jpg)

参考WiFi联盟关于802.11ah的白皮书，可以看到802.11ah和其他技术的比较而言，其传输的覆盖范围并不是最远的，但是其相对的参数是比较偏高的，可以理解成综合参数吧。802.11ah的传输速率偏高主要是其物理层是直接基于802.11ac的技术框架设计的，ah的初期设计就考虑了多流的属性，不过实际而言，感觉在广覆盖场景下，这点实际作用不大。所以为什么要讨论这一些呢，主要是说明两点：

- 802.11ah的预设条件是1km覆盖，传输速率是100kbits。
- 802.11ah的潜在设计条件，是在上述的计划下，优化在1km覆盖内的传输速率。

这里我们就会在设计中感觉到，802.11ah的设计中，近距离的时候相比其他的物联网协议而言，具有很强的物理层性能，距离远的时候，其物理层性能也不弱。但是，这导致的问题就是从设计成本上而言，802.11ah不低。也是前面说的，802.11ah是基于802.11ac的机制往后设计的，基于802.11ac的成本大致也可估计802.11ah的成本。而其他大多数的物联网协议而言，一般仅仅是为了满足基本的预设条件，其也会导致其性能曲线比较中庸，但是可以降低成本。

目前看到的WFA在推广802.11ah，即hallow的时候，还是比较强调其在给定的1km范围内，性能综合是最优的作为卖点，如果成本也是可控的作为卖点的话，那么ah还算是有些潜力的吧，不过控制成本可能就需要具体IC做一些功能上的优化了。

那么这里预设中还存在一个问题，就是预设条件的覆盖范围只有1km，这个其实在IoT场景中并不算远，很多情况下都达不到用户的需求。所以在802.11ah中还有一个潜在的假设就是AP级联的场景，802.11ah的AP与AP通过无线进行桥接反馈信号到骨干网上，在MAC层协议时候，我们看到其相关设计就比较容易理解这一点了。

## 802.11ah和802.11af

在Sub-1G频段下，802.11协议组还有一个协议叫做802.11af。802.11af使用的是Sub-1G频段下对应的TVWS频段，即TeleVision White Spaces频段。802.11af和ah的设计初衷有点区别，802.11af的前身其实比较偏重于802.11h了，属于类似认知网络的一种，在TVWS频段没有别人使用的情况下，可以有效利用其进行无线传输，毕竟这个频段往年也被称为黄金频段。802.11af的设计范围比802.11ah还要广，可以说是超大范围的覆盖了吧。但是其两者协议虽然有很大的差别，但是由于其共处于Sub-1G的频段，即使是开发者大多也无法很好的区分它们，导致这两个协议都没有被很好的推广出去。目前这几篇文章主要还是围绕着802.11ah去谈，关于802.11af又属于一个坑了，以后再慢慢补了。

# 物理层改进

## 序言

关于802.11ah的物理层实际上改进的内容还算是意料之类的，也可以说是为了扩展传输范围所做的一些通用的改进，本文主要做一个简单的整理。

## 802.11ah的物理层改进概述

我们参照下面这张图（Ref: Intel - Enabling Wi-Fi Internet of Things with 802.11ah Technology）看下802.11ah关于物理层部分的基本内容

![img](https://pic4.zhimg.com/80/v2-19f386be7fc69145b53be0191af8134b_720w.jpg)

这张图已经整理的挺清楚了，主要是4个部分的内容：1.带宽的多元化，2.长距离传输支持，主要是引入了MCS10（实际上是MCS0 with 2x repetition），3.pilot的修改，以及更大的保护间隔，4.CCA的阈值修改。

## 802.11ah的带宽

![img](https://pic2.zhimg.com/80/v2-28568ef71ad17581bf897b31fa684239_720w.jpg)

我们说多带宽是当下协议中普遍存在的一种迹象，在LTE/5G-NR类型的协议中，多带宽的根源主要是牌照频段比较零散，

在802.11ah以前的协议中，带宽的主要代表是以20MHz为基本带宽。随着802.11协议的继续发展，带宽的多样性就需要伴随着业务做优化设计，以信道绑定为代表的多种带宽组合，比如40MHz，80MHz和160MHz。

虽然在802.11a时代就有了5MHz和10MHz的带宽，但是这里窄带宽的目的是为了避免对于雷达一些的干扰，在特定的国家采用，而且这样的窄带宽事实中很少有所应用。5MHz和10MHz这样的带宽也还是有所发展的，主要应用场景是802.11p作为物理层技术的车联网协议上，这里的采用低带宽的目的是为了划分更多的信道。

802.11ah的目的就和以上有所不同了，主要是为了提升传播的距离，所以802.11ah提供了1MHz，2MHz，4MHz，8MHz和16MHz几种带宽模式。我们可以按照上面的思路，意会802.11ah设计带宽的思路，不过在实际802.11ah中，需要注意的是1MHz，2MHz实际为最基本的带宽。所以后面4MHz以上的几种模式下，其实还是信道聚合的思路，这一点需要注意下。另外，之所以802.11ah可以做这样的设定，核心原因在于其不是工作在传统的2.4GHz/5GHz频段上，所以无需进行兼容性的保护。

在Wi-Fi 6中对于物联网IoT的扩展中也类似的设计，不过带宽和802.11ah的不同，在Wi-Fi 6中，对应的带宽选择为10MHz，这个就是类似的目的，但是属于兼容性保护了。

## MCS速率支持

前面说过802.11ah的基本带宽是1MHz，其对应的速率是150kbs。不过802.11ah的设计模板设计上是基于802.11ac的，所以其本身是提供多天线的支持能力的。详情可以看下面这张表格（参考IEEE 802.11ah: Sub-1-GHz License-Exempt Operation for the Internet of Things）

![img](https://pic4.zhimg.com/80/v2-d8de18fad94e8c148333ddc09269066f_720w.jpg)

细节就不展开谈论了，理解802.11ac的速率架构很容易对应到802.11ah上理解，唯一需要提一下的是802.11ah的MCS10，也就是对应MCS0 with 2x repetition。

![img](https://pic3.zhimg.com/80/v2-be2d3d7c4f5eef3b9c82f9ef2350a502_720w.jpg)

这里直接摘取协议里面的图了，其实原理也比较简单，实际上就是对应的PPDU复制一份，然后再经过BCC编码，然后就是标准的发送流程了。这里重点要和DCM调制方式区分对待一下，相比DCM而言，MCS10的方式更简单一些。DCM初次在协议中应用应该是在802.11ad中，此后在802.11ax以及之后的协议，比如802.11be，802.11bd（也就是802.11NGV）中都有所应用。DCM的之前在《[Wi-Fi 6(802.11ax)解析25：DCM双载波调制技术](https://zhuanlan.zhihu.com/p/108558786)》有写过，这里就不重复了。

## Traveling pilot

讨论pilot，我们首先要回到前面802.11ah的带宽问题上。我们说802.11ah的基本带宽是1MHz，并且这里就需要添加说明下，在1MHz的频带宽度上跑的是32点的FFT/IFFT。我们做一个简单计算：

- 传统的802.11带宽是20MHz，跑的是64点的FFT/IFFT，所以其单个子载波的频宽是20MHz/64=0.3125MHz=312.5KHz。
- 在802.11ax以后，带宽不变，但是跑的是256点的FFT/IFFT，所以单个子载波带宽是20MHz/256=0.078125=78.125KHz。
- 在802.11ah中，基本带宽是1MHz，跑32点的FFT/IFFT，单个子载波的带宽是1MHz/32=0.03125MHz=31.25KHz。

由于传统的802.11和802.11ax的场景主要还是偏重于室内场景，而且其单个子载波的带宽比802.11ah要大，其能够抵抗频偏的能力会强一些。而802.11ah的子载波带宽仅为31.25KHz，这会导致其会更容易受到多普勒频偏之类的影响，所以这里就需要对频偏做修正了。而传统的802.11单个子载波带宽较大，仅仅通过带宽就可以抵抗频偏的影响，所以其频偏的修正就比较简单了。

在《[802.11协议精读8：再论802.11a/g的发送过程与接收过程](https://zhuanlan.zhihu.com/p/21496609)》一文中，我们阐述过传统的802.11是采用固定几个子载波作为pilot，主要功能是做一些信号的修正的。这里更直接的说，主要是做CPE修正，避免接收机在解调时由于频偏造成的星座图旋转的。而由于802.11环境下，主要的频偏来源是物理硬件，比如晶振本身的PPM，所以修正只需要在固定子载波放置pilot即可。

而在802.11ah中，由于子载波带宽变小了，而且场景有可能会受到多普勒效应的影响，所以需要对其进行修正。这里我们需要知道，Pilot的形状是密切和频偏产生的原因关联的。在802.11ah中，对应的pilot图案如下。

![img](https://pic3.zhimg.com/80/v2-fda4fd5615e6b35a427da1a02cbbefea_720w.jpg)

这种梳状的pilot图案实际上和LTE中的RS信号就是一样的了，不过具体在重复方式上略微有所区别，但是总体结构上是一样的。需要注意的是，由于多普勒频移也会在时域上体现出现，所以传统的固定子载波的Pilot就不适用于802.11ah的场景了，取而代之的就是上图的示例。

## Longer Guard interval

这里就按照前面的截图继续写了，在概述中还有说明其采用了更长的保护间隔，具体体现为两倍的保护间隔。这点实际上是非常微妙的，我记得在802.11ah协议中，只有一处谈论过这个保护间隔2倍的问题，主要就是在LTF字段上

![img](https://pic1.zhimg.com/80/v2-fd61a8153f4bd9e3fad8ab7cd50447b8_720w.jpg)

其中，GI是单倍的保护间隔，GI2就是双倍的保护间隔了

![img](https://pic3.zhimg.com/80/v2-dac2df18410b2e08b6c481f6aa67cf76_720w.png)

所以LTF1（也就是单流模式下的LTF），其结构是GI2/LTS/LTS/GI/LTS/GI/LTS的。这里之所以说比较微妙是在于，传统的802.11的LTF部分是GI2/LTS/LTS，如下图所示

![img](https://pic4.zhimg.com/80/v2-66f6d624c9b50b6db16a77d11b6efa23_720w.jpg)

所以与其说是LTF部分多了GI2，倒不如说是其结构上后面多了两个GI字段和对应的LTS了，这里由于是协议原图，应该是可以明确的。这里LTS的意思是Long training symbol和上图中的T1，T2的意义是一样的。不过，为什么802.11ah在LTF里面要搞GI2/LTS/LTS之后，不直接重复GI2/LTS/LTS，而是搞成了GI/LTS/GI/LTS的结构，这里笔者还在好好思考下，虽说这个和GI2/LTS/LTS重复本质是一样的，但是这里为什么要这样写，是故意的还是写错了，这里还在思考中ing的。

## CCA的阈值

在802.11ah中，关于CCA的阈值还与节点类型有关，802.11ah中将Station分成了两种类型：

![img](https://pic1.zhimg.com/80/v2-0478dbf115926fe9ac53cbd09f927bb8_720w.png)

![img](https://pic2.zhimg.com/80/v2-3c527e1300bb3c526d47363fc4642fcd_720w.png)

关于这两种STA的具体区别，笔者后面再整理。这里主要说明的是其对应两种不同的场景，设计了不用的CCA阈值以适用。

这里type-1偏重的是sensor-station的模式，采用是-98dBm的阈值。其实这个有两个部分的理解，一者这个是主信道的检测阈值，而且这个阈值除了用来检测信道是否空闲，另外主要是在接收状态是，用来检测数据帧的物理层头部的。在802.11ah的协议中，其还用了检测the start of a S1G PPDU之类的描述。

而type-2，虽然图上说明是普遍用于non-sensor station，不过实际上而言，这个更偏于一种纯粹能量检测阈值，其协议描述中我们也是可以从两个角度理解，一者是其用来检测PPDU传输过程中的信道是否空闲，二者是其更多被用于检测在2MHz，4MHz等以上信道绑定的情况下，检测其从信道上是否空闲，这时的检测阈值就是用的是-89dBm了。

以上大致算把802.11ah的物理层改进说明了一下，另外还有一个NDP帧的改进，这个后面再单独补充了。具体而言，物理层改进还是比较常规的，在MAC层改进上，802.11ah的内容会更多一些，所以下面就打算先开始讨论802.11ah的MAC层机制了。

# MAC层改进概述

## 序言

802.11ah的MAC层就是有多内容可以探讨了，802.11ah的物理层其实没有太多出奇的东西，大多都是情理内的改机改进。但是MAC层一般就是802.11协议系列喜欢玩花样的地方，在802.11ah内体现的也比较多。而且在Wi-Fi 6里面应用到的TWT，BSS Coloring技术，其一开始就是在802.11ah里面引入的，在我们理解Wi-Fi 6技术的时候，也可以对比参考一下。

## 802.11ah的MAC层改进

我们还是参考（Ref: Intel - Enabling Wi-Fi Internet of Things with 802.11ah Technology）这份资料看下overview。这份资料的总结还是不错的，不过细节方面少了点就是，但是总体概论看这份资料的总结是挺好的。

![img](https://pic3.zhimg.com/80/v2-7a265b02044911e8a88002243aa5485a_720w.jpg)

上图总结已经很到位了，总结了大致802.11ah一共有6个方面的改进，已经挺全的了，不够还是少了RID，BSS coloring和基于802.11ai的Fast Assoication and Authentication等，这里主要是概论一下，具体内容到时候还是逐个讨论吧。

- 首先是关于Tx/Rx Time的降低，这个主要是指从帧格式上压缩空间，比如说复用NDP字段，降低MAC帧头部大小，降低Beacon帧的大小（也就是说的管理帧）之类。
- 然后是延长睡眠时间，节能。这里核心就是TWT，还有就是基于TIM的TWT机制，TIM实际上要和下面的RAW对应的MAC机制连在一起理解，是一种基于分组的睡眠方式了。
- 然后是MAC层主要接入机制的改进，802.11ah是支持大量节点场景的，但是CSMA/CA机制会导致在节点数较多的时候，冲突率增加。所以为了降低冲突概率，降低节点数做分组竞争接入就是最合适的，这种机制在802.11ah里面就叫做RAW。这里把RAW单纯的分类到了MAC竞争部分了，实际上而言，RAW和节能也是密切相关的，这个分组我们还需要注意的是一个动态过程，不是纯粹的静态分组，这一点我们单独讨论RAW的时候再拿出来说。另外还有一个改进的就是TXOP，MAC竞争部分是BDT（Bidiectional TXOP），还有关于Duration机制的改变，即引入的Second Virtual Carrier Sense RID机制，这个也有待一说，理解了对于理解Duration的本质更有帮助。
- 然后就是多信道selection的SST机制，这个目前我只在ah里面看过，可以单独谈一谈。
- Relay的部分也是一个重点，这里本质上还是两个TXOP技术改进，不过目的和MAC竞争部分不一样。我们在802.11ah的设计目标里面就说过，802.11ah AP的基本覆盖范围是1km，如果用户需要更大的覆盖范围，那么就需要多AP级联。那么为了进一步改善性能，这里就有一个TXOP sharing技术改进，另外为了避免暴露终端问题，还有一个基于TXOP的Group Sectorization。这个就值得谈一谈了，都是为了解决暴露终端，Wi-Fi 6，也就是802.11ax里面是通过BSS Coloring+SRP空间复用实现的，而802.11ah是通过有向+定向波束的动态调用实现的，很有对比性。
- 最后就是把TIM字段给独立分列了一个，这点也值得单独说一下，对于理解AID的结构，以及结构化AID结构是很有帮助的。AID在802.11协议中也是非常灵活的一个设计，是需要深入理解的。

## 802.11ah的MAC架构

另外我们要看下802.11ah的MAC层协议架构了。目前最新的802.11协议（即md draft 4.0以上了吧），802.11的MAC架构已经挺复杂的了，还包含了DMG和S1G的各种情况。所以现在直接看协议的总章确实有些入门槛了，所以我们还是建议分列出来理解方便一些。

![img](https://pic4.zhimg.com/80/v2-0d015387ab83c4f946c6d4f0ed133187_720w.jpg)

上图就是目前802.11ah的协议架构，底层是S1G PHY，相关技术在前一篇已经提过了。然后是DCF，802.11ah的MAC底层还是DCF机制，该机制非常灵活，在其基础上可以引入其他的接入机制。

在802.11ah的基本接入包含EDCA，RAW和TWT三种机制，这里相比于传统的802.11接入机制少了PCF（最新协议标准PCF其实已经删除了），HCCA还有MCF。而RAW是802.11ah独有的MAC层机制，另外TWT也是一个新加的机制，不过在Wi-Fi 6中也有用到TWT机制。

以上就是802.11ah的MAC层技术的概述了，关于MAC层技术而言，由于很多都偏重于细节，后续在逐个讨论，这里主要先做一个概述总结。

# MAC头部压缩（Header Compression）

## 序言

在所有的802.11协议中，很少有见到对MAC帧头部内容的进行优化的，最多也只是加内容，很少有见到对于具体内容做优化的。这点也是因为802.11ah工作在Sub-1G频段上，才可以这样做吧，本文主要关心802.11ah的MAC头部压缩（MAC Header Compression）。当然这种压缩并不是通常意义上编码的压缩，而是指体积的一种裁剪，压缩帧头部的大小。为了降低头部的大小，802.11ah在处理的时候基本思想就两点，

1. **没用的字段删掉，把一些功能提出来用一个bit控制即可。**
2. **用AID来代替MAC地址，将地址大小压缩一下。**

基本上述两个基本思想，我们下面具体讨论下协议中的设计。

## 802.11ah的MAC Header版本

802.11ah定义了一种新的帧头部类型，即PV1类型（Protocol Version 1），而对应的传统的802.11 MAC header就是PV0类型了。

如何实现MAC Header定义不同的版本号呢？我们以一个基本的802.11 MAC Header作为示例，如下图所示

![img](https://pic1.zhimg.com/80/v2-0b90eb0646ec849a2b12eb75b6993b94_720w.jpg)

其中第一个字段就是Frame control，这个字段其实功能非常强大，其负责定义802.11 MAC Header的整个格式。比如说802.11数据帧和802.11 ACK/CTS之类的帧结构上是有差异的，这个结构差异就是通过Frame control字段控制的。而且需要注意的是，802.11 MAC Header并不是按照普通的TLV解析方案，也不是固定死的结构，而是基于Frame control定义的一种动态的解析方案，这一点在写协议精读的时候，我在展开来说。在本文中，我们主要关于Frame Control控制协议版本的功能，Frame Control字段（下图是普通的802.11的Frame Control）打开为

![img](https://pic3.zhimg.com/80/v2-ce652cd466e8af426908eeecaab72482_720w.png)

其中第一个字段就是Protocol Version，总共占两位。这个字段是整个协议的版本定义，通过这个字段可以二次修改对于Type和Subtype的解析，然后通过type相关字段的解析，进一步确定Frame Control里面其他字段的解析，这是一种级联的格式定义。所以，在802.11ah中，就是通过该字段定义MAC Header的版本号，老的叫做PV0，新的叫做PV1。

***Remark：不过需要注意的是，802.11ah里面不是绝对就使用PV1类型的帧，在一些情况下，照样也会使用PV0类型的MAC头部。\***

## 802.11ah PV1的Frame Control

关于802.11ah的PV1 Frame Control的解析实际上是可以注意下的，在802.11ah中，新增的PV1结构的Frame Control和传统的802.11在解析结构上还是有点区别的。

![img](https://pic2.zhimg.com/80/v2-2e44264f1f2ff7af2c88cc2b6030294d_720w.jpg)

上图是802.11ah PV1的Frame Control字段。这里可以和前面的普通802.11的Frame control对比下，注意，这个Frame Control的具体内容和上一节中Frame Control有区别。PV1的Frame Control总长度还是15个bits，不过具体字段上的解析就有不少区别了。比如Type字段变成了3位，实际上就显示了802.11ah帧有更多的类型，那么协议显示如下

![img](https://pic2.zhimg.com/80/v2-5ea48c16acf32313fd0573bdbf2b7de1_720w.jpg)

![img](https://pic4.zhimg.com/80/v2-575d9948ff8497f7569eae43cc0b4773_720w.jpg)

而传统的帧类型就一共4种，0管理，1控制，2数据，3扩展，但是在PV1 type中，0和3是QoS Data，1是管理，2是控制，7是扩展。

在PV1类型的Frame control中我们还可以看到关于第13~15位的用法，实际上是代替了传统的关于QoS Control部分功能的字段，比如ACK Policy。在传统的802.11协议中，该字段是放在MAC头部中的QoS Control部分的，这里降到了Frame control中，那么在MAC Header部分就能够裁剪压缩了。另外我们还需要注意From DS字段还保留着，但是To DS字段已经没了，但是在帧结构中还存在A1,A2,A3,A4这种case，那么在PV1中具体是在SID字段中解析出来的，这个在下一节中讨论。

## 802.11ah PV1的MAC Header

然后我们下面继续对比下802.11ah PV1的MAC Header（参考802.11ah-2016）和标准的802.11 MAC Header（参考802.11-2016）。下图中的PV1就是802.11ah新增的MAC头部了，实际上就是删了几个冗余的字段，图中的A1的A就是address的意思。

![img](https://pic4.zhimg.com/80/v2-ee390c193cf99706954cafe97aa686b7_720w.jpg)

对比下图的传统头部我们看一下

![img](https://pic1.zhimg.com/80/v2-c4296a9ac3b95f77c47bac717ba0d7c8_720w.jpg)

**裁剪的部分**主要是针对三个字段：Duration/AID，QoS Control，HT Control。

- 第一个是**Duration/AID**字段，这个机制比较重要，现在是通过RID机制来代替的（协议中的名字是SID字段），就是Secondary Virtual Carrier Sense机制来代替了基于Duration字段的NAV（也就是Virtual Carrier Sense），这个讨论RID的时候展开来说，这里知道802.11ah的头部少了这个字段即可。
- 第二个**QoS Control**，前面在PV1的Frame Control也说过了，基本功能已经提取到Frame Control中了，所以QoS Control就不再需要了。
- 第三个**HT Control**是802.11n对应的，在802.11ah中没有什么需要用到的功能，所以可以删了。

**地址压缩的部分**主要是针对**Address 1**（Address 2也可以做类型优化，但是Address 1的功能最突出）。传统的802.11头部中，Address 1是6个Byte，对应节点的BSSID，也就是通常意义上的MAC地址。而在802.11ah中，该字段最多可以压缩到2个Byte，协议中命名为**SID**（Short ID） Field，其核心内容是节点BSSID对应的AID地址。那么SID具体打开如下

![img](https://pic4.zhimg.com/80/v2-eb8347672eee31394e60cfecf1af704b_720w.jpg)

也就是说在802.11ah的MAC头部中，A1字段可以解析成SID field，并且进一步解析中，其前0-12位解析成AID。第13和14位还解析成功能字段，用来体现帧结构中是否有A3和A4的内容，对应到传统的802.11协议，这里A3和A4不是通过SID机制来做的，而是通过From DS和To DS两个字段对应解析的。而第15位是用来显示有没有执行MSDU的帧聚合的。

另外Sequence Control也是可以优化掉的。从而通过这个方式就可以将MAC Header进行大量的压缩，减少其体积了。

## 802.11ah PV1的使用条件

其实802.11ah PV1帧结构的使用一般而言是没有前置条件的，但是由于其要用到AID的功能，并且有一些预设的参数。所以在节点和AP关联的时候，就需要通过管理帧中的Element进行一些预先的协商。

在802.11ah的管理帧中，新加了一个Element为233，该Element就是用来预设Header Compression的，也就是PV1的前置条件。

![img](https://pic4.zhimg.com/80/v2-fb6b15e8605c005441b6d6780f32e6f3_720w.png)

该Element的内容如下

![img](https://pic4.zhimg.com/80/v2-a039276e2a81d77725ad18214850560b_720w.jpg)

其中Header Compression Control还可以进一步打开如下

![img](https://pic4.zhimg.com/80/v2-ce63908c9f0324eea4a996e6831693e3_720w.jpg)

由于内容太过细节，这里就不展开了，笔者也是作为一种笔记放在这里，怕自己忘了。

## 802.11ah PV1的性能

前面论述了很多都是关于MAC帧头部的优化，其实说到头说到尾，其实没有优化几个字段，那么到底有没有性能提高呢？

这里我们就需要注意下802.11ah的应用场景了。我们说IoT的场景一般都是小包场景，所以我们就假设数据包大小为100 Bytes。

- 传统的802.11 MAC Header，那么对应数据是100 Bytes，MAC Header是24 Bytes（参考在802.11ah PV1的MAC Header中显示的标准MAC Header，其中A3和A4=0），在这种情况下，MAC Header所占比例为24 Bytes/124 Bytes = 19.35%。

那么在802.11ah的最短的情况下，那么我们最短的MAC Header如下图（参考IEEE 802.11-12/01122r0）

![img](https://pic1.zhimg.com/80/v2-896030026f49ba9d2de8fd8084598118_720w.jpg)

进一步我们认为A3=0，那么MAC Header的大小等于2+2+6+2=12 Bytes.

- 所以对应802.11ah PV1 MAC Header，数据为100 Bytes的时候，MAC Header为12 Bytes，那么PV1 MAC Header所占比例为12 Bytes/112 Bytes = 10.71%。

对比一下，这里大约有19.35%-10.71%=8.64%的相对增益，所以说PV1 MAC header压缩还是有一定用处的。

# Short Beacon

## 序言

前一节我们讨论的802.11ah中的MAC头部压缩，本节我们讨论802.11ah中的Short Beacon。其实这几个设计都是围绕着压缩帧大小这个话题展开的，目的明确。理解这几个设计可以加深对于802.11相关字段的理解。

## Short Beacon的意义

为什么要特意压缩Beacon大小呢？主要有两点原因：

- 1）Beacon是周期性发送的帧，按照802.11协议设计，每间隔TBTT时间，AP就需要发送一个Beacon帧。
- 2）Beacon是一个广播帧，该帧的发送默认都是按照最低支持速率发送，从而造成Beacon帧的发送会耗费较多的空口时间。

Beacon实际上是在802.11协议工作过程中，占据了不少空口资源。因此，将beacon大小压缩的话，能够节约不少的空口资源时间，提高网络运行效率。

***Remark：这里有一点需要注意的是，在802.11ah中并不是所有的Beacon都是用Short Beacon模式发送的，有一部分时间也需要发送传统长度的Beacon。只不过Short Beacon占所有Beacon中的比例较高，而传统长度的Beacon所占比例较少。\***

## **802.11 Beacon简述**

我们首先看下标准的802.11 Beacon的结构，如下图所示

![img](https://pic3.zhimg.com/80/v2-aaf9a2f679431c450fb22765b43b9b62_720w.jpg)

标准的Beacon属于管理帧，该帧主要有三个部分：

- MAC Header：在标准的802.11中，Beacon的MAC Header是通用的MAC Header。所以基本没有什么额外要讨论的内容。不过有一点需要注意的是，Beacon的MAC Header里面既有DA也有SA，而我们对比下802.11ah Beacon的MAC Header的话，只有SA而没有DA地址。标准的802.11中有DA的主要原因是协议还有一种工作模式叫做IBSS，也就是ad-hoc自组网的工作模式。这个模式虽然现在已经不怎么用了，但是早期协议设计中，这个场景是重点考虑的。在IBSS场景中，Beacon也会在多个IBSS节点间互相对发，用这个做同步。这种场景下就有DA了。

Beacon在MAC Header以外都是按照Element形式构造的，在Beacon中还包含了两种，一共是必有的，一种是可选的。

- Manatory Element Fields：必有的Element包含了4个元素，时间戳，Beacon间隔（即TBTT时间），Capability Info还有SSID。其中时间戳是用于时间同步的，Beacon间隔是用来说明Beacon发送间隙的，其余两个是信息，用于发布给节点获知的。在权威指南里面，这4个元素都是必有的，但是在wireshark解析里面，只有时间戳和beacon间隔解析成必有，其他都是可选的。
- Optional Element Fields：还有一些其他的Element就是可选的Element了，比如TIM，国家码，TPC功率控制，加密设置有关的RSN之类的，这里就不展开了。

那么标准的802.11 Beacon大小为 24B（MAC Header）+8B（Timestamp）+2B（Beacon Interval）+2B（Capability Info）+32B（SSID）+ 4B（FCS）= 72B，这里SSID的大小是动态的，协议中的范围是0~32B。

## 802.11ah Short Beacon

下面我们看下802.11ah的Beacon，即S1G Beacon。

![img](https://pic2.zhimg.com/80/v2-85bb5d8a061a4da4fd74f16bba94bd99_720w.jpg)

从整体结构而言，802.11ah的Beacon和传统的Beacon基本是一样的，基本元素都在，只是内容压缩了一些。首先是DA删掉了，这点前面说过了。时间戳由8B降到了4B，Change Sequence是802.11ah独有的。

然后原有的固有字段Beacon Interval（即上图中的Next TBTT），SSID（即图中的Compressed SSID）都变成可选字段了，而且Compressed SSID的大小限制为了4B，降低了大小。这里由于修改了一些固有字段，结合上一篇文章中所述的Frame Control的功能含义，所以相比于标准的802.11，802.11ah Beacon中的Frame Control也是有特殊性的，如下图所示

![img](https://pic2.zhimg.com/80/v2-8a1d7af87338c8ccc034e0916f15952d_720w.png)

其中关于Next TBTT字段是否显示，Compressed SSID是否显示，都在Frame Control中有所体现。其余的字段由于都与其具体应用有关，所以这里就不展开了。

所以在802.11ah中，一个S1G Beacon的最小大小为2B（Frame Control）+2B（Duration）+6B（SA）+4B（Timestamp）+1B（Change Sequence）+4（FCS）= 19B。对比下标准的802.11 Beacon的最小大小72B，802.11ah的Beacon大小还是减少很多的。

# NDP控制帧（NDP CMAC Frame）

## 序言

终于到了802.11ah MAC优化的第一节，帧长度压缩的最后一个部分，NDP控制帧的优化。其实802.11ah的帧长度优化思路是挺明确的，一开始讨论的是S1G MAC Header的压缩，这个是通用的，而且也能用到数据帧上，然后就是Short Beacon，实际上是对应的管理帧。我们知道802.11协议中还有一种类型的帧，为控制帧，比如RTS,CTS,ACK之类的都属于控制帧，这一类如何优化呢，就是本文所讨论的NDP控制帧（NDP CMAC Frame）环节了，这里NDP CMAC的全称为Null Data Packet (NDP) Carrying Medium Access Control information (CMAC)。802.11ah的NDP CMAC Frame优化的基本思想，就是把MAC Header整个省掉，把相关信息全部压到物理层头部中，从而就实现帧体压缩了。

## 为什么要优化ACK

802.11协议中的ACK其实是传输过程中一笔不小的开销，在802.11n时代下，如果单纯只跑普通的ACK，那么ACK过程大概要占整个传输过程的30%左右。以一次ACK的开销时间为例子，其为SIFS+ACK的传输时间。ACK的传输速率并不能采用最高速率，按照协议规定，ACK这样的控制帧，其采用的速率最高可以到协议中规定的必选速率，但是无法上升到更高的可选速率。以802.11g时代为例，最高可选速率是54M，但是印象里面最高必选速率是24M。而且通常情况下，为了提高接收的准确性，以及还有因为数据帧中有预设Duration的原因，ACK通常是以最低速率反馈的。综上，如果每一个数据帧都需要反馈ACK，那么这笔开销还可以了。

**标准的802.11协议的优化策略是Block ACK**：所以为了节约ACK的时间，标准的802.11系列协议是采用了Block ACK的方式，该方式一方面是针对新型的MAC接入方案（比如TXOP，帧聚合）之类顺应提出的。另外一方面，采用Block ACK减少ACK的次数。而且由于标准的Wi-Fi是数据相对饱和的场景，即每一个节点其实都有不少数据待发，所以本身场景是倾向于ACK本身就比较多的，所以合并ACK就必然是一个可行的思路。不过Block ACK本身机制而言，并不简单，这里其实引入了类似会话机制了，而且Block ACK的重传也有一些具体设计，这里我们并不展开了。

**802.11ah的优化策略是CMAC NDP Frame：**802.11ah的场景和普通的802.11有点区别，因为要覆盖大节点这样的场景，而且基本模式下，由于带宽受限，其传输速率也没那么高，每一个节点能够分配到的传输时间实际上是比较少的，对应到其ACK反馈也就比较少了。因此，合并ACK这条思路在802.11ah中并不是最可行的，所以解决思路就是直接下手优化控制帧了。这里我们主要以ACK控制帧为例给一个控制帧为什么优化的说明，在802.11ah中，CMAC NDP Frame不是直接对标ACK的，而是所有的控制帧都可以按照这种方式优化，因此，CMAC NDP Frame的应用场景实际上是更灵活的，另外802.11ah里面也有block ack，而且也是一共CMAC NDP机制来做的。而且更扩展的说，除了控制帧能降到NDP里面，还有个别的管理帧也降到NDP里面了。

## Null Data Packet (NDP) 简述

NDP大致简述下，关于NDP的细节和标准用法可能要等以后整理协议精读到802.11ac的时候再谈这件事情了。NDP帧首次应该是在802.11n里面，在802.11ac时候用法比较典型。

关于802.11中的Null帧，在NDP以前还有一个地方出现过，就是在Polling机制（应用在节能模式或者PCF接入模式中）。那个时期定义的Null实际上是一种MAC Null帧。该帧包含了PHY Preamble，PHY Header，MAC Header，FCS，仅仅MAC层的Payload，即MSDU是等于0的。这种Null帧主要是在polling的时候，如果请求对象没有数据帧要反馈，那么就反馈个Null，也就是空，代表没东西反馈，如果有数据才反馈数据。

在802.11ac里面，典型的场景就是MU-MIMO对应的多节点信道测量过程，NDPA-NDP-Beamforming Feekback的过程。其中NDP的帧结构就是PHY Preamble+PHY Header，没有MAC帧的头部和MSDU，而且由于FCS也是MAC层的，所以也省了。NDP的主要过程是应用其中Preamble部分的LTF部分做信道CSI测量，节点需要获知该信息用于构造预编码矩阵，以实现物理层的MIMO或者MU-MIMO。不过在802.11ac中，NDP基本就是一个测量性质的帧，并没有体现出其他的功能。

## 802.11ah中的NDP Frame

NDP帧就是仅仅只有物理层Preamble和PHY header的帧。如下图所示

![img](https://pic1.zhimg.com/80/v2-b6a9cfbd883bf21be3c128f58d504c74_720w.jpg)

其中STF和LTF可以理解成Preamble部分（这点其实可以这样理解，但是其实和协议定义有点对不上，这里有点历史遗留的定义问题），然后是PHY Header，也就是对应的SIG字段，SIG是用来存储对应MSDU部分如何解调的物理层信息的。在802.11ah中，并不是所有的NDP都是作为CMAC用的，在前面一开始的两篇文章里面说了，802.11ah是基于802.11ac的技术基础，是基于多天线的传输技术的，所以既然有了多天线就需要做NDP测量，所以在802.11ah中也会存在传统的NDP帧。所以先总结下，802.11ah中一共有两种NDP帧：

- **一种是用来做信道测量的普通NDP帧，这种NDP帧在协议上称为S1G NDP Sounding。**
- **还有一种就是用来控制的特殊NDP CMAC Frame。**

普通的NDP其实和标准的802.11差不多，本文就不关注了，下面我们关注NDP CMAC Frame。

## 802.11ah中的NDP CMAC Frame

首先我们给出NDP CMAC Frame的示例，左边的是1Mbps时候的CMAC NDP，右边是2Mbps时候的CMAC NDP。结构上都一样的，在802.11ah中，SIG的长度还与速率模式有关，1M模式下是36B，2M以上的模式下是48B。

![img](https://pic2.zhimg.com/80/v2-552a831ae1618e43cf378ace98314331_720w.jpg)

那么下面要关注的问题就是，如何识别这个NDP帧到底是普通NDP还是NDP CMAC。

![img](https://pic2.zhimg.com/80/v2-3d8b1365f219a26f771a61fb8c5ff1ed_720w.jpg)

参考上图的1M模式，主要参考其SIG的第25B位置上，NDP Indication字段，

- NDP Indication=0，那么就是S1G NDP Sounding。
- NDP Indication=1，那么就是NDP CMAC Frame。

在确认该NDP帧是NDP CMAC Frame后，还需要进一步确定这是哪一种控制帧。在NDP CMAC Frame中，SIG中可以嵌入多种802.11ah的帧信息，主要控制帧，另外还有一个特殊的管理帧，如下图所示：

![img](https://pic1.zhimg.com/80/v2-c89cf13d9a876b4829686604d9c1d77c_720w.jpg)

那么如何确定这是哪一种控制帧呢，我们主要关注SIG中的NDP CMAC frame body字段

![img](https://pic3.zhimg.com/80/v2-65ea6461f797dd380e4e696c383dd066_720w.jpg)

以ACK模式的NDP CMAC Frame打开为例，其首先开始的3个Bits，用来体现该NDP CMAC的类型，不过后面的剩余字段，其实并不是固定的。这个和前面在MAC Header压缩里面说过的一样，是多重Flag解析的方式，其Type后面的字段是根据Type字段本身来解析的。

![img](https://pic3.zhimg.com/80/v2-75e59889a00387f50d2a64fb6606494e_720w.jpg)

使用以上的设计机制，802.11ah就可以把原来多种的控制帧，将其信息都对应压入到NDP帧中，从而减少了帧长度，优化传输效率。

# TXOP Sharing in Relay

## 序言

在802.11ah的TXOP部分改良中，有两个具体改良技术，一个是用于一对收发节点传输中的Bi-directional TXOP，一个是用在relay场景下的TXOP Sharing。TXOP技术我们在《[802.11协议精读26：802.11e（TXOP，Block_ACK）](https://zhuanlan.zhihu.com/p/31710770)》，已经论述过了。由于Bi-directional TXOP是针对802.1n中的Reverse Direction protocol (RD)的二次改良，所以如果讲Bi-directional TXOP就需要先讲Reverse Direction protocol (RD)。因此我们先略过Bi-directional TXOP，本文先挑简单的TXOP Sharing技术来说，而且TXOP Sharing也因为是应用在relay场景下，也相当于802.11ah的独有场景设计吧。

## 802.11ah中的Relay场景

要理解TXOP Sharing就需要理解好802.11ah的场景，在《[802.11ah（HaLow）协议解析2：协议设计目标](https://zhuanlan.zhihu.com/p/338864220)》里面，我们给出了几个802.11ah的use case。并且特别需要注意的是，我们强调802.11ah的AP一个的覆盖范围是1km，这个是基于本身设计的PAR指标进行设置的。

那么是否意味着802.11ah只能覆盖1km距离呢？其实不然，虽然单个是覆盖的1km距离，但是802.11ah是本身就设想基于relay场景设计的，所以其可以通过多级中继的方式扩展传输距离。802.11ah的中继和802.11s的mesh有点区别，这里核心要注意，中继和mesh场景是有区别的（另外，家用产品的“mesh”和802.11s的mesh也有区别，这个更偏重于relay，但是协议更偏向于wfa的easymesh，细节这里就不展开了）。在802.11协议的初始设想中，mesh的使用场景是节点以mesh网络连接的方式，提供多个链路接入接口。比如说STA可以通过mesh发现周边多个连接接口（从属于一个无线网络），STA可以选择一个进行接入，这样提供了冗余性。mesh的核心是为了避免只有一个网络接口造成网络阻断的情况，所以才叫mesh，即全互联的网络结构（这里就和有线下全互联的场景意义很近似了，有线下面全互联也是有提供冗余的功能）。所以要注意，802.11ah这里是一种中继功能的改进，与802.11s还是有所区别的。

![img](https://pic1.zhimg.com/80/v2-8a84636c8f215e393f553113afebcd10_720w.jpg)

802.11ah的中继结构如上图所示，根节点在Root AP上，然后是一级中继relay 1和relay 2，然而是二级中继，relay 3之类。注意这个是一个树形结构，和easy mesh类似。采用树形结构可以最简单的避免环路。

看到树这里就有需要有一些网络知识的条件反射了。这个树是怎么形成的？**802.11ah中的树并不是所有中继节点等价意义上的树，而是级联意义上的树。**在**有线网络**中，当多个交换机构造生成树的时候，需要注意，其实**每一个交换机是没有从属关系的**，所以其是在平等的环境下，通过BDPU比大小，从而生成了整棵树。在无线环境下，NAN以及AWDL之类的上层协议也是采用类似的机制。**在802.11ah中，这里是存在从属关系的**。即Relay 1实际上是作为一种STA挂在Root AP上的，Relay 3也是类似这样挂在Relay 1上，这里挂在某个AP上实际上指的是关联关系，即Relay 1是和Root AP进行关联。所以在802.11ah中，没有直接类似于比大小选根之类的树生成算法。

## TXOP Sharing

下面我们在理解Relay场景的基础上，理解TXOP Sharing。在802.11ah的Relay场景优化中，核心的目的是希望将节点的数据最快的汇总到中心节点（即Root AP）。以上一节Relay场景的图为例，希望将STA3的数据最快速的反馈到Root AP。但是，我们知道802.11无线网络是一个基于竞争的传输过程，这里由于存在多级Relay，按照传统标准，每一级就需要单独做一次竞争，这会大大提升传输开销，而且不利于效率。

![img](https://pic4.zhimg.com/80/v2-559f88e1e88c443718ec2d35504f3f27_720w.jpg)

以上图为例，传统的是STA竞争到信道以后发送数据，然后Relay ACK，然后Relay再竞争，然后再Relay DATA给AP，最后AP反馈ACK。中间多了一个Extra access delay，即重复竞争的过程。因此，解决这个问题的基本思路就是希望减少这样的竞争开销，好比开车遇到红绿灯一样，希望一次性把通路上的几个绿灯一次性点亮，这样速率就能块点了。

![img](https://pic4.zhimg.com/80/v2-e9727476e188e1104cba8e6f0a787733_720w.jpg)

那么在802.11ah中，允许网络以TXOP分享的方式来减少这段ACK时间。一开始节点通过竞争，并和Relay握手的方式获得了一段TXOP时间。然后当节点发送完Data，Relay反馈ACK给station之后，Relay获取TXOP的使用权，在SIFS后立刻回传Data给AP，避免了二次竞争过程。当AP接收到该Data后，再次反馈ACK以完成这次的中继传输。通过这种方式就可以很简单的避免relay场景下的重复竞争了。另外，我们知道802.11系列协议中还有一个显著的特点，就是帧功能的复用。上图实际上是TXOP Sharing中显式ACK的工作方式，关于ACK和其对应的SIFS可以进一步缩减。

![img](https://pic4.zhimg.com/80/v2-c92c533d3a61d6d4ccec71bdc136747b_720w.jpg)

如上图所示，当Relay接收到Station的Data之后，其直接发送Data给AP，而不用给Station显式的反馈ACK。这种用法最初是在PCF的组合帧里面出现的（参考《[802.11协议精读4：PCF工作模式](https://zhuanlan.zhihu.com/p/20750579)》），比如CF_ACK + CF_Poll帧，注意这个是一个帧，但是同时执行两个功能。这里也是类似的。在802.11ah中，如上图所示，其实ACK不会没有发，而是隐式的包含在Relay传输的Data中了，Station通过接收Relay的Data确定该帧是否已经成功传输给Relay，从而就不需要显示的ACK了。

