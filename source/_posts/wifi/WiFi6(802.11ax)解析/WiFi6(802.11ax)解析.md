---
title: WiFi6(802.11ax)解析
date: 2021-03-08 10:00:00
swiper: false
swiperImg: '/medias/wifi6.jpg'
#img: '/medias/wifi6.jpg'
top: true
tags: WLAN
categories: wifi6
---
# 协议简介

## 序言

本文摘自[徐方鑫](https://zhuanlan.zhihu.com/p/24290258)

## 802.11ax简介

802.11ax是在802.11ac以后，无线局域网协议本身的进一步扩展，可以当做ac以后的一个直系版本。其初始的命名代号为HEW（High Efficiency WLAN ），该起始于2013年。目前在今年（2016）11月份，该协议应该已经推出了Draft 1.0。

802.11ax的使用场景关注于密集用户环境（Dense User Environments），与之前的协议有所不同。根据香农定理![香农定理](https://www.zhihu.com/equation?tex=C%3DBlog_%7B2%7D+%5Cleft%28+1%2BSNR+%5Cright%29+)而言，当SNR不变的情况下（由于发送机总功率是固定的），只要适当的增加带宽，就可以获得更高的物理层吞吐量。所以802.11a/b/g/n/ac的演进，一般都是关注在单AP的网络中，提高物理层的吞吐量，以提高网络的整体速率。

802.11ax的设计场景初始关注的就是密集环境，换言之，其初始设计思想就会和传统的802.11存在一定的区别。而且802.11ax的设计也并没有在当前802.11ac的160M带宽以上，新增更大的带宽（其实也是在2.4G和5G频谱资源下，无法找到更大带宽的信道）。所以协议命名的HEW，其关注的效率，也是希望更加有效的使用当前的频段资源，从而提供更高的实际网络速率。我们可以简单总结802.11ax的以下特点：

- **协议兼容性**：802.11ax要求与以往的802.11a/b/h/n/ac都进行兼容，这也证明了其是第二款同时能工作在2.4G和5G频段下的协议（802.11ac仅工作在5G频段）。故在其数据帧结构和MAC接入协议上，都需要兼容设计，以便于传统协议兼容。

- **更好的节能性，**用以增加移动设备的续航能力**。**

- **更高的传输速率以及覆盖范围**：在802.11ax中，更高的速率分别体现在PHY层和MAC层的改进上，其具体改进包含如下：

- - **提供更高阶的编码组合**（MCS10和MCS11）。其中主要是QAM-1024的引入，在802.11ac中，最高阶是256QAM。

![QAM-1024](WiFi6(802.11ax)解析/v2-23e7a0aea03ab5cf9979acfe80272789_720w.png)

- - **在相同带宽下，802.11ax采用点数更多的FFT**（即原始的FFT的4倍大小）。FFT点数越多，说明其子载波数越多，以及子载波的带宽也就越小（带宽从312.5kHz降到78.125kHz。其对应的symbol时间也增加了4倍），从而可以覆盖更远的范围。（覆盖范围与相干带宽有关。只要信道的带宽小于相干带宽的话，那么就是平坦衰落，信号不会受到多径的影响。所以越小的信道带宽，可以覆盖更远的范围）

![fft](WiFi6(802.11ax)解析/v2-693acb951a420a431164d2b9eac7c78b_720w.png)

- - **引入上行MU-MIMO**。在802.11ac中，协议只规定了下行的MU-MIMO。上行还是单个节点独立传输的，而在802.11ax中，上下行都需要支持MU-MIMO。

![MU-MIMO](WiFi6(802.11ax)解析/v2-c38c6eac16d6a23c4deeacdbbb34808c_720w.png)

- - **引入OFDMA技术**。802.11ax设计中参考了LTE中OFDMA的使用，可以让多个用户通过不同子载波资源同时接入信道，提高信道的利用率。不过因为802.11是一个分布式接入的场景，所以802.11ax中的OFDMA实际是比LTE中复杂度要低一些。

![OFDMA](WiFi6(802.11ax)解析/v2-8a40e3e461980dd315b5d08ce8d88894_720w.png)

至于其中一些具体的介绍和一些其他的特性，建议参考NI的文章：[Introduction to 802.11ax High-Efficiency Wireless](https://link.zhihu.com/?target=http%3A//www.ni.com/white-paper/53150/en/)。在后续的分点介绍中，我们会慢慢进行阐述。

## **802.11ax协议资源**

以下总结下，笔者在追踪协议进展的时候，所收集的一些资源。

802.11ax的Task Group网站目前一共出了两个版本，分别代号为hew和tgax，前者已经没有继续更新了。该网站整理如下：

**HEW**：[http://grouper.ieee.org/groups/802/11/Reports/hew_update.htm](https://link.zhihu.com/?target=http%3A//grouper.ieee.org/groups/802/11/Reports/hew_update.htm)

**802.11ax**：[http://grouper.ieee.org/groups/802/11/Reports/tgax_update.htm](https://link.zhihu.com/?target=http%3A//grouper.ieee.org/groups/802/11/Reports/tgax_update.htm)

如果权限高可以下到最新的协议：[IEEE 802.11, The Working Group Setting the Standards for Wireless LANs](https://link.zhihu.com/?target=http%3A//www.ieee802.org/11/LetterBallots.shtml)

同时也有一些中文的机构在追踪有关协议的进展，比如：

**网络通信国际标准分析及参与制定计划网**（台湾）：[网络通信国际标准分析及参与制定计划网](https://link.zhihu.com/?target=http%3A//std-share.itri.org.tw/)

**中国通信标准化协会**（大陆）：[中国通信标准化协会](https://link.zhihu.com/?target=http%3A//www.ccsa.org.cn/)

目前协议应该在出到最新的Draft 1.0版本，不过还无法在其相关的网站上公开看到。目前可以看到的只有一个个讨论案，以及Draft 0.1和TGax Specification Framework，前者适合阅读一些，虽然有很多TBD的部分，不过相对于后者（其相当于一份份草案的罗列），还是好一些的。资源整理如下：

**Draft 0.1（IEEE 802.11-16/0024r1）**:[Draft 0.1](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9713814)

**TGax Specification Framework（IEEE 802.11-15/0132r15）**:[TGax Specification Framework](https://link.zhihu.com/?target=https%3A//mentor.ieee.org/802.11/dcn/15/11-15-0132-16-00ax-spec-framework.docx)

其他还有一些商业网站的资料，其中我目前看到的还是属于NI那一份资料比较好（算是很接近Draft 0.1的了），其他有一些太偏重于概念，而非技术本身，所以就暂时先不罗列了。

# OFDMA资源块 - RU

## **序言**

在802.11ax协议中，由于引入了OFDMA技术，所以我们需要定义时频资源块的概念，这些时频资源块都是彼此正交的。802.11ax中的OFDMA实际上是借鉴LTE的，但是没有LTE资源块那么复杂（比如RE，RB，CP，REG，CCE这些），802.11ax中仅仅有RU（Resource unit）的概念，故本节我们主要叙述802.11中子载波分配，以及RU的设置。本节我们讨论内容主要参考Draft 0.1中的相应描述，以及部分提案中的内容。

*注：由于协议正在制定的过程中，所以会存在TBD（To Be Determined）的部分以及不断更新的协议内容，笔者未必跟上最新的协议进程，如果有错漏的地方，还请见谅。*

## **OFDMA简介**

![OFDMA](WiFi6(802.11ax)解析/v2-87a082c97fe8b36c6bd5332b36366737_720w.png)

我们以上图为例，左图是OFDM的工作模式，右图是OFDMA的工作模式。图中一共有4个节点，分别以4种颜色进行标识。图中横轴为时域，纵轴为频域（即对应不同的子载波）。

- **OFDM工作模式**（左图）：用户是通过不同时间区分出来的。每一个时间片段，一个用户完整占据全部的子载波，并且发送一个完整的数据包（如图中红色部分标出的WLAN Packet）。
- **OFDMA工作模式**（右图）：用户是根据时频资源块RU区分出来的。我们首先将整个信道的资源分成一个个小的固定大小的时频资源块，这个时频资源块也就是RU（Resource unit）。在该模式下，用户的数据是承载在每一个RU上的，故从总的时频资源上来看，每一个时间片上，有可能有多个用户同时发送。

OFDMA相比OFDM一般有两点好处：

- **资源的更细腻分配**。特别是在部分节点信道状态不太好的情况下，可以根据注水定理的思想（即根据信道质量分配发送功率），来更细腻化的分配信道时频资源
- **能够更好的提供QOS**。因为初始的802.11是占据整个信道的，如果有一个QOS数据包需要发送，其一定要等之前的发送者释放完整个信道才行，所以会存在较长的延迟。在OFDMA的情况下，由于一个发送者只占据部分信道，所以能够减少QOS节点接入的延迟。

## **RU（Resource unit）**

本节参考Draft 0.1中第26.3.7节（OFDMA and SU tone allocation）中的相关叙述。

在802.11ax中，一个最小的时频单位为RU。与LTE中的RE（Resource Element）和RB（Resource Block）不同，LTE中的RE和RB都是一个固定值，我们列举如下

- RE：时域上对应1个symbol，频域上对应1个sub-carrier。
- RB：对应时域上1个slot内（即半个子帧长度0.5ms）中，频率上对应12个sub-carrier，一般是7*12个RE。,

在802.11ax中RU是一个相对的概念，即存在很多种不同大小的RU，如下图所示：

![img](https://pic4.zhimg.com/80/v2-8875388aa04911ced8560da79e776a57_720w.png)

图中，一共定义了6中RU类型，分别是26，52，106，242，484以及996个子载波。

*注：笔者目前尚未确定是否存在不同类似RU共存的情况，比如在20M带宽情况下，2个52-subcarrier RU和1个106-subcarrier RU是否可以共存，这点有待后续理解。笔者比较倾向理解，不同的RU是可以共存的。这样设计的好处在于可以更有效的分配频率资源，比如在20M的信道条件下，一共可以存在9个26-subcarrier的RU，故需要9个人竞争才可以占据全部信道，否则就会有资源浪费（在802.11ax中，目前笔者理解每一个发送者每次只能够竞争一个信道）。所以在发送者数量不足的情况下，只有通过不均等的分配，才可以更加有效的利用信道资源。*

由于我们在802.11ax简介中也提到了，在该协议中，相同的信道带宽采用的FFT的点数增加4倍。比如原来20M信道采用64点的FFT（即64个子载波），现在就变成了256点的FFT（即256个子载波）。参考上图中（CWB20，26-subcarrier RU）的RU的数量，我们计算26*9=234是小于总子载波数256的，所以图中数值是合理的。

## **DC，Null Sub-carriers and Guard Sub-carriers**

在前面RU的计算结果中，20M信道一共应该有256个子载波，而实际RU总共只使用了234个，两者相差了22个子载波。这些子载波是用来做保护间隔的：包含了DC，Null Sub-carriers以及Guard Sub-carriers，如下图：

![img](https://pic4.zhimg.com/80/v2-e01899eb5e7f38cd253793c4e2b82963_720w.png)

图中分别列举了RU为26,52,106个子载波的情况，我们具体解释如下：

**DC保护**：以中心子载波为核心，一共有7个子载波作为DC保护的，即DC的保护带宽一共是7*78.125kHz=546.875kHz，与原来的一个DC保护（即312.5kHz）是比较接近的。

**Guard Sub-carriers**：保护子载波这里指的是信道之间的保护子载波了（比如20MHz信道之间的保护），如上图所示，其选取了左边的6个子载波以及右边的5个子载波作为保护，这点设计是和802.11a的载波设计是一样的，只是子载波的带宽不一样而已。

**Null Sub-carriers**：在一些早期的书里面，比如《MIMO-OFDM Wireless Communications with MATLAB》，其中是将Guard Sub-carriers和Null Sub-carriers等价看待的。不过在802.11ax中，Null子载波是指的RU之间的保护间隔，一般是1个子载波。

下面这张彩图可能更清晰一些：

![img](https://pic2.zhimg.com/80/v2-b954e40221673d43b26dbde3c69958c1_720w.png)

那么这里一共损耗了6+1+1+7+1+1+5=22个子载波，是和之前计算相等的。

## **Pilot Sub-carriers**

最后我们介绍一下在802.11ax中，导频子载波（Pilot）的设计。导频子载波是用来做信道估计的，利用估计出的信道系数完成解调的工作。由于802.11ax还是一个分布式接入的工作，所以Pilot是包含在每一个RU内部的。这点也是与LTE的不同，LTE中，下行一般是用CRS（Cell-specific Reference Signals）信道，即特殊的导频图案（即时频图案）做参考信号，上行是在时隙内（即时域上这个时间片资源）上放置DMRS（Demodulation Reference Signal）用作解调参考信号的。

在802.11中，始终是用特定的子载波作为导频子载波，从而完成信道估计的功能，在802.11ax中，导频子载波的分配如下：

![img](https://pic2.zhimg.com/80/v2-57e6b71de33ab680e7c40b4438b7e0f1_720w.png)

其中红色的直线即代表导频子载波的位置，其导频资源是均匀分布在整个信道上的。比如在RU为26个子载波的情况下，每一个RU中都包含了2个pilot，在RU为52个子载波的情况下，每一个RU包含4个pilot。通过这些pilot的设置，在传输过程中，接收方才可以有效地估计信道，并完成解调的工作。

# 上行随机接入（TF，TF-R）

## **序言**

在802.11ax以前，MAC的接入机制是典型的CSMA机制（即DCF中所采用的CSMA/CA）。在引入了OFDMA的需求之后，802.11ax的MAC层随机接入机制也发生了变化，在协议中，代替传统的CSMA思想，802.11ax采用了基于ALOHA思想设计了竞争协议。本节我们主要就是介绍802.11ax中所采用的TF（Trigger
Frame）以及TF-R（Trigger Frame for Random access）机制。

本节我们讨论内容主要参考Draft 0.1中的相应描述，以及如下提案（按照时间顺序）：

- **IEEE 802.11-15/0365r0**：UL MU Procedure
- **IEEE 802.11-15/0880r2**：Scheduled Trigger frames
- I**EEE 802.11-15/0875r1**：Random Access with Trigger Frames using OFDMA
- **IEEE 802.11-15/1137**：Triggered OFDMA Random Access Observations
- **IEEE 802.11-15/1105r0**：UL OFDMA-based Random Access Procedure
- **IEEE 802.11-15/1047r0**：Random RU selection process upon TF-R reception
- **IEEE 802.11-15/1370r0**：UL OFDMA Random Access Control
- **IEEE 802.11-16/0582r3**：Random Access RU Allocation in the Trigger Frame

以上的草案资源整理如下，【[TF与TF-R相关草案](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9714498)】。

*注1 ：由于协议正在制定的过程中，所以会存在TBD（To Be Determined）的部分以及不断更新的协议内容，笔者未必跟上最新的协议进程，如果有错漏的地方，还请见谅。*

*注2 ：本文是在协议指定过程中写的，目前参考协议最新的4.3Draft，其部分信息已经整理至后面的UL-OFDMA和DL-OFDMA的相关文章中，本文的内容需要结合后续的文章综合进行理解。*

## **TF（Trigger Frame）接入机制**

802.11ax与传统的DCF所需求的MAC层机制是不同的。传统的DCF同一个时刻只有一个用户接入信道，而由于802.11ax采用OFDMA技术，其需求多个用户可以同一时间接入信道（选择的RU是正交的）。

本节我们所介绍的TF机制，主要是用在UL MU （Uplink Multi-users）这种上行传输的场景下的。TF机制是一个上行传输的框架，其具体的随机接入的方法是TF-R机制。参考draft 0.1中，第10.3.2.11.4节部分，以及草案（IEEE 802.11-15/0365r0），我们描述协议中TF接入机制。

*注：如果研读过协议草案的可以发现，802.11协议指定是一个非常严谨的过程，其属于一个个小草案慢慢叠加，一步一步往上设定的过程，比如在IEEE 802.11-15/0365r0草案中，仅仅是一个很简单的TF的机制，并没有设置一些具体内容。在TF机制基本思想通过以后，协议会在其上进一步设计，最终不断修改才获得了最终的802.11协议版本。*

![TF机制](WiFi6(802.11ax)解析/v2-36dd8f6976d4c1dbc024e4af7a6a4ad9_720w.png)

**TF是一种上行接入的传输框架，其定义了一个很简单的过程：**

- **AP发送Trigger frame，宣称这一轮接入开始。Trigger frame中，包含了节点上传所使用的时频资源（RU）信息。**
- **根据Trigger frame中的指示，节点选择其对应的RU位置，进行OFDMA的接入。多个节点同时向AP发送上行PPDU。**
- **AP接收完全部数据后，反馈ACK，结束这一轮传输。**

在草案（IEEE 802.11-15/1105r0）中，TF帧不仅仅指定了什么节点发，还指定了节点的发送一系列参数，如下图：

![TF帧](WiFi6(802.11ax)解析/v2-40798acd9390959006eb515d18831499_720w.png)

其中第一列是该RU被分配给那个用户（具体是指定用户的AID），如果AID设置为RA（协议中RA的AID号还没给定，即TBD），那么该RU就是供节点竞争的。后面的几列包含了比如Coding Type以及MCS值，这一块细节较多，所以我们就不展开了。

以上就是一个TF的接入框架，笔者总结其与传统的802.11相比有以下不同：

- **单节点接入和多节点接入：**传统的802.11中，都是单个节点占据整个信道的。在TF中，多个节点基于OFDMA，同时接入信道。
- **发起者不同**：在传统的802.11中，节点只要竞争到信道，就可以立刻发起传输。而在TF中，只有当AP发送了TF帧之后，节点才可以发起上行接入竞争。
- **ACK反馈时机不同**：在传统802.11中，ACK是在发送完之后，立刻被反馈的。而在TF中，ACK实际上是等所有用户都传输完之后，再一次反馈给所有接受者的。由于每一个发送者可能发送的数据包长短不一，所以先发送完的，需要等待后发送完的。这一点实际上也是多用户接入协议一个设计的公共问题。
- **使用场景不同**：基于以上的几点不同，我们还可以理解，TF机制本身就是在假定网络是工作在基础架构的情况下，进行的设计，其不好在IBSS网络情况下工作。而传统802.11中的DCF设计，是即可以在基础架构模式下，也可以在IBSS模式下工作的。

*注：802.11ax中不是完全把DCF删除，而是分时采用不同的模式。TF机制主要是用在上行接入这一部分的，有关我们这一节不进行展开。*

## **TF-R（Trigger Frame for Random access）**

TF-R是基于TF的进一步扩展，是在TF机制中，引入了竞争的机制，其基本思想是Slot-Aloha。参考draft 0.1中，第25.5.2.6.1节部分，以及草案（IEEE 802.11-15/1105r0），我们描述协议中TF-R接入机制。

![TF-R接入机制](WiFi6(802.11ax)解析/v2-c5996e9a2c4a167b20f559a9e1483238_720w.png)

初看上图是比较复杂的，以下我们一步一步做解析。

TF-R是将原来时域竞争转为频率竞争（如左边红色竖线上所示）。

TF-R是在我们前面所述的TF过程之前执行的，在每一次接入时，AP首先发送TF-R帧，在该帧中的部分RU其相应AID=X，这个X代表这个RU是供节点竞争接入的。节点在识别到TF-R帧之后，具体是采用OBO（UL-OFDMA Backoff）的机制竞争（我们所述TF-R的接入思想是基于Aloha而不是CSMA的主要原因也在这里）。

**Aloha和CSMA的核心区别在于LBT（Listen Before Talk）机制上：Aloha是没有LBT的，而CSMA是基于LBT的。**

在OBO中，每一个节点首先从CWO（Contention Window for UL-OFDMA）窗口中，选择一个随机数并放入Backoff counter中。如上图，STA1选择的是10，STA2选择的是4，STA3选择的是0。然后节点比较，这一轮TF-R帧中，可供竞争的RU slot的数目，比如上图RU数目为3。若Backoff counter小于RU的总数（比如STA3选择为0，其小于3），那么节点就可以发送数据，反之不行。那么该节点就随机选择一个RU（比如上图，从3个中随机选择1个，即RU=3），然后在该RU上进行数据传输。

当RU=3被竞争之后，开始下一个的TF-R。此时节点首先要进行Backoff过程，即本地的Backoff counter要减去上一轮总的竞争RU数目（比如STA2选择为4，那么要减去3，即将Backoff counter设置为1）。若新的一轮中节点的Backoff counter小于这一轮的可供竞争的RU数目（比如STA2现在Backoff counter为1，RU数目为2），那么该节点竞争胜利，可以任意选择一个RU（比如选择RU=1）。只有当TF帧中，有被用来Random Access的RU的时候（即TF-R帧），其才会触发OBO的过程，若该TF帧中没有这种RU，那么不会进行Backoff。

当RU资源被竞争好以后，AP发送TF帧，节点正式向AP反馈上行数据，其过程就和我们之前所述的TF过程一样了。

**注：Slot-Aloha的思想是用来判断节点在这个时刻可不可以发送（参考我这里所提过的[同步异步2：ALOHA中的同步异步](https://link.zhihu.com/?target=http%3A//blog.csdn.net/fzxy002763/article/details/50700095)），并没有包含在哪个位置具体传输的机制。故OBO主要是用来判断，节点能不能发的，至于使用哪个信道具体发送，那么这里是随机的。这一块可能有性能评估的问题，不过目前协议是这样设定的。**

# 802.11ax与HiperLan

## **序言**

在早期wi-fi发展过程中，欧洲还出现过一个同期的无线局域网协议，HiperLan 。所谓网络发展始终是“分久必合，合久必分”，无论是有线网络当前SDN的引入，还是无线网络下802.11ax协议的制定，当前都有加重中心控制的一种趋势。故本文我们重新介绍下HiperLan，并简单对比下其与当前802.11ax的设计理念。

*PS：802.11ax的设计中可能与HiperLAN的设计思想没有直接的关系，本文仅仅是笔者个人的一些理解，如有错误，还请见谅。*

## **HiperLan简介**

HyperLan全称为（HIgh PErformance Radio Local Area Network），其早期是欧洲ETSI所采用的无线局域网的通信协议。其一共有2个版本，分别为：HiperLan/1，HiperLan/2，另外还有两个引申的版本HiperLink，HiperAccess。HiperLan早期也被称为Wireless ATM网络，其具有ATM网络的一些特点，并能依靠当时的ATM网络作为承载网。

## **HiperLan分层框架**

HiperLan的分层框架较为802.11复杂一些，HiperLan/2的分层框架如下：

![img](https://pic4.zhimg.com/80/v2-630c1c12d86dfbf7cff52b60453f13b7_720w.png)

HiperLan初始设计就是考虑QOS的，故其分层结构类似于通信网。HiperLan/2除了PHY和MAC层以外，还有RLC和EC子层（注：HiperLan/1只有RLC子层），再往上还有收敛层CL。这也是和802.11的一个明显的不同，这个也是设计思想上的不同了：

**802.11的核心思想还是基于Best-effort**。Best-effort的定义包含两个部分（参考High-Performance Communication networks，高性能通信网络中的定义）：

- **IP的承载服务就是以数据报形式发送报文，报文的最大程度为![[公式]](https://www.zhihu.com/equation?tex=2%5E%7B16%7D)字节（64KB）。这种服务在差错，网络延迟或带宽方面不提供服务质量保证。这样的服务叫做尽力而为（Best-effort）服务，表示网络将尽量提供服务。（参考第103页，4.3.1节中的描述）**
- **IP承载服务在延迟，带宽和数据丢失方面不能提供任何保证，路由器按同一种方式处理所有的分组（这种“一视同仁”的处理方式也可以叫做尽力而为（Best-effort）服务）。这是一种很自然的特点：缺乏状态信息就意味着分组不能够被应用或链接所区别，这样路由器就不能提供额外的资源以满足应用需求。（参考第120页，4.5中的描述）**

故在802.11协议设计的DCF接入过程中，所有的帧都是按照一视同仁发送出去的，没有对数据帧做任何资源上优化。在HyperLan中，为了考虑QOS，除了在MAC层的设计上要引入竞争的优先级以外，还引入了RLC子层，从而对系统资源就可以实行优化了，这一块在LTE中也是同样的思路。

## **HiperLan MAC层架构**

在MAC层中，HiperLan还分成了逻辑信道和传输信道，每一个信道实际上可以理解成一个数据片或者一段物理层的资源，在HiperLan中，逻辑信道和传输信道的承载关系如下（参考：HiperLAN/2 – The Broadband Radio Transmission Technology Operating in the 5 GHz Frequency Band）

![img](https://pic4.zhimg.com/80/v2-01fcb957fa80b020a06baa070e17b103_720w.png)

这种模式是从通信网络设计引来的思想，LTE中也存在这样的承载关系。物理信道的思想就是特定时频片段上的数据片信息，然后将这个信息如何解析就是对应逻辑信道上的。在802.11中，不同类型的信息是通过不同类型的数据帧进行传输的，换言之，HiperLan这种是固定的传输片段进行重复，而802.11这种是出现了特殊的帧，比如数据帧之类的，才发送一下，这也是一种QOS的区别。

*PS：关于控制信道和传输信道的具体内容，可以参考《HiperLAN/2 – The Broadband Radio Transmission Technology Operating in the 5 GHz Frequency Band》一文，这里由于关注重点，所以不进行展开。*

讨论完其结构之后，我们要具体讨论下HiperLan的MAC层机制。HiperLan的MAC层是基于TDMA/TDD机制的，TDMA所述为其MAC层接入机制，TDD指的是其双工机制。从时域上，我们可以参考如下：

![img](https://pic1.zhimg.com/80/v2-d9dac99dcf15e0bbc6f09089c44e3b98_720w.png)

时域上整个传输过程是被等分成多个MAC-Frame，每一个MAC-Frame中包含了BCH，FCH，ACH等几个传输信道，所以这里的传输信道对应的就是这个时间片的传输内容。

- BCH（Broadcast channel）：下行信道，类似于Wi-Fi中的Beacon的功能，广播AP的一些信息，比如发送功率的设定，FCH和RCH对应的时长，节能模式下的唤醒标识（类似于802.11的TIM）。
- FCH（Fame control channel）：下行信道，宣告了当前MAC帧中资源分配，下行传输阶段，上行传输节点以及随机接入阶段的资源分配。
- ACH（Access feedback channel）：下行信道，承载了上一轮随机接入中的结果，并告知所有节点。在HyperLAN中，MT代表节点。
- DL Phase（Downlink phase）：下行传输阶段，由AP向节点进行传输。每一个节点的传输结构中还包含两种不同大小的传输信道，分别是传输控制信息C-PDUs的SCH（Short transport channel，即图中深紫色部分）和传输用户数据U-PDUs的LCH（Long transport channel），每一个用户根据FCH里面的标识，在对应的信道里面获取自己的信息。
- 保护间隔，由于上下行切换，所以在DL phase和UL phase之间存在一个slot的保护间隔。
- UL Phase（Uplink phase）：上行传输阶段，节点根据之前FCH的提示进行上行传输，传输过程类似于DL phase。为了QOS的设计，所以这里AP需要对每一轮的接入都进行控制，所以才设计了上一轮的竞争结果要先通过AP整理，然后在通过FCH广播出来，所有节点再进行接入。
- RCHs（Random access channel）：上行信道，节点在RCH过程中进行竞争，用以竞争下一个阶段的信道使用。

以上大致就是一个HiperLan的MAC层接入流程，下面我们具体讨论其接入机制。

*PS：对于逻辑信道如何处理物理信道的数据，并且在RLC子层如何进行资源的优化分配，本文并不加以讨论。*

## **HiperLan的竞争机制（EY-NPMA）**

HiperLan的竞争接入机制还是比较复杂的，是笔者目前见过的时域竞争下同时也是商业协议中，最长的一个竞争接入过程。EY-NPMA其全称为（Elimination-Yield Non-pre-emptive Priority Multiple Access），该协议是一个分布式的竞争协议，其最特殊的是结合了一下两种机制：

- **Slot-Aloha**
- **Listen-Before-Talk（即Carrier sense）**

Carrier sense是CSMA机制的主要特征，Aloha与CSMA最大的不同也是在于其发送之前没有Carrier sense的功能。我们知道802.11中，采用的竞争机制是基于CSMA/CA原理的，而如何在单天线的情况下，设计一种分布式的竞争接入协议，并且用到slot-aloha的特点，是EY-NPMA中很值得注意的一点。（以上部分内容参考自：参考《IEEE 802.11 WLAN and HIPERLAN》）

*PS：本节主要所述为HiperLan/1中的竞争机制，HiperLan/1和HiperLan/2基本还是类似的。*

EY-NPMA的名字很长，这么长的名字实际上代表了三个阶段，分别是：

- Prioritisation phase：提供高优先级的节点接入
- Elimination phase：节点公平竞争
- Yield phase：为了防止冲突，节点再一次进行竞争

其结构具体参考如下（参考：Performance Evaluation Study for HiperLan WLAN Protocol）：

![img](https://pic1.zhimg.com/80/v2-639f95c424d2a995327a31ad3f844d3c_720w.png)

无线局域网中，分布式竞争协议设计的难点主要源于半双工的天线，即收发不能同时。近年来，很多研究都是打破了半双工的限制（引入一些新的物理层技术），在特定环境下，设计一些新的物理层协议，而半双工天线下MAC层协议设计的进步还是有限。理解到这个难点之后，我们重点探讨下，EY-NPMA是如何实现这个半双工天线竞争协议的。

**EY-NPMA的三个阶段中，前两个阶段（Prioritisation和Elimination）的竞争思路和第三个阶段（Yield）是不同的，前者是一种存活到最后就是胜利者的思想，后者属于CSMA的思想。**存活的思想就是指节点首先选择一个随机的时隙数k，并从相同的时间起始，发送k个时隙。发送完之后，节点转换为监听状态，监听信道中是否还有别人正在传输。如果有别人的话，那么就失败，如果到最后都没有发现信道里面还有别人传输，那么就代表胜利。

如下图所示：（参考：Suitability of HIPERLAN's EY-NPMA for Traffic jam scenarios in VANETs）

![img](https://pic1.zhimg.com/80/v2-d15935acfff8fe0064d015b2319332d4_720w.png)

这里一共4个节点处于Prioritisation阶段，B,C,D都有高优先级数据，根据其优先级发送竞争信号，A没有，所以A不发送信号，并处于idle状态。这里的idle实际上就是描述A是处于监听状态的，故A发现了现在有高优先级的传输，所以本轮失败。B,C,D进入下一个阶段进行竞争。

![img](https://pic2.zhimg.com/80/v2-3fec0e0a2ee8fb2b3ea58909311386f5_720w.png)

在Elimination阶段时，每一个节点选择一个随机数并进行竞争，比如节点C,D选择的是3，节点B选择的是2，所以节点B在发送完2个竞争信号之后，其转为监听状态，发现信道是忙的，所以本轮失败。节点C,D由于选择的相同的随机数，故其同时转为监听状态，由于信道之后都没有人传输竞争信号，所以这两个都认为自己的胜利者了，故我们认为就是其存活下来了。

![img](https://pic2.zhimg.com/80/v2-b8062e1d9234fb15fd1bc529f9cf3719_720w.png)

在Yield阶段时，节点要进行最后一次传输。这里设计有一个先决的条件：**即竞争过程要和数据传输过程具有连续性，竞争完了之后立刻就要进行传输**。故这个节点随机数标识的**不是连续发送多少个时隙，而是多少个时隙不发，保持idle的状态**，这点实际上就是CSMA的过程了。如中，节点随机到3，节点C随机到4，即节点3在保持idle三个slot之后就进行数据传输，等节点C在第4个slot时候再监听信道的时候，这个时候发现信道是busy的，所以本轮竞争失败。

以上就是整个EY-NPMA的过程，以下我们简单讨论下其与802.11ax中的TF-R区别。

## **802.11ax（TF-R）与HiperLAN（EY-NPMA**）

802.11ax中的多用户OFDMA的竞争过程TF-R是基于Slot-Aloha思想的（参考IEEE 802.11-15/1137）

![img](https://pic4.zhimg.com/80/v2-c4dd0ba4134bfc515624d318394173a7_720w.png)

实际上我们可以总结，802.11ax（TF-R）与HiperLAN（EY-NPMA）的相似处包含两点：

- Slot-Aloha的思想
- 中心式控制的思想

TF-R中的Slot-Aloha：**节点根据本地的随机数和可竞争的RU数目，判断本轮自己是否可以发送。如果可以，那么直接随机选择一个RU发送竞争信号。这个发送过程中，没有先监听。而冲突避免是通过中心控制完成的，即AP进行判断，如果节点选择的RU没有冲突，那么AP能够成功解调，并反馈给节点，反之，AP则无法解调。**

EY-NPMA的Slot-Aloha：**Slot-Aloha主要体现在Prioritisation和Elimination phase两个过程，节点不进行监听，首先选择一个随机数进行发送，发送完了之后，再监听是否还有别人正在传输，如果没有的话，那么自己就是胜利者了。其冲突解决机制是通过多轮的竞争过程来避免的。**

至于中心是控制，由于两者都存在资源优化：

- 802.11ax**：是基于OFDMA情况下资源的优化，类似于user-selection的过程。**
- HiperLan**：在RLC子层基于QOS进行资源的优化。**

而综上所述中，HiperLan中实际上还有一些设计我们可以借鉴的，HiperLan的失败主要是其设计复杂，这点和ATM是很类似的，在早期无线流量不大的情况下，根本没有如此复杂设计的必要（即很多需求都和通信网相同了），而无线局域网主要是一种廉价的设计，价格和需求都比通信网要少很多。不过当下，无线局域网的环境越来越复杂，用户数和QOS需求也是越来越多，所以其设计思想又回归到早期的需求也是很正常的一件事，也就是之前所述的“分久必合，合久必分”。

# ax相关资料（Ekahau Site Survey）

## **序言**

这个实际上是前段时间，Ekahau Site Survey那边组织的一个网上讲座，是放在youtube上的（[802.11ax Sneak Peek – The Next Generation Wi-Fi](https://link.zhihu.com/?target=https%3A//www.youtube.com/watch%3Fv%3DhMJPAE8q5cw)），由于GFW的原因，所以笔者将其上传到了优酷上，有兴趣可以自行阅读下。

PS：这部分的资料总结，笔者还没有整理好，整理好后再另行上传。

## **802.11ax Sneak Peek – The Next Generation Wi-Fi**

**Video**：

[802.11ax Sneak Peek – The Next Generation Wi-Fi—在线播放—优酷网，视频高清在线观看视频](https://link.zhihu.com/?target=http%3A//v.youku.com/v_show/id_XMjc1NTY1MDE5Mg%3D%3D.html%3Fspm%3Da2h3j.8428770.3416059.1)

**部分PPT内容**：

![img](https://pic2.zhimg.com/80/v2-5c86345d90d4d9e8a15b04049b67e891_720w.png)

![img](https://pic2.zhimg.com/80/v2-77e7b9e7dbc490efc1d911afbe113c45_720w.png)

![img](https://pic4.zhimg.com/80/v2-84aabd9ec8d71cc6f34bed9f5ba2d09b_720w.png)

![img](https://pic3.zhimg.com/80/v2-a4d2c83a7a57a0feef2ad8e6e3da157e_720w.png)



![img](https://pic2.zhimg.com/80/v2-65f7e11500ff9a26ae3454683ea7eb15_720w.png)

![img](https://pic3.zhimg.com/80/v2-8bec01855695ce520803a763c4aa1a8a_720w.png)

![img](https://pic1.zhimg.com/80/v2-1d9f2414724347144470545ab201cf04_720w.png)

![img](https://pic2.zhimg.com/80/v2-6841b57189ee87bc24a616d725bc2c0d_720w.png)

![img](https://pic4.zhimg.com/80/v2-a25a62bfc274a1e84b6f74800f4aeed3_720w.png)

![img](https://pic3.zhimg.com/80/v2-8700eb1d92c74086b7f020677c83e912_720w.png)

![img](https://pic3.zhimg.com/80/v2-f02624905da70ba2b16166e78a75599a_720w.png)

![img](https://pic1.zhimg.com/80/v2-8dc75f1ead8f657731d4dd79fa51a2b0_720w.png)

![img](https://pic3.zhimg.com/80/v2-32b610c0e5015ee8faf6a891beeee4a6_720w.png)

![img](https://pic4.zhimg.com/80/v2-79330a4fccd44538f41784bb88321483_720w.png)

![img](https://pic1.zhimg.com/80/v2-5a1212ab063f105043841198bb566264_720w.png)

![img](https://pic1.zhimg.com/80/v2-93281c278ad19f53c6a21d23f2bca6b4_720w.png)

![img](https://pic3.zhimg.com/80/v2-9d92fc20f445ed3bb5d6cdfca8704d32_720w.png)

![img](https://pic4.zhimg.com/80/v2-09424688d2365acc20d6cdfc9447519f_720w.png)

![img](https://pic3.zhimg.com/80/v2-53792b801495d1115588b4d5bd5e5116_720w.png)

![img](https://pic3.zhimg.com/80/v2-ad7b94015ba1e4ca3044ebe9f6ba2f16_720w.png)

![img](https://pic3.zhimg.com/80/v2-6464c8efc65b36a93fbaac3bf86262b2_720w.png)

![img](https://pic3.zhimg.com/80/v2-58854913c229c5345da194693f4ae86e_720w.png)

![img](https://pic1.zhimg.com/80/v2-c5fe1500db36b25cbe7c468926af54e8_720w.png)

![img](https://pic2.zhimg.com/80/v2-0020ba80a1b3c8e968663902a92c2fcd_720w.png)

![img](https://pic2.zhimg.com/80/v2-181d34d72eb73ce53139c8408d021ee5_720w.png)

![img](https://pic4.zhimg.com/80/v2-6244efd6a1d8d6abf5c92041b7a7f19f_720w.png)

![img](https://pic4.zhimg.com/80/v2-2fb484ac6217feb03e1cba18fd96c2e7_720w.png)

![img](https://pic2.zhimg.com/80/v2-7d048a21d10566a6683d4593f2252109_720w.png)

![img](https://pic2.zhimg.com/80/v2-565e4530f17adc6ac10e14cfb9ee86f5_720w.png)

![img](https://pic4.zhimg.com/80/v2-aec3eeb1018b5c42500046370d8d4e43_720w.png)

![img](https://pic3.zhimg.com/80/v2-c9c5d87465c111b3a20a661ba7a7a086_720w.png)

![img](https://pic4.zhimg.com/80/v2-30fd07c989769aa226d0036f6cb71737_720w.png)

# WiFi-6要解决的问题，目标，以及如何技术革新

## **序言**

笔者在学习802.11ax过程中，发现有一些英文blog的内容总结还是不错的，所以笔者简单翻译一下，大家可以学习一下。本文参考自：

- [How Does 802.11ax Address Common Problems With Wi-Fi?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/how-does-802-11ax-address-common-problems-with-wi-fi/)
- [What Are The Goals of The 802.11ax Standard?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/what-are-the-goals-of-the-80211ax-standard/)
- [What Does 802.11ax Change About The WLAN Standard?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/what-does-802-11ax-change-about-the-wlan-standard/)

## **802.11ax如何解决Wi-Fi的常见问题？**

802.11n和802.11ac通过引入PHY（物理层）和MAC（媒介访问层）的一些新技术，提供了更高的无线接入速率。实质上，这些技术是建造了更宽的"高速公路"和更快的"汽车"。

但它导致了一些问题。下一代Wi-Fi系统面临的问题涉及由于密集部署和由于具有优势的小数据帧（例如，Wi-Fi语音）的网络流量而导致的系统效率降低。随着使用Wi-Fi的设备数量不断增加以及物联网的出现，Wi-Fi网络需要更好地管理密集的客户端环境，增加数据流量以及各种不同的应用程序和服务组合QoS要求。

但是这些设计会导致一些问题，进而导致网络系统效率降低。当新的WiFi标准被建立时，其就需要解决问题，比如节点的密集部署和QoS优先级高的短数据帧（比如VoWiFi语音流量）。

随着IoT物联网的不断发展，WiFi设备的数量是不断增加的。对于WiFi网络而言，就需要更好的对密集终端场景进行控制与优化，提升数据流量的传输质量，以及针对不同QoS要求的应用程序流量做进一步的优化适配，以提升整体网络质量。

正如之前我们所述，过去Wi-Fi协议的发展主要集中在提供更高的峰值速率（理论）。然而，面对现实世界中大量的用户数，以及各种各样的需求，WiFi协议需要不断的基于用户的实际体验，而不断被改进。问题不在于WiFi的峰值速率有多快，但是WiFi网络需要有足够的容量，从保障在终端的数量增长的时候，以及多种多样的服务场景下网络的质量。

802.11ax与以前的802.11性能改进相比带来了巨大变化。其最新的802.11ax修正案的标题也暗示了这一点，因为它使用了"高效率"这一术语，相比802.11ax以前的版本则是强调"高吞吐量"。802.11ax通过引入一些新技术，大幅提升传输容量，提供更好覆盖能力，以及减少拥塞的技术来改善Wi-Fi网络。为用户提供更好的使用体验。

802.11ax标准的设计目标是让Wi-Fi适应密集型的场景，比如数十台终端同时与一个无线接入点（AP）无线电通信。在传统的WiFi技术基础上，借鉴了移动蜂窝通信技术中的创新技术，802.11ax标准将会将系统容量提升多达4倍。这些提升不仅仅是通过提升传输速率提升的，更进一步是提高传输效率。并且802.11ax兼容2.4GHz和5GHz两个频段，这为其在各种环境下部署提供了便利，比如家用，学校，企业，热点，机场等。

## **802.11ax标准的目标是什么？**

在进一步了解802.11ax之前，我们需要回顾一些基本知识。提示一下，由于无线射频传输（RF）是基于半双工的，这意味着在任何时间只有一个终端可以在信道上传输。每个终端需要通过轮流一个个进行传输，如果多个人同时进行传输，那么会造成冲突，从而任何一个人的数据都没有办法正常的传输。

此外，我们需要知道WiFi传输速率不等于TCP连接的吞吐量。通常WiFi设备的速率表上宣称速率，永远不会与您的无线接入点（AP）真实传输时的吞吐量相匹配。 其中MAC层采用的CSMA/CA这种竞争协议会耗费大量的信道带宽，这种开销我们称为"竞争开销"。竞争开销和一些其他的传输开销导致传统的802.11a/b/g网络中，平均的TCP连接吞吐量大约是WiFi宣称速率的40%-50%。在802.11n/ac中，引入了聚合帧，其TCP连接吞吐量会提升到60%-70%。以上我们讨论的还都是比较理想的情况下。

在802.11的产生的冲突，以及竞争所需要花费的竞争开销，都意味着MAC层的传输效率下降。当WiFi网络中，待传输的数据帧比较小（比如小于256 Bytes），那么会加剧传输效率的下降。此外，在密集部署的场景中，由于重叠BSS的部署，会造成一些额外的冲突（比如隐藏和暴露终端），造成彼此间的传输被不必要的归纳绕。

所以，目前802.11ax协议专注于高效率。其通过改善PHY和MAC层的管理功能，优化所有类型待传的数据帧。

802.11ax任务组的目标包括：

- 提升在2.4Ghz和5GHz频段上的协议运行（对比802.11ac，其只运行在5GHz频段）

- 在密集部署的场景下，提升每个无线接入点（AP）至少4倍的平均吞吐量

- - 对比802.11ac进一步规范总的吞吐量
    - 对室内和室外环境的WiFi同步提升速率
    - 保持并进一步提升终端传输的能耗效率

- 最重要的是，提升WiFi节点在各种环境下，对流量的管理能力以及效率

## **802.11ax如何改变WLAN标准？**

在802.11ac中引入的MU-MIMO技术，其理论上允许访问接入点(AP)使用多个射频天线(RF)在同一信道上，同一时间向多个下行终端进行传输，从而提高传输效率。在802.11ax中，协议进一步要求在下行和上行链路中都需要MU-MIMO，最高达到8x8x8的MU-MIMO，这意味着AP可以同时为多达8个用户终端提供服务，从而显着提升容量。在802.11ac的下行MU-MIMO中，我们遇到了一些问题：

- 大部分终端设备都是单天线的。于此同时，许多双天线的终端为了防止干扰，其实际工作在DL MU-MIMO的单流模式下，也等价于单天线模式。
- 为了执行MU-MIMO的预编码，用户的需要连续发送信道探测帧，这个探测过程有较高的信道资源开销

其实上行链路MU-MIMO最初在11ac中已经被考虑，但由于实现问题，802.11ac版本最终放弃了这项设计。因为以上的问题，802.11ax进一步重点增强了MU-MIMO技术，包括多用户间的信道探测帧，数据帧等等，其能够减少信道开销并加强上行链路的反抗。但是就像802.11ac没有完全实现MU-MIMO一样，只有时间才能够证明802.11ax是否真能将MU-MIMO技术很好的应用到现实无线网络中。

802.11ax中另外一个改良是QAM调制技术。如果您回想一下802.11ac，其引入了256-QAM。256-QAM相当于每个symbol中，其一个星座点的位置可以传递8位bit信息。在802.11ax中，QAM调制提升到了1024-QAM，其相当于每个symbol的星座点可以传递10bit信息。利用1024-QAM可以将物理数据速率提高25％。1024-QAM基于相同频谱下，利用更有效的数据封装来实现的。这类似于使用双层巴士代替单层巴士，从而更充分利用公交车道，提高整条公路的运输效率。

802.11ax中下一项改良为OBSS-Overlapping，即重叠覆盖的基本服务集。为了提高空间复用效率和性能，11ax根据BSS的"颜色"自适应调整载波侦听的操作。根据生成流量的BSS不同，终端使用不同的灵敏度阈值（即载波监听的阈值）来检测信道，判断当前是可以传输还是需要延迟。通过这项技术，提升多覆盖情况下整体的性能。

802.11ax还引入了更长的OFDM符号。其采用了4倍的OFDM符号时间（即更小的子载波间隔），提高了频谱效率并且还提高了鲁棒性，这项技术尤其适用于室外场景下的传输。

802.11ax还进一步修改了帧格式。在802.11中，所有的帧之前都包含了一个前导码(Preamble)，其作为物理层头部(PHY)的一部分。前导码用于发送终端和接收终端之间的射频同步环节，包含了帧同步，载波同步，符号同步。前导码由两部分组成：Legacy（与传统802.11前导的兼容部分）和High Efficiency（高效率，专用于802.11ax）部分。前部分前导码为了让传统的终端可以识别，从而实现协议向后兼容的目的。

在节能方面，802.11ax引入了目标唤醒时间（Target Wake Time，TWT）技术。 TWT允许AP设置一系列时间间隔，当终端等待到预定的时间间隔后，其会被"唤醒"并进行交换数据帧。该TWT技术使得终端可以"睡眠"更长的时间，从而降低能耗。这项技术对于所有移动设备，尤其是物联网IoT设备而言是尤其重要的。

最后，802.11ax还引入了正交频分多址(Orthogonal Frequency Division Multiple Access, OFDMA)。有关该项技术我们后续会展开讨论。

802.11ax任务组的启动时间为2014年5月，项目组一直在努力工作，目的使802.11ax尽快成为现实。项目组通过指定标准的草案，不过其批准日期，以及该802.11ax标准与实际商业市场结合以及最终演变成终端还有较长的路要走。让我们拭目以待。

# BSS Coloring技术

## **序言**

笔者在学习802.11ax过程中，发现有一些英文blog的内容总结还是不错的，所以笔者简单翻译一下，大家可以学习一下。

本文参考自：

- [What Is BSS Coloring In 802.11ax?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/what-is-bss-coloring-in-802-11ax/)
- [What is BSS Color in 802.11ax?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/what-is-bss-coloring/)
- [How Does BSS Coloring Work in 802.11ax?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/how-does-bss-coloring-work-in-802-11ax/)

## **BSS Coloring技术介绍**

BSS Coloring是最初在802.11ah中引入的一种机制，用于为每个BSS分配不同的“颜色”。z该技术目的是增加在密集环境中，无线网络的系统容量，增加BSS之间的频率重用。然而，当前的802.11的MAC层机制，其会导致一个BSS的设备会被同频道的另一个BSS影响，无法同时进行传输，从而对于网络容量没有提升。

在802.11ax中，BSS Coloring是一种用于解决由于重叠基本服务集（OBSS）提升空间重用率的方法，减少因为重叠BSS导致的MAC层竞争开销。BSS Coloring的目标是提升空间复用，同时不会因为BSS间的干扰而导致节点间PHY层传输速率的降低（即降低MCS值）。802.11ax设备通过向PHY头部添加字段（即BSS Coloring字段）来区分BSS，节点在竞争时，根据检测到物理层头部的BSS Coloring字段来分配MAC层的竞争行为。若BSS Coloring字段信息相同，那么代表在同一个BSS内(intra-BSS)。若BSS Coloring字段信息不同，那么代表这里是重叠覆盖区域，在多个BSS间(inter-BSS)。 在传统802.11中，若在BSS间(inter-BSS)，当节点检测到信道忙时，需要推迟自己的传输，直到信道空闲才可以发送。在802.11ax中，引入了自适应CCA机制(adaptive CCA)。通过提高BSS间(inter-BSS)信号检测阈值，同时保持BSS内(intra-BSS)的较低信号检测阈值（两个阈值，大约4dB左右的差值），来减少MAC层竞争时的竞争问题，提升MAC层效率。

## **什么是802.11ax中的**BSS Coloring技术？

802.11协议是采用CSMA/CA作为MAC层的协议，其采用的是半双工通信机制，这表示在同一个时间只有一个无线电设备可以在网络上进行传输。如果一个802.11终端检测到任意一个802.11终端的传输信号(即PHY层的Header)，其会推迟传输。我们称多个AP和客户端在同一个信道上进行部署，并执行竞争传输叫做OBSS(具有重叠的基本服务集)。在OBSS中，我们描述这种同信道的干扰为co-channel interference(CCI).

信道复用的核心问题是最小化空口传输时间并减少由于OBSS场景导致的性能下降。 802.11ax修正案基于提升空间复用的思想，提出自适应的CCA机制(adaptive clear channel assessment, adaptive-CCA)来对于信道进行检测。

BSS Coloring，是用于识别重叠基本服务集（OBSS）的方法。 其最先是在802.11ah-2016修正案中定义，现在也沿用到了802.11ax中。 BSS Coloring是一个字段，标识了BSS的ID。当多个无线终端在同一信道上传输时，802.11ax无线电能够使用BSS Coloring字段区分BSS。

BSS Coloring的信息是同时被添加在PHY层和MAC层中的。在802.11ax PHY头部的Preamble中，其SIG-A字段包含6个Bit的BSS Coloring信息字段。该字段可以识别多达63个BSS。

![img](https://pic2.zhimg.com/80/v2-f66cd831e2aa3d68a7bd05974d34dc51_720w.jpg)

在802.11管理帧中也可以看到BSS Coloring信息(如上图所示)。在Beacon帧中的HE Element中，包含BSS Coloring的子字段。其也是6个Bit的BSS Coloring信息字段，可以标识63个BSS。

在802.11ax中，MAC层的竞争取决于检测到的BSS Coloring。其将CCA的阈值和BSS Coloring信息关联起来(即adaptive-CCA)，从而提升空间复用能力。让节点可以忽略OBSS间的传输，可以在此时同时进行传输，从而提升信道利用率。802.11ax修正案定义了两种的空间重用模式，一种称为基于OBSS PD的空间重用，另一种称为基于SRP的空间重用，以后我们再分别讨论。

## **在802.11ax，AP如何选择**BSS Color**？**

基本服务集（BSS）是任意802.11网络的基础拓扑。构成BSS的元素包含，包括1个AP和多个节点。在多个节点在信道传输时，802.11ax通过BSS Coloring字段来区分BSS。若BSS Coloring信息相同，那么是BSS内的传输，若BSS Coloring不同，那么是BSS间的传输，即来自于OBSS内部的传输。

![img](https://pic3.zhimg.com/80/v2-360f0153f18fb8bae6b9081eb0f7c38e_720w.jpg)

对于802.11ax的AP，其如果检测到使用相同颜色的OBSS，则它能够更改变其BSS颜色，减少同频干扰。若AP与AP间的BSS Coloring一样，那么这也是一种BSS Coloring的冲突，即颜色冲突。如上图所示，如果802.11ax AP听到来自其他AP或者该AP节点的不同BSS Coloring字段，那么是检测到一次颜色冲突。

![img](https://pic1.zhimg.com/80/v2-4362cb7e22beedddb767b2d37c81b924_720w.jpg)

另外，如果终端检测到颜色冲突，则该终端会向其关联的AP发送颜色冲突报告。如上图所示，AP-1无法听到AP-2，但AP-1的关联的终端可以听到来自于OBSS区域内，其他不同BSS Coloring的传输，从而向AP发送颜色冲突报告。终端向AP会报告其能够监听到的所有OBSS的BSS Coloring信息。

当AP检测到颜色冲突后，其可以决定改变其BSS颜色。不过改变BSS Coloring的标准和选择新BSS Coloring信息的方法超出802.11ax草案修正案的范围。WLAN供应商目前可以自行制定，例如Aerohive信道选择协议（ACSP）。

![img](https://pic2.zhimg.com/80/v2-16f827ae3d3c33cc2d1577f0ce9b9075_720w.jpg)



AP会通过Beacon告知所有关联在本BSS内部的节点，BSS Coloring的改变。BSS Coloring的改变还可以通过探测响应和重新关联响应帧中进行通知。如上图所示，AP告知节点BSS Coloring的颜色变化，其New BSS Color子字段则包含新BSS Coloring的数值。

# 802.11ax帧聚合增强功能

## **序言**

帧聚合（Frame Aggregation）是802.11中为了提升传输效率的一种方式，自802.11n开始被引入，本文介绍一下802.11ax中对帧聚合的进一步使用。本文参考自：[802.11ax Frame Aggregation Enhancements](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/802-11ax-frame-aggregation-enhancements/)。

## **802.11ax帧聚合增强功能**

802.11n和802.11ac的主要目标是提高物理层传输速率和吞吐量。在802.11n/ac中，帧聚合(Frame Aggregation)是一个提高空口效率的关键技术。帧聚合是将多个无线帧组合成单个更长的无线帧传输，然后一次进行传输。在MAC层的竞争开销不变的情况下（由于用一个帧代替多个帧，所以只有一次竞争开销），增加了传输的内容，导致减少额外的空口时间。

为了理解帧聚合技术，我们首先要知道两个概念：MSDU和MPDU。SDU和PDU是两个基本单元，M代表MAC层。在802.11中，MAC服务数据单元（MAC Service Data Unit *,* MSDU）是802.11数据帧的第3-7层有效载荷(即Payload)，MSDU仅仅是Payload部分，没有Header。 802.11 MAC协议数据单元（MAC Protocol Data Unit ,MPDU）本质是除了Payload以外，还包含了MAC层的数据包头部，即MDPU包含了MAC层头部以及MSDU。

802.11n defined two methods of frame aggregation. The first method of frame aggregation known as*Aggregate MAC Service Data Unit (A-MSDU)*aggregates multiple MSDUs into a single frame transmission. As shown in Figure 1, the second method known as*Aggregate MAC Protocol Data Unit (A-MPDU)*aggregates multiple frames into a single transmission followed by a Block Acknowledgement.

802.11n定义了两种帧聚合方法：

- 针对MSDU的帧聚合（A-MSDU），将多个MSDU组合成一个数据帧，共享一个MAC头部
- 针对MPDU的帧聚合（A-MPDU），将多个MPDU组合，其结构如下图所示

![img](https://pic2.zhimg.com/80/v2-3c1eeccbfe809e0f26f0fe65961057d9_720w.jpg)

当节点接收到聚合帧后，采用块ACK（Block ACK）的形式进行反馈。

在实际场景中，A-MPDU最为常用。因为其采用Block ACK，重传开销较少。因此，在802.11ac中，仅仅定义了A-MPDU（即没有定义A-MSDU了）。802.11ac的数据帧仅仅采用A-MPDU进行聚合传输。所有的802.11ac数据帧都是采用A-MPDU的形式传输的。尽管802.11ac传输采用A-MPDU，但是需要被指出的是A-MSDU可以和A-MPDU一起使用，一个A-MPDU的Payload部分可以携带A-MSDU，这样两者就是结合使用了。

802.11ax在物理层定义了多种增强功能，比如引入OFDMA提高效率。另外，实际上在MAC层上还存在一种有效增强效率的机制，即帧聚合技术的改进。

在802.11ax之前，A-MPDU中每个MPDU必须都具有相同的802.11e QoS接入类别，也就是所有的MPDU都要是同一个优先级的流量。比如高优先级的MPDU（比如语音）不能和其他相对低优先级（比如Best Effort或Video）的MPDU组成聚合帧进行传输。 802.11ax引入多流量标识符（Multi-Traffic Identifier，Multi-TID）的A-MPDU，其允许来自相同或不同QoS接入类别流量进行聚合，其通过流量标识符（TID）进行识别。通过组合不同QoS流量类别的MPDU，其能更有效的让802.11ax终端进行聚合传输，减少竞争开销，提高吞吐量，最终提高整体网络效率。

# 双重NAV技术（Dueling NAVs）

## **序言**

NAV是802.11中最基本的MAC层元素之一，在802.11协议中起着非常重要的功能，而且先行协议下，基本上所有的兼容性机制都围绕的NAV展开。在802.11ax中，引入了双重NAV技术（Dueling NAVs）进一步扩展其功能，本文即针对这项技术做一个展开。本文参考自：[Dueling NAVs in 802.11ax](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/dueling-navs-in-802-11ax/)。

## **802.11ax中的双重NAV技术（Dueling NAVs）**

Wi-Fi使用两种载波侦听方法来确定信道是否繁忙，若繁忙那么要延迟进行传输。空闲信道评估（clear channel assessment，CCA）是检测信道是否繁忙的物理机制，同时在WiFi中，还存在一种虚拟载波监听机制，其和物理载波监听机制并行工作。虚拟载波侦听机制的核心是网络分配矢量（network allocation vector ，NAV）的定时器机制。

在802.11ax中已经引入了BSS Coloring机制，以适应在OBSS环境下，自适应调节空闲信道评估阈值（即adaptive CCA)，以增加空间信道的复用率，提供更多并行传输的可能性。

在BSS Coloring中引入的adaptive CCA也可以和虚拟载波监听的NAV组合使用，由于adaptive CCA中已经引入了两个不同的监测阈值，那么意味着其和NAV机制组合使用时，也需要两个独立的NAV定时器。在802.11ax中，目前已经新定义了两个NAV定时器：BSS内部的NAV定时器（intra-BSS NAV timer），和基本NAV定时器（basic NAV timer）。

- **BSS内部NAV定时器（intra-BSS NAV timer）**：其只够通过来自于同一个BSS内部的终端来设置，通过BSS内部终端传输的Duration/ID字段来设置NAV定时器的数值。
- **基本NAV定时器（basic NAV timer）**：其可由来自于不同BSS区域的终端来设置，也是根据这些终端传输的Duration/ID字段来设置NAV定时器的数值。

以上两个NAV定时器同时工作，如果由任意一个NAV设置为非0，也就是正在定时中，那么就认为信道是忙，正在被占据。

引入了两个NAV定时器是有益的，尤其在密集场景下。802.11ax的终端不仅仅需要保护其在BSS内部 （intra-BSS）传输的帧，还需要避免来与于其他BSS（即BSS间，inter-BSS）传输的干扰。

![img](https://pic1.zhimg.com/80/v2-a81c9c31665385b9e0113194ac2a6f3c_720w.jpg)

如上图所示，802.11ax AP-1发送了一个RTS帧（包含设置NAV=200us），以保护其与终端STA#1的数据帧交换。因为STA#1与AP-1相关联，即STA#1是AP-1这个BSS内部的终端（称该BSS为BSS#1），所以STA#1将**BSS内部NAV定时器**设置为200μs。然而，在数据帧交换期间，属于BSS#1（即AP-1）的终端（即STA#1）还可以收到不同BSS的客户端传递的RTS帧。比如终端STA#2传输的RTS帧（包含Duration=125us），其也会设置STA#1的NAV定时器，此时由于是不同BSS的终端设置，STA#1会将其**基本NAV定时器**设置成125us。在上图中，STA#1的内部NAV定时器首先倒数到0，但是其基本NAV定时器还没有倒数到0，还将继续递减。在此两个NAV定时器没有全部倒数至0之前，STA#1无法进行新的一轮发送。这种双重NAV的机制可以保证BSS#2中，帧的交换不受到干扰。

# OMI机制

## **序言**

**Operating Mode Indication (OMI)**，如果翻译成中文的话大致为运行模式指示。这里是802.11ax MAC层运行的一种基本机制，用以交互形式分配兼容性以及信道带宽的协商。本文即针对这项技术做一个展开。本文参考自：[What is Operating Mode Indication (OMI)?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/operating-mode-indication-wifi-6/)。

## **Operating Mode Indication (OMI)**

在802.11ax中，上行和下行链路都引入了OFDMA技术，以实现802.11ax AP和终端间的多用户通信。当任意节点竞争胜利后，其会发起一次TXOP传输（Transmit Opportunity）。在TXOP期间，AP会利用OFDMA技术，将信道分成一个个资源单元（Resource Units ，RUs），以便可以同时进行多用户传输。

传统的802.11a/b/g/n/ac终端想要传输上行数据时（比如进行TXOP传输），其必须通过竞争。在802.11ax中，终端的上行接入机会是可以被AP进行同步和控制的。那么这里常被问的一个问题，即“802.11ax终端能不能不参与一个OFDMA的上行传输，而做为一个独立终端竞争信道，并进行单独的上行传输? ”

![img](https://pic3.zhimg.com/80/v2-dad6987df710b2f1eddd3c6d0475c1e6_720w.jpg)

802.11ax为此目的定义了操作模式指示（OMI）过程，802.11ax通过OMI机制完成传输模式的切换。如上图所示，终端作为OMI发起者（OMI Initiator）发送具有OM控制字段的帧给AP，AP作为OMI的响应者（OMI Responder）。

802.11ax终端使用802.11数据使用OM控制字段（OM Control Subfield，其通常位于数据或者管理帧中），其用来指示改变AP的发送或者接收模式。802.11ax终端可以通过发送TOM信息（Transmit Operating Mode）给AP，从而在单用户或多用户UL-OFDMA之间切换。若多用户模式，即根据AP控制进行UL-OFDMA传输，若单用户模式，那么终端就自行竞争，并执行单用户的数据传输。802.11ax的终端可以在上行OFDMA传输期间（UL-OFDMA），暂停并且恢复对AP发送的触发帧（Trigger Frames）反馈。

![img](https://pic2.zhimg.com/80/v2-9dae0fad62bb3cf5cef698f3d89eac35_720w.jpg)

另外，OMI还可以用作802.11ax终端和AP进行接收模式（Receive Operating Mode ，ROM）的切换。802.11ax终端作为OMI Initiator向AP指示，其支持的下行链路的最大空间流数量和最大的信道带宽。如上图所示，终端会通过发送ROM信息给AP，指示其工作的信道大小从80MHz切换到20MHz。

OMI功能对于802.11ax客户端是可选的，这一项技术有可能会在802.11ax AP中开始逐步被引入。

# OFDMA资源单元（Resource Units）

## **序言**

OFDMA技术是802.11ax引入了新的物理层机制，其可以让多个用户并行进行接入。在802.11协议中也是非常重要的功能。通过OFDMA技术，信道资源被分成一个个Resource Units（RUs），本文将会对RU进行一个展开。

本文参考自：[What are OFDMA Resource Units in 802.11ax?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/ofdma-resource-units-80211ax/)。

## **Resource Units in 802.11ax**

正交频分多址（Orthogonal Frequency-Division Multiple Access*，*OFDMA）作为主要的802.11ax增强功能，其是OFDM数字调制技术的多用户版本。 OFDMA将信道细分为较小的资源单元RU。通过OFDMA的资源细分，多个客户端可以通过占据不同的RU资源进行并行传输。

![img](https://pic2.zhimg.com/80/v2-29fc5c781fda4155f3adf38c3bb4a5d9_720w.jpg)OFDMA RUs – 20MHz信道带宽

一个20MHz的OFDMA信道包含了256个子载波（Subcarriers，或者称为Tones）组成。这些子载波组成了一些子信道，我们称一个子信道为一个资源单元（RU）。如上图所示，当20 MHz信道时被细分时，802.11ax终端可以使用4种不同大小的RU单元，分别包含26个子载波，52个子载波，106个子载波和242子载波，大约相当于2MHz，4MHz，8MHz和20MHz信道带宽的分别。 802.11ax的AP决定了在一个20MHz信道内可以使用多少个RU，以及RU形成的不同组合。

802.11ax AP可以将整个信道分配给一个客户端，也可以利用OFDMA技术将信道分给多个终端同时接入。例如，802.11ax AP可以使用8 MHz的带宽与一个802.11ax终端通信，同时使用4 MHz的带宽与另外三个802.11ax终端通信。这些通信过程可以是下行链路，也可以是上行链路。

![img](https://pic2.zhimg.com/80/v2-58746870e88b7162b079a212fadf60bd_720w.jpg)OFDMA传输过程

在上图示例中，802.11ax AP首先向终端#1和终端#2发送下行数据，在第一时刻，20MHz的信道通过OFDMA技术被划分成了两个子信道。在OFDMA技术中，20MHz信道包含了256个子载波，终端#1和终端#2分别占据106个子载波，这些子载波互相没有交叠。在第二时刻，802.11ax AP向终端#3，终端#4，终端#5和终端#6发送下行信息。在此时，信道被划分成4个子信道，分别占据52个子载波。在第三时刻，802.11ax AP使用整个信道发送下行数据帧给终端#5，此时一共使用了242个数据子载波，其可以有效的利用整个20MHz的信道。在第四时刻，AP使用两个子信道，分别是106个子载波向终端#4和终端#6发送数据。在第五时刻，AP在此向单个终端（即终端#1）发送下行数据，其占据整个20MHz信道，包含242个数据子载波。在第六时刻，AP同时向终端#3，终端#4和终端#6发送下行数据。此时，信道被划分成3个不等大小的子信道，其中终端#3和终端#4分别占据52个子载波，终端#6占据106个子载波。

为了兼容早期的其他802.11协议，802.11ax仍将支持OFDM。在802.11ax中，管理帧和控制帧仍将使用802.11a/g/n/ac的OFDM技术，以及以基本的传输速率进行传输（一般就是最低从传输速率），这保证了其他早期的802.11终端能够互相理解。此时管理帧和控制帧都是采用整个20MHz信道，利用整个64个子载波进行传输。OFDMA技术仅仅用于802.11ax AP和802.11ax终端之间的数据帧交互。在之后我们会进一步对于数据交互和竞争过程进行展开。

# OFDM和OFDMA Subcarriers的区别

**序言**

OFDMA技术是802.11ax引入了新的物层机制，其可以让多个用户并行进行接入。在802.11协议中也是非常重要的功能。本文将针对OFDM和OFDMA的差异做进一步介绍。

本文参考自：David Coleman， 《[OFDM and OFDMA Subcarriers – What Are the Differences?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/ofdm-and-ofdma-subcarriers/)》

## **OFDM and OFDMA Subcarriers**

在传统的802.11a/g/n/ac中，采用了正交频分复用（OFDM，Orthogonal Frequency Division Multiplexing）作为单用户传输的物理层技术。在802.11ax中，引入了一种新型的基于OFDM的OFDMA技术，其是OFDM对应的多用户版本，其将信道划分成更小的时频资源单元，即RU（Resource Unit）。通过OFMDA的划分，多个用户可以并行进行传输，提高信道利用率。每一个RU内的数据和导频，在OFDMA子信道内都是相邻而且连续的。

OFDM和OFDMA技术的实现是通过快速傅里叶变换（FFT）和快速傅里叶逆变换（IFFT）来构成的。在OFDM中，信道被分成了多个子载波，每一个子载波是正交的，不会互相干扰，所以其子载波之间是没有保护间隔的。在OFDM中，也会分配一个子载波作为Null子载波，其不承载任何数据，用来防止载波间干扰（Inter-Carrier Interference ，ICI）。

![img](https://pic2.zhimg.com/80/v2-ce32b54898f59158a3849438ffeeec99_720w.jpg)802.11n/ac 20 MHz channel — OFDM subcarriers，图片参考David Coleman， 《OFDM and OFDMA Subcarriers – What Are the Differences?》

OFDM和OFDMA之间有哪些主要区别呢？如上图所示，一个20 MHz的信道，在802.11n/ac有64个子载波组成，每个OFDM子载波是312.5KHz。其中有52个子载波用于承载数据（data subcarriers），4个子载波用作导频（pilot subcarriers），八个子载波用作保护频带（unused subcarriers）。OFDM子载波可以称为OFDM subcarriers或者OFDM tones。

![img](https://pic3.zhimg.com/80/v2-a5a84b63694162d64abfe12dee072b5e_720w.jpg)Subcarrier spacing，图片参考David Coleman， 《OFDM and OFDMA Subcarriers – What Are the Differences?》

802.11ax引入了更长的OFDM Symbol时间（12.8μs），这是传统OFDM Symbol的四倍时间（传统为3.2μs）。子载波间隔在数值上等于OFDM Symbol的倒数。由于OFDM Symbol变长了，单个子载波带宽（或者说子载波间隔）从312.5KHz细化到78.125KHz。更窄的子载波间隔，允许会提供更高的频域分辨率，提升均衡能力，并且增强信道鲁棒性。如上图所示，在子载波带宽变成78.125KHz间隔后，一个20MHz信道一共可以包含256个子载波。

在802.11ax的OFDMA中，一共有三种类型的子载波，如下所示：

- **数据子载波**：这些子载波用于承载数据，其传输速率是在802.11ac的基础上（即在802.11ac的MCS上），引入了两个新的MCS（Modulation and Coding Schemes），包含1024-QAM这种更高的调制阶数。
- **导频子载波**：导频子载波用于发送者和接收者之间的同步，其不承载调制数据。
- **未使用的子载波**：这些子载波主要用作保护子载波（Guard Subcarriers）或空子载波（Null Subcarriers），以抵抗来自相邻信道或相邻子信道的干扰（即抵抗ICI）。

# 触发帧（Trigger Frames）和MAC接入机制

## **序言**

802.11ax相对比传统的802.11协议，其在MAC层上的改变是比较大的。其基本思想已经从强调分布式的场景，逐渐变成了强调中心式，高密度，优化资源分配上了。但是802.11协议是工作在ISM频段上，其无法通过换一个新的频段，来制作一个完全全新的协议。所以在802.11中，为了兼容前后不同的工作机制，需要做一些更细节的设计，保证兼容性。本文就针对802.11ax中的接入机制和其新引入的触发帧机制（Trigger Frames）做一个简单介绍。

本文参考自：

- [802.11ax and Medium Contention](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/802-11ax-and-medium-contention/)
- [What are OFDMA Trigger Frames?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/what-are-ofdma-trigger-frames/)

## **802.11ax中的MAC层接入机制**

802.11ax提升效率的秘诀之一就是OFDMA技术。OFDMA是OFDM技术的多用户版本，在诸如LTE等的其他无线技术中已经被广泛采用。在OFDMA中，信道被细分称更小的单元，称为资源单元（Resource Units，RU） 。通过细分信道，OFDMA通过分配不同的RU给多终端，从而允许多个终端执行并行传输，同时接入无线网络。即总结而言，OFDMA是一种多用户传输技术。

![img](https://pic1.zhimg.com/80/v2-3d2f69ce060a0d88c870ae782fb84cc4_720w.jpg)

如上图所示，在802.11ax中，1个802.11ax AP将1个20 MHz信道划分为多个资源单元（RU），每一个RU被分配给不同的终端，802.11ax AP同时向这些终端进行下行传输。同时，802.11ax AP还可以同步调度802.11终端，让其执行并行的上行传输。在802.11ax中，竞争的规则还是存在的（即CSMA/CA）的规则，任何节点（包括AP）在发送之前都需要竞争。在此技术上，AP通过利用竞争（比如利用更高优先级的竞争参数）获得信道后，通过TXOP（transmission opportunity ）技术占据信道一段时间，从而达到控制信道接入的目的，因此802.11ax中AP具有一定的控制能力。一旦AP竞争并获得了TXOP是时间，AP可以控制高达9个802.11ax的终端进行上行传输或者下行传输（指的是在20MHz信道带宽下，最多可以承载9个RU，每一个RU为26个子载波，具体数目可查《802.11ax draft》的Table 26-7）。针对于不同的TXOP，其RU的数量也是不一样的。对于上行接入（UL-OFDMA），AP采用触发帧机制（Trigger Frames），向802.11ax的终端进行调度和RU资源的分配。

![img](https://pic4.zhimg.com/80/v2-e90b62f696539d2e138501fef5ce205f_720w.png)

在802.11ax中，还存在一个OMI机制，这个机制是为了解决802.11终端是采用竞争接入信道（即单用户接入）还是采用OFDMA调度接入信道的（即多用户接入）。在之前一篇文章中《[802.11ax前瞻10：Operating Mode Indication (OMI)](https://zhuanlan.zhihu.com/p/77526750)》，我们介绍过OMI机制。在OMI中，终端可以向AP发送信息，通知AP其支持的上下行所支持的最大空间流数目以及信道带宽。如上图所示，802.11ax终端采用OM控制字段（在数据帧或者管理帧中），来指示传输模式或者接收模式的变化。比如802.11ax终端可以在单用户接入或者多用户接入模式间切换。

## **802.11ax中的触发帧机制（Trigger Frames）?**

802.11ax的多用户传输是基于OFDMA技术。在其进行上行传输（UL-OFDMA）或者下行传输（DL-OFDMA）传输的时候，都需要利用触发帧（Trigger Frames）来实现多用户通信间，调度信息的交换。触发帧也用户MU-MIMO间帧的交换。

![img](https://pic4.zhimg.com/80/v2-1ea7f7e5b1603401ef4ccacc031d7677_720w.jpg)

触发帧包含了多种子类型，其在802.11ax中提供了很多重要的功能。上图列举了802.11ax中触发帧具体对应的子类型。

在OFDMA信道接入中，触发帧中包含了有关RU资源分配的信息。RU资源分配的信息，分别存放在帧中的PHY和MAC层头部中，比如RU分配的信息会在802.11触发帧的PHY头部中HE-SIG-B字段内找到，也会到触发帧的Payload中的user information字段找到。

![img](https://pic4.zhimg.com/80/v2-ee8ee968993414fdcd26e80c9075d68f_720w.jpg)

上图为UL-OFDMA的触发帧交换过程。对于UL-OFDMA，802.11ax AP发送触发帧告知终端，发送上行链路时（即UL-OFDMA），在每一个指定的RU上，其使用多少个空间流以及其对应的调制编码方案（Modulation and Coding Scheme，MCS）。这些信息分布在触发帧的Payload中的user information字段（即其中SS Allocation和UL-MCS）内。

![img](https://pic3.zhimg.com/80/v2-36ea73ba508d9bc1fa3312576771592a_720w.jpg)

AP还可以通过触发帧来调整802.11ax终端的发送功率。在触发帧内的UL Target RSSI子字段上，其按照dBm标注了AP所期待的接收功率（通过所有天线接收到的总功率）。这个功率也是根据RU来分配的，每一个RU分配的字段都有对应的UL Targer RSSI字段。UL Target RSSI字段采用0-90的数值来映射-110dBm到-20dBm，并且其数值127代表其时采用最大功率来发送的。基于触发帧的信息，802.11ax终端在其能力范围内调整功率，由于终端的能力不同，所以这个功率时一个期望功率，当终端的硬件或者地方监管限制（比如说法定的无线电的发射功率限制），那么可能终端就无法调节。

# 下行OFDMA接入机制（DL-OFDMA）

## **序言**

在介绍完802.11ax的信道接入以及其触发帧机制后，本文着重介绍下行OFDMA的接入机制（即DL-OFDMA）。本文参考自：[How Does DL-OFDMA Work in 802.11ax?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/dl-ofdma/)。

## **下行OFDMA接入机制（DL-OFDMA）**

OFDMA是一种多用户通信机制，其只适用于802.11ax AP和802.11ax用户之间的数据帧交换。为了保证协议的兼容，在802.11ax中，管理和控制帧还是按照传统的单用户OFDM进行传输。在此之中，OFDMA和OFDM的工作切换需要进行一系列的特定帧交换，比如说我们之前提到的触发帧（[802.11ax前瞻13：触发帧（Trigger Frames）以及802.11ax的接入机制](https://zhuanlan.zhihu.com/p/77528602)），这种机制在下行OFDMA（DL-OFDMA）和上行OFDMA（UL-OFDMA）中都需要被引入。

![img](https://pic3.zhimg.com/80/v2-7db35f656255ab6d5d86f0f6e13a39da_720w.jpg)

目前让我们关注一下触发帧（Trigger Frames）机制是如何用户DL-OFDMA通信，即802.11ax AP向802.11ax终端们进行多用户下行传输。802.11ax AP首先需要通过竞争（即CSMA/CA的竞争过程），竞争胜利后，其发起一个TXOP传输时间，相当于这一段TXOP时间内，信道都是被AP所预约占据的，其余所有节点都会被延迟。如上图所示，一旦802.11ax AP获得了TXOP传输时间，AP可以给多个目标终端发送MU-RTS帧，这也是一种类型的触发帧。该MU-RTS帧有以下两个目的：

- **预约信道（Reserve the medium）**：MU-RTS采用传统的OFDM技术，在整个20MHz信道上进行传输，所有的节点（包含802.11ax节点和传统的802.11节点）都可以接收。其功能和传统的RTS是类似的。通过该MU-RTS帧中的Duration/ID字段，该帧设置其余所有节点的NAV定时器，在预约时间内（即定时器设置的时间），所有的终端都处于被动接收状态，不会主动竞争信道。NAV定时器设置的时间值用于DL-OFDMA的数据帧交换。在802.11ax AP向802.11ax终端之间进行OFDMA传输时，信道时必须保证空闲的。
- **RU分配（RU allocation）**：MU-RTS还被用来同步802.11终端的RU分配。MU-RTS由于时一种触发帧（Trigger Frames），触发帧内部包含了RU分配对应的字段。802.11ax AP通过MU-RTS作为触发帧，告诉每一个终端其被分配的时频资源（即对应的RU）。当接收到MU-RTS后，终端需要向AP反馈CTS用于确认。

当收到来自于802.11ax终端的CTS后，802.11ax AP将执行一次下行的OFDMA数据传输（如图，即传输Multi-user DL-PPDU部分）。由于AP已经将信道划分成了多个RU，当终端在自己对应的RU上接收数据，并校验成功后，其需要向AP反馈ACK。该ACK还是通过Block-ACK的形式进行反馈的。具体为当传输完成后，AP会等待SIFS时间，然后发送BAR帧（Block ACK Request）向节点请求Block-ACK，然后终端并行反馈Block-ACK。这里反馈ACK还可以采用Automatic Block-ACK（即AutoBA，Auto Block-Ack ）机制。

*Remark：我们注意到以上传输过程中，CTS和Block-ACK都是并行传输的，这里并行传输实际上还是利用到了MU传输的机制，以后我们再对这一块进行展开。*

当本轮的DL-OFDMA传输完成后，所有节点（包含AP和终端）都需要进行下一次竞争。若802.11ax AP竞争成功，那么可以执行新的一次DL-OFDMA传输。若802.11n/ac的终端竞争成功，那么会执行一次传统的OFDM传输。以此类推。

# 上行OFDMA接入机制（UL-OFDMA）

## **序言**

在介绍完802.11ax的信道接入，触发帧机制以及下行OFDMA接入机制以后，本文着重介绍上行OFDMA的接入机制（即UL-OFDMA）。在802.11ax以前，协议仅仅支持过下行的多用户接入，比如说MU-MIMO技术（在802.11ac中仅仅支持下行），为了进一步增加并发传输的能力，在802.11ax中引入了上行OFDMA技术和上行的MU-MIMO接入。在协议中上行OFDMA和上行MU-MIMO是组合出现的，其是采用同一种接入思想，区别只在于触发帧内的参数以及数据帧的物理层头部上，本文目前仅仅介绍了上行OFDMA接入机制，对于和上行MU-MIMO的结合，以后有时间再补上。

本文参考自：

- [Uplink OFDMA is not PCF](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/uplink-ofdma-is-not-pcf/)
- [Uplink Orthogonal Division Multiple Access (UL-OFDMA) in 802.11ax](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/uplink-orthogonal-division-multiple-access-ul-ofdma-in-802-11ax/)

## **上行OFDMA和PCF的区别**

在802.11ax中，UL-OFDMA的接入机制也是基于触发帧（Trigger Frames）的，这一种机制和传统802.11中的PCF机制有一些类似，但是也有点区别。

在传统的802.11标准中定义了一种PCF工作模式（Point Coordination Function），该模式是一种基于轮询的工作模式。AP执行轮询者的角色（point coordinator ），其可以在CFP时间范围内（contention-free period ），轮询客户端并执行上下行的传输。在PCF之后，802.11e修正案中为了整体解决无线网络中QoS的问题，定义了一种HCCA的方式（HCF Controlled Channel Access）。在HCCA中，AP作为具有QoS的中心调度器（Hybrid Coordinator ，HC），其在接入网络时默认具有比较高的优先级。利用该优先级，其可以将TXOP分给自身或者其他的节点，以提供一个受控的接入时间段，该时间段也被称为CAP时间（Controlled Access Phase ）。在这段时间内，QoS数据可以无需竞争，直接传输。PCF以及HCCA直至目前也很少在实际产品中实现过，有传言指该机制有可能会在将来的802.11标准中被逐步淘汰。

在802.11ax中，AP可以控制信道并调度上行OFDMA（UL-OFDMA）的接入。这一种控制和PCF或者HCCA时有区别的。基于CSMA/CA的竞争规则在UL-OFDMA中还是使用的，只有当802.11ax AP首先竞争胜利，并开启一个TXOP时间之后，其才可以占据并调度信道上其他的节点执行UL-OFDMA。在UL-OFDMA中，也会类似HCCA一样轮询终端的buffer情况以及其对应数据的QoS情况，但是和HCCA的区别在于，HCCA时主动轮询的，而802.11ax终端可以隐式的反馈其缓存的信息，无需主动轮询。另外还有一点区别在于802.11ax中引入了资源分配，即AP还需要为UL-OFDMA调度的时候，为多用户分配分配RU资源。在UL-OFDMA传输之前，AP会通过触发帧来指示每一个终端其对应的RU资源，以及对应RU资源上的传输模式（包含空间流数量，MCS速率等）。

## **上行OFDMA接入机制（UL-OFDMA）**

下面我们介绍上行OFDMA的工作机制（UL-OFDMA），其基本思想是802.11ax AP通过竞争获取信道后，发起一次TXOP传输时间，并在该时间内通过触发帧调度对应的节点进行并发的上行OFDMA传输。具体过程中UL-OFDMA比DL-OFDMA更为复杂一些，其会采用三个触发帧进行交互，每个触发帧都是AP向节点获取特定的信息反馈。UL-OFDMA中AP会要求终端反馈缓存情况（即Buffer Status Report *，*BSR）。BSR中包含了终端缓存数据的多少以及对应的QoS类别信息，这些信息会帮助AP优化RU的资源分配。AP将利用这些信息分配对应的RU，上行传输的时间，以及终端传输时对应的速率和功率。BSR信息是可以AP轮询请求的，也可以是非请求（也就是隐式反馈的）。

![img](https://pic3.zhimg.com/80/v2-3d6035599238c9845a5271c94ad7bf0e_720w.jpg)Uplink OFDMA

我们以上图作为示例简单说明下，当802.11ax竞争成功后，其首先会发送第一个触发帧（即Trigger #1），该触发帧类型是BSRP（Buffer Status Report Poll ），其用于请求终端的Buffer信息。当终端收到BSRP以后，其会反馈BSR（Buffer Status Reports）信息，就如之前我们提到的，该信息用于辅助AP进行UL-OFDMA中RU资源的分配。

当BSRP,BSR交互后，如果网络中存在传统的802.11客户端，那么AP还需要发送MU-RTS帧（即Trigger #2），该帧也是一种触发帧，并采用传统的OFDM技术进行发送，所有的终端（包含802.11ax和非802.11ax）都可以接收。非802.11ax的终端会通过接收MU-RTS帧中的Duration/ID字段，设置本地的NAV计时器，以保证在剩余UL-OFDMA时间内不会发起主动竞争。通过该MU-RTS帧中还包含了RU资源分配内容，我们需要注意，AP进行RU资源分配是在MU-RTS帧，而下一个触发帧仅仅是指示开启传输的作用。因为在AP分配RU资源后，需要得到终端的反馈，即终端会反馈CTS帧，告知AP其认可并知道了当前资源分配的情况。

当MU-RTS，CTS交换完后，AP会发送第三个触发帧（即Triiger #3），通知终端在对应的RU资源上进行上行传输。该触发帧还指示了本次上行传输的时间，需要注意的是，一次UL-OFDMA需要所有节点同时开始和同时结束（如果存在不同步的情况，那么需要在数据帧添加PAD用以填充，如图上所示）。该触发帧还包含了节点对应的功率控制信息，以便终端增加或者减少发送功率，这样有利于多终端均衡接收，并提高接收信号的质量。当上行UL-OFDMA传输完成后，AP会向终端们反馈Multi-STA Block ACK确认。另外，AP也可以逐个客户端反馈Block ACK，这在协议中是可选的。

# 非主动形式的BSR(Buffer Status)反馈

## **序言**

我们在上一篇文章叙述了上行OFDMA接入机制。该机制的基本思想就是通过AP竞争，获得TXOP传输时间后，根据各个终端的缓存情况，进行RU资源的分配，当分配完成后，进行上行OFDMA的传输。在这个过程中，缓存情况的反馈可以通过AP询问的方式主动完成（即AP发送BSRP帧向终端请求），也可以进行非主动的反馈，本文就针对于非主动反馈缓存信息BSR（Buffer Status Reports）做一个介绍。本文参考自：[Unsolicited Buffer Status Reports in 802.11ax and Wi-Fi 6](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/unsolicited-buffer-status-reports-in-802-11ax-and-wi-fi-6/)。

## **非主动的BSR反馈**

在802.11ax中，UL-OFDMA一共有三次帧交换过程，一共包含了3个触发帧

- Trigger #1：BSRP帧，用于请求终端的缓存情况
- Trigger #2：MU-RTS帧，用于兼容保护传统的802.11终端，以及分配RU资源
- Trigger #3：Basic-Trigger帧，用于触发节点进行并行的上行传输

在此叙述中，我们重点描述的是，AP采用显式的请求终端们的缓存情况（即BSRP，BSR过程）。在实际情况下，UL-OFDMA不一定具备完整的这个三个触发帧。比如，若网络中不存在传统的802.11终端，则不需要MU-RTS帧，或者为了减少开销，AP不用显式的发送BSRP帧，而是将其和其他的控制帧，数据帧或者管理帧结合进行发送。

终端是可以在未经BSRP请求的时候，直接反馈非主动的BSR帧给AP，即unsolicited buffer status report。终端可以在任意一个帧中利用以下字段发送这种非主动的BSR：

**QoS控制字段（QoS Control field）**：802.11 ax终端可以在其发送的QoS数据帧或者QoS Null帧（也就是只有Header，payload部分为空）中，利用Queue Size字段（每一个QoS类型有一个单独该字段），来反馈缓存的状态信息。另外，终端还可以用聚合帧的形式，反馈多个QoS类别，其不同的缓存情况。不同的QoS类别利用TID进行区分（Traffic identifier，TID）。Queue Size字段用来指示具体的缓存信息。

![img](https://pic1.zhimg.com/80/v2-c31d9a89ebfef8bde1546c2338fb4930_720w.jpg)BSR Control subfield

**BSR控制字段（BSR Control subfield）**：如果是在一个802.11ax的网络中，AP支持BSR控制字段的话，那么终端还可以在发送的任意帧中添加BSR控制字段内，进行BSR信息的反馈。如上图所示，802.11ax会标识不同的QoS接入类别（Access Category，AC）通过ACI High字段，并且反馈具体的Buffer信息通过Queue Size High字段（图上粉色标识为反馈单个接入类型的BSR情况）。终端会决定哪个QoS队列相对于其他队列具备更高的优先级。这一种相对QoS设置的方法并没有在协议中严格规定，从而为不同类型的终端分配优先级提供灵活性。

![img](https://pic4.zhimg.com/80/v2-2de74ad9551023694c8c703daa3b4307_720w.jpg)

一个802.11ax终端还可以报告多个QoS类别的缓存情况。这要通过上图中的ACI Bitmap，Delta TID和Queue Size All字段来反馈（图中蓝色标识为反馈多个接入类型的BSR情况）。ACI Bitmap和Delta TID标识多个QoS的接入类型，QoS Size All字段标识其对应的缓存情况。另外还有一个字段为Scaling Factor（SF），这个字段代表缩放因子，用以表示缓存的单位大小。即QoS Size High或者QoS Size All需要配合SF字段才表示真实的缓存情况。SF一共有两位，分别表示了4种缩放情况，如上图所示。这种缩放的表示方法也是为了不同终端其反馈对应流量时候，具有比较高的灵活性。

另外一点需要注意的是，在802.11协议中，协议支持同时在QoS控制字段（QoS Control field）和BSR控制字段（BSR Control subfield）中，同时反馈BSR信息，当然这也协议中是一种可选的选项，而且同时包含BSR信息时，其两个字段所包含的信息需要一致才行。

# UORA上行随机接入机制（UL-OFDMA）

## **序言**

我们说传统的802.11的接入过程为一个竞争过程，其主要目的时决出唯一的胜利者，让其传输时避免冲突。在802.11ax中，由于上行接入采用OFDMA机制，即允许多用户并行传输。我们前面所介绍的802.11ax的接入机制中，都是由AP通过获取全局的缓存情况，然后为上行和下行传输统一分配RU资源。然而，如果缓存情况未知的情况下，协议如果需要工作的话，那么就需要引入随机接入机制，该随机接入机制就是UORA（UL-OFDMA Random Access）。本文将会对UORA做一个简单介绍。在本文之前，笔者也写过一篇《[802.11ax前瞻3：上行随机接入（TF，TF-R）](https://zhuanlan.zhihu.com/p/24419115)》，里面实际上已经提到过UORA机制了，本文会在之前基础上再进一步扩展。

本文参考自：

- [What is UL-OFDMA Random Access (UORA)?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/ul-ofdma-random-access-uora/)
- [What is UL-OFDMA Random Access (UORA)? – Part 2](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/ul-ofdma-random-access-uora-part-2/)

## **UORA上行随机接入机制（UL-OFDMA Random Access）**

在802.11ax中，AP利用OFDMA技术，将信道分成多个RU，不同终端可以通过占据不同的RU，从而并行的执行多用户传输。AP可以在上行和下行传输中，站在全局的角度，进行RU资源的最优化分配。在分配过程中，AP可以通过显式请求的方式，或者被动收集的方式，获取节点的缓存情况（即BSR反馈）。AP会根据BSR信息，做全局资源的分配，当分配完成后，AP通过触发帧机制启动一次传输过程。

在802.11ax中还存在一种可选的随机接入机制（UORA），在该方法下，上行UL-OFDMA链路中RU资源的分配不是由AP决定的，而式通过随机接入机制UORA来竞争的。这种接入机制不需要终端侧实时的反馈BSR信息，对于AP不知道终端缓存情况下是有利的。

在UORA中，会使用一种频域的back-off技术（即OFDMA back-off，OBO）。在OBO中，一开始终端会选择一个随机数，然后AP会发送一个竞争类型的触发帧，其中还包含了本轮可用的RU数量。终端会将自己的随机数减去本轮的RU数量，直到减为0。如果终端利用随机数相减之后，本轮值为0的话，那么相当于竞争成功，终端将会随机选择一个RU进行占据。如果本轮相减后，没有为0，那么相当于本轮竞争失败，那么会保持这个数值，下一轮进行继续相减。

![img](https://pic2.zhimg.com/80/v2-adec2f422eea8fd4d9e41a2e620ba751_720w.jpg)

具体还有一些细节如下

- 802.11ax AP发送一个触发帧，该触发帧是用于触发一次OBO随机接入的，并且包含了可以被分配的RU数目

- 该触发帧中的User Info字段中包含了AID字段（每一个RU都有一个AID指示），该AID字段表示该RU是否可用被用来进行随机接入

- - 如果AID=0，表示该RU用于一个或者多个已关联的终端进行随机接入（如上图中，STA 1,2,4是已经关联的）
    - 如果AID=2045，表示该RU可用于一个或者多个没有被关联的终端进行随机接入（如上图中，STA 3是没有被关联的）

- 终端在初始时刻选择的随机值的范围是通过AP指定的，AP会利用OFDMA contention window (OCW) 字段（在UORA Parameter Set Information字段内）进行范围指定

- 终端会在OCW范围内选择一个随机数，然后每次OBO随机接入开始的时候，进行一次相减

- - 如果OBO计数器（OBO counter）的数值是小于本轮可用的RU的数值的话（其实这个和前面说的，OBO计数器的值减去可用的RU数目，如果小于等于0的话），那么本轮相当于竞争成功，然后会选择一个随机的RU进行占据（在其可用选择的RU范围内)
    - 如果OBO计数器是大于本轮RU的数值的话，那么相减完之后，等待下一轮OBO的开始，直到递减为0

大致的OBO的执行流程我们已经解释完了，为了更清楚一些，我们下面举个具体的例子：

首先AP发送一个触发帧（如下图 Trigger 1），该触发帧中的OCW标识了随机数的选择范围，并且标识了可以用于随机接入的RU资源（即eligible RA-RUs，可用于Random Access的RU）。在图中，我们还需要关注到终端所对应的AID，STA 1对应的AID=1，STA 2对应AID=2，STA 4对应AID=3，AID仅仅是分配给已关联的节点的，由于STA3没有关联，所以其没有被分配的AID。在该Trigger 1帧中，标识了RU 1 ~ RU 3是可以用于已关联节点进行随机接入的（即允许STA 1，2，4竞争），RU 4 ~ RU 5是可以用于未关联的节点进行随机接入（即允许STA 3竞争），RU6是已经被分配给特定节点了（即分配给了AID=3，也就是STA 4）。

当收到Trigger 1之后，终端们在OCW范围内，各自选择一个随机数进行OFDMA Back-off（OBO），如图中，STA 1的OBO counter =3，STA 2的OBO counter =5，STA 3的OBO counter =4，STA 4的OBO counter =2。其中STA 1，2，4和AP已经关联的，STA3是和AP没有关联的。

![img](https://pic3.zhimg.com/80/v2-3bbec9f2af7a2d75f5a9a8978b2c649a_720w.jpg)

由于STA 4在触发帧中已经被分配了资源（即RU 6），那么只剩STA 1和STA 2进行本轮的OBO，已经有资源的终端本轮就不需要进行OBO了，随机数保持不变。对于STA 1和STA 2而言，本轮可用竞争使用的RU数目为3个，其对应的STA 1的OBO counter = 3，STA 2的OBO counter = 5。在本轮相减后，STA 1的OBO counter = 3-3 = 0，STA 2的OBO counter = 5-3 = 2。对于STA 3而言，本轮可用的RU数目为2个（即RU 4和RU 5），所以本轮相减后，STA 3的OBO counter = 4-2 =2。

![img](https://pic1.zhimg.com/80/v2-46302b09c24a39feefbf8e716eb14b14_720w.jpg)

如上图所示，由于STA 1本轮相减后OBO counter = 0，其相当于竞争胜利，可用随机选择一个RU占据（图中即RU 2）。STA 2本轮相减后，OBO counter = 2，那么本轮竞争失败，其会保持该值，直到下一轮OBO中继续相减。STA 3本轮相减后，OBO counter = 2，那么本轮竞争也是失败的，需要进行下一轮的OBO竞争。STA 4由于一开始AP已经指定了其对应的RU（即RU 6），那么本轮其不用进行OBO，所以保持其OBO counter不变，即STA 4的OBO counter =2。然后已经竞争成功或者分配成功的终端，就在其选择的RU位置上，进行上行数据的传输，从而本轮OBO完成。

![img](https://pic2.zhimg.com/80/v2-89b427eebc632dad21e7b7d23ffcd04d_720w.jpg)

当上一轮传输完成后，AP发送了一个新的触发帧（即Trigger 2）开启一轮新的OBO。如上图所示，在该触发帧中，RU 1 ~ RU 2是用于给已关联的终端进行OBO（由于该RU的AID=0），RU 3 ~ RU 4是给未关联的终端进行OBO（由于该RU的AID=2045），RU5 ~ RU 6是被分配给了特定终端，即AID = 6（Remark：图中RU 6的AID应该为6，这里图示有误）。

当收到Trigger 2帧后，由于STA 1上一轮竞争成功，所以其需要在OCW范围内重新选择一个随机数，本轮STA 1的OBO counter = 4，其余STA 2，STA 3，STA 4都是保留上一轮OBO之后的OBO counter。



![img](https://pic1.zhimg.com/80/v2-b9286487cef9fb2ed12127491dd8282c_720w.jpg)

然后要执行本轮的OBO相减了。

我们首先关注已经关联的终端，即对于STA 1，STA 2和STA 4而言，本轮可用的RU数目（eligible RA-RUs）为2，所以相减完后，STA 1的OBO counter = 4-2 = 2，STA 2的OBO counter = 2-2 = 0，STA 4的OBO counter = 2-2 = 0。那么本轮竞争的胜利者为STA 2和STA 4，其分别随机选择了RU 1（STA 4）和RU 2（STA 2）占据，STA 1本轮没有竞争成功，所以不能进行传输。

对于未被关于的终端，即STA 3，本轮可用的RU数目为2，所以相减后，STA 3的OBO counter = 2-2 = 0，即本轮竞争成功。其选择了RU 4占据，并执行上行传输。

其余RU 5 ~ RU 6被分配给了特定节点，上图中就没有表示了。

当本轮分配好RU后，终端就会在自己对应的RU上进行上行数据的反馈。

**Remark**：在UORA的过程中，还是有可能会出现冲突的。即终端OBO counter=0之后，需要随机占据一个RU进行上行传输，若此时有两个或者两个以上节点占据了同一个RU，那么在这个一个RU上就会发生一次冲突。如果发生冲突，那么AP就无法成功收到该RU上对应的数据帧，从而不会反馈ACK。终端通过ACK来得知本轮是否传输成功，如果失败的话，那么他们会增大其OCW的大小至两倍（即double OCW范围，直到OCWmax值），这里和传统802.11的backoff中的BEB机制是类似的，用于减少冲突概率。802.11ax中的UORA实际上冲突概率还是小于传统802.11的，主要是因为其是多资源中，任意选择一个RU，这种冲突概率还是小于原来单信道模式下，所有节点进行竞争的。

# TWT节能机制（Target Wake Time）

## **序言**

我们以前介绍过关于802.11协议的节能机制，包含了PSM，APSD，PSMP以及SMPS。在802.11ax中，为了在速率提高的场景下，降低所花费的功耗，协议采用了一种新的节能机制TWT（Target Wake Time）。TWT首先是在802.11ah中被引入的，在802.11ax中又经过一些改良。本文就针对于TWT技术做一个介绍。

本文参考：

- [How Will Target Wake Time Help Mobile Devices And IoT In 802.11ax?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/how-will-target-wake-time-help-mobile-devices-and-iot-in-802-11ax/)
- [802.11ax fundamentals: Target Wake Time (TWT)](https://link.zhihu.com/?target=https%3A//theruckusroom.ruckuswireless.com/wired-wireless/technologytrends/802-11ax-fundamentals-target-wake-time-twt/)
- [CTS 164: 802.11ax Target Wake Time](https://link.zhihu.com/?target=https%3A//www.cleartosend.net/802-11ax-target-wake-time/)
- [Aruba 802.11ax White Paper](https://link.zhihu.com/?target=https%3A//www.arubanetworks.com/assets/wp/WP_802.11AX.pdf)

## **TWT节能机制简介（Target Wake Time）**

TWT定时唤醒机制（**Target Wake Time**，**TWT**）首次出现在802.11ah “Wi-Fi HaLow”标准中，其用于支持大规模物联网环境下的节能工作。随着IEEE 802.11ax标准的发展，TWT的功能获得了进一步的扩展，这使得IEEE 802.11ax标准能够更加优化设备的节能机制，提供更可靠，更节能的传输机制。在802.11ax中，TWT机制在ah的基础上，已经被修改为支持基于触发的上行链路传输，从而扩展了TWT工作的范围。

在TWT中，终端和AP之间建立了一张时间表（该时间表是终端和AP协定的），时间表是由TWT时间周期所组成的。通常终端和AP所协商的TWT时间周期包含一个或者多个beacon周期（总体时间比如几分钟，几小时，甚至高达几天）。当终端和AP所协商的时间周期到达后，终端会醒来，并等待AP发送的触发帧，并进行一次数据交换。当本次传输完成后，返回睡眠状态。每一个终端和AP都会进行独立的协商，每一个终端都具有单独的TWT时间周期。AP也可以将终端们根据设定的TWT时间周期进行分组，一次和多个终端进行连接，从而提高节能效率。

![img](https://pic1.zhimg.com/80/v2-4995014f73bcd4bc5e285733290cc274_720w.jpg)

如上图所示，User 1和User 2分别和AP协定了两个TWT时间周期，分别为TW1和TW2。终端User 1和User 2默认就工作在睡眠模式下（sleep mode），保持一个较低的功耗。当TWT时间周期到达时，AP会发送一个触发帧（Trigger）给终端，终端进而苏醒并和AP执行数据交换，当数据交换完成后，终端恢复睡眠模式。TWT和传统PSM模式的差别是，终端只在TWT时间开始的时候苏醒，而在PSM模式中，从该beacon周期开始，终端就会通过该beacon帧中的DTIM信息，观察是否AP是否由缓存自己的数据帧，如果有的话，那么就保持苏醒，直到接收完成后，才恢复到睡眠模式。在上图中，如果是传统的PSM的话，若本轮beacon帧中提示有User 1的信息，那么其不会在TW1时间内睡眠，会保持苏醒，直到数据交换完成后，才恢复睡眠。

## **TWT的三种工作模式**

TWT一共有三种工作模式，分别是：1）Individual TWT，2）Broadcast TWT，3）Opportunistic PS。

- **Individual TWT**：该模式下终端会和AP协商特定的TWT时间，该时间会被存放在AP的时间表中。终端会在特定的时间醒来并和AP进行帧交换。每一个终端仅仅直到自己和AP协商的TWT时间，不需要知道其他终端的TWT时间。Individual TWT还有多种工作模式，比如说显式工作模式。

其大致工作流程如下：

- 终端想要建立一个TWT连接，其会将自己的节能调度信息告知给AP

- AP将会分配TWT周期，并将该周期反馈给终端

- 终端会在指定的TWT周期时苏醒，并和AP进行数据帧交换

- 在本轮交换中，会分成显式和隐式两种工作模式

- - 显式工作模式

    - - 在本次数据帧交换中，AP会显式告诉终端，下一轮的TWT周期
        - 终端会在新的指定的TWT周期时苏醒，并再一次和AP进行数据帧交换

    - 隐式工作模式

    - - 在本次数据帧交换中，AP不会告诉终端，下一轮的TWT周期
        - 终端会自己计算出下一轮的TWT周期（通过在当前TWT周期上增加一个特定的时间）
        - 终端会在自己计算的TWT周期时苏醒，并再一次和AP进行数据帧交换

![img](https://pic2.zhimg.com/80/v2-ec145d8747af4677e0b9fba559b01719_720w.png)

如上图所示，终端会在苏醒的时候，首先和AP发起一个TWT建立请求，终端和AP协商一个TWT时间（即图中Negotiate a schedule），当协商完成后，终端就进入睡眠状态。在该图上，AP发送Beacon时，也会包含了公开的TWT信息，在Individual TWT工作模式下，该信息终端时不需要的。终端一直保持睡眠状态，直到TWT时间到达。终端苏醒，并接收AP的触发帧，即TWT Trigger。当终端接收到该触发后，其会和AP进行数据帧交互。于此同时，AP会告知终端下一次的TWT时间（在显式TWT中，睡眠间隔的逐次设定的），终端会在新的TWT时间上，定时苏醒，并执行数据帧交换。TWT的一次苏醒间隔有可能是小于一个beacon周期，也有可能是大于一个beacon周期的，相比于传统的PSM，APSD之类的节能方式，更加具有一般性。

![img](https://pic4.zhimg.com/80/v2-87f88e9269bcd820138de1cd9145e96b_720w.jpg)

终端和AP可以关于TWT时间周期进行协商，终端可以要求取消TWT参数，或者向AP请求特定的TWT时间。如果AP统一终端的请求，其会反馈“Accept TWT”。还有多种协商的具体参数，可以参考上图，即协议中的Table 10-19a。

- **Broadcast TWT**：广播TWT机制是一种由AP负责管理的工作机制。在该机制下，TWT时间周期是由AP宣告，通常AP会在每一个beacon帧中宣告本轮的TWT时间周期。在一些特殊的情况下，AP也会在其他的管理帧中宣告，比如Association帧，Reassociation帧或者Probe Response帧等等。我们需要注意在Broadcast TWT中，存在加入组和离开组的交互动作，终端需要向AP申请加组才可以执行Broadcast TWT，这个加组交互动作也是通过在终端和AP交换管理帧中，通过携带TWT elements完成的。当终端完成加组后，终端会按照最近接收到的TWT时间周期进行工作，此时这一类型的终端也被叫做“TWT Scheduled STA”，AP被称为“TWT Scheduling AP”。终端在TWT时间周期到达后进行苏醒，AP会发送广播的触发帧，发现哪些终端正在处于苏醒状态（加组后的终端们），并向这些终端发送数据帧，这里由于是广播通信，所以只有AP向节点发送。当AP发送完成后，终端恢复到睡眠状态，直到下一次广播TWT时间到达。通常，这种广播TWT中的时间间隔，我们也称为“TWT SP (Service Period)”。

![img](https://pic4.zhimg.com/80/v2-64658809cffd8f6a8013f41949ba8a5f_720w.png)

如上图所示，AP会在Beacon帧中，进行TWT Broadcast时间周期（即TWT SP时间）的宣告。终端们苏醒并接收该Beacon信息。然后在对应的TWT时间到达时，对应的终端们会提前苏醒，接收AP发送的TWT trigger，以及AP发送的下行数据帧，在此过程中，AP也由可能发送新的一次的TWT Broadcast时间周期（即TWT SP时间）。终端接收完成后，进入睡眠状态，并在新的TWT SP时间到达时，再次苏醒，以后以此类推。

- **Opportunistic PS**：机会PS模式和前面两种工作模式是类似的，但是没有AP和节点的协商过程。AP会在每一个Beacon内，公开宣告一个TWT时间。任意终端可以选择在这个公开TWT时间内进行苏醒，并和AP执行数据帧交换。这个交换可以是单个节点的，也可以是采用OFDMA机制进行交换。

![img](https://pic3.zhimg.com/80/v2-9c1d1b7a9da20b7c1f9de1c06b23b7be_720w.png)

如上图所示，AP在Beacon帧中宣告了一个公开的TWT时间，任意终端都可以直到该TWT时间。当该TWT公开时间到达后，AP会发送触发帧，此时苏醒的节点可以和AP进行交互，并执行数据帧的交换。在图中，由多个节点苏醒，从而触发了一次OFDMA类型的数据帧交互。

# 再论802.11ax中的节能机制

## **序言**

由于802.11ax提供了更高的传输速率，其实际功耗也会相应提高。为了节省功耗，在802.11ax协议中，引入了TWT机制，从整体上进行了一次节能优化。除了TWT以外，802.11ax中还引入了一些额外的节能机制，而且也都有明显的节能优势，本文就针对802.11ax中其他的节能机制做一个介绍。

本文参考自：

- [What is UL-OFDMA Random Access (UORA)?](https://link.zhihu.com/?target=https%3A//blog.aerohive.com/ul-ofdma-random-access-uora/)
- [Aruba 802.11ax White Paper](https://link.zhihu.com/?target=https%3A//www.arubanetworks.com/assets/wp/WP_802.11AX.pdf)

## **802.11ax中的其他节能机制**

802.11ax协议对于功耗这一面是很关注的，除了TWT以外，还包含了一些其他的特殊设计，用以节能，并延长终端的电池寿命。这些在IoT场景中都是非常重要的。

- **选择性的接收数据帧**：在传统的802.11中，节点需要接收所有的数据帧，即使该数据帧不是自己的，那么也需要接收完成后，检查MAC地址（即BSSID），判断之后才可以丢包。接收无用的数据帧也是要耗费能量的，所以在802.11ax中，节点可以在数据帧的物理层头部就判断，该帧是不是要进行接收的，如果不是需要接收的，那么就可以停止接收，从而节约能量。

在802.11ax协议中，这一点的实现是基于新的物理层头部的：

![img](https://pic1.zhimg.com/80/v2-8266721020b238110760b407355d1bcc_720w.jpg)

如上图所示，为一个802.11ax的帧结构，我们红色标出的位置HE-SIG-A是其物理层头部的一部分。在节点接收过程中，节点需要首先接收物理层头部，并完成解调，获取了相应的信息后，才可以进行数据部分的解调。在物理层头部HE-SIG-A字段中，有两个字段我们需要关注：

![img](https://pic3.zhimg.com/80/v2-93b73ddc3e5cb088d0bdbd671709a412_720w.jpg)

**Uplink/downlink字段（即UL/DL）**：终端可以通过物理层头部的UL/DL字段知道这个帧是由AP发送给节点的，还是由别的节点发送给AP的。由于当前的无线网络基本都是工作在基础架构模式，或者扩展服务集模式，总之该模式都是有中心节点AP的，任何的流量转发都需要经过AP，节点和节点直接无法直接交换数据。这种情况下，节点要不是向AP发送，要不是接收AP的数据帧。所以当一个节点通过HE-SIG-A中的UL/DL字段判断该数据帧是其他节点发送的话（即UL状态），那么其就不需要接收，反之如果是DL状态的话，那么就表示是AP发送的下行帧，所以需要接收。

*Remark：由于下行数据帧有可能是广播或者组播，也有可能是单播，所以无论下行数据帧是不是自己的，节点都需要接收。节点只有在识别到是其他上行流量时，才会停止接收。*

![img](https://pic1.zhimg.com/80/v2-0f222a9d67d2ffbf757931eee36fc21c_720w.jpg)

**BSS Color字段**：在多AP的场景下，节点仅仅会接收感兴趣的AP（比如本地关联的AP）信息，如果非感兴趣的下行信息，其是可以不接收，从而节能的。BSS Color字段也是在物理层头部HE-SIG-A中（如上图所示）。在802.11ax中，不同的AP可以通过BSS Color字段来进行识别，每一个AP都有预设的BSS Color，节点也知道不同AP对应的BSS Color。节点如果识别到非感兴趣的帧，那么会停止接收帧，并返回睡眠模式。

- **发送功率限制**：在OFDMA接入模式中，AP会通过发送Trigger帧通知不同节点，其上行传输所用的功率和MCS。一方面是为了优化接收信号的性能，即为了执行OFDMA，需要不同节点的信号到AP处近似相等，否则会出现远近效应。另外一方面，可以优化能耗，让部分节点不需要满功率发送，从而节能。

![img](https://pic1.zhimg.com/80/v2-d945bacfab0ee9c2677c04825d6a3ee0_720w.jpg)

如上图所示，在Trigger帧中的User Info Field中，UL MCS指示了节点发送时候的速率，已经UL Target RSSI指示了AP端期望接收的功率，节点根据该位计算出合适自己的发送功率。由于这种功率调节机制，节点不会一直以满功率进行传输，从而进行节能。

- **OMI模式（Operating mode indication）**：我们之前介绍过OMI模式，该模式节点和AP之间会协定传输参数，以及是否采用OFDMA形式进行传输。OMI还分成“Receive operating mode”（ROM），“Transmit operating mode”（TOM）。

![img](https://pic4.zhimg.com/80/v2-2e58fd82e3d87a87b2962f705e60337b_720w.png)

上图给出了OMI模式中可以控制的参数。通过OMI可以控制数据传输时的信道带宽，空间流数目，工作模式，OMI可以限定工作模式，对于IoT场景而言，节点可以用OMI来限定发送和接收数据时的带宽以及空间流的数目，从而实现节能的目的。

- **20MHz-only工作模式**：支持该模式的设备只能够以20MHz的方式，接入2.4GHz或者5GHz频段的AP，具体时接入主信道（即Primary Channel）。限定节点的工作带宽，可以减少大带宽信号所使用的功率，从而实现节能。

![img](https://pic1.zhimg.com/80/v2-81c02ffb80b19412961417ccda6574b0_720w.jpg)

如上图所示，我们认为这里有4个20MHz的信道，对于接入者而言，只有1个主信道（即Primary Channel）是信道3，然后还有3个从信道（secondary Channel)。当节点启用20MHz-only时，其只会在Primary 20MHz信道上工作，该工作可以是采用OFDM技术，也可以使用OFDMA技术，即占据部分的子载波。在Secondary Channel上，节点不会进行工作。

# TXOP时间设置和动态分片技术

## **序言**

我们前面已经介绍过了UL/DL-OFDMA的接入机制。下行接入是AP分配的，上行接入过程包含两种：(1) 允许竞争的UORA; (2) 无竞争，完全是由AP分配的模式。

无论在上行还是下行的OFDMA接入机制中，我们都可以简单概述成：先发送一个TF帧，AP会在这个TF帧中指定用户所占据的RU，或者指定特定的RU让用户做竞争接入。

该TF帧会启用TXOP机制，换言之，它会设置信道在一定时间内为NAV状态，从而让AP获得更高等级的调度权。然而，一个基本问题就引发了，这个TXOP时间是怎么设置的，有没有什么限定？因此，本文简单讨论了这个一个问题，以及该问题所需要引入的新技术，动态分片技术。

本文的内容是早前和群里面朋友讨论时候发现的，所以有部分内容还没有彻底研究清楚，目前仅仅是把理解到的内容做一个总结。如果有错误的地方，还请见谅。

## UL/DL-OFDMA接入过程

我们首先回顾下在802.11ax中的UL-OFDMA过程，ax中的接入过程最简化可以为三个帧，TF，UP-OFDMA PPDU，MU-BlockACK，如下图所示：

![img](https://pic1.zhimg.com/80/v2-b6d66730777b25fec8f34ec1d4655dc4_720w.jpg)

在首先发送的Trigger帧中，会开启一个TXOP时间，该时间内，所有的节点都被强制设置为NAV，即虚拟载波监听状态，无法主动的竞争信道。Trigger帧是一个触发传输的帧，其包含了节点上行传输所需要的设置信息，包含了MCS和传输功率控制，如下图所示：

![img](https://pic4.zhimg.com/80/v2-bea350aff7d90031ca73c7d5a0b729df_720w.jpg)

其中的User ID对应用户的AID，对应AID的用户会在该资源块RU上进行对应的上行传输，可以通过AID=STA来指定特定节点，也可通过AID=RA（具体可以是0，也可以是2045）来指定该RU用于随机接入。

每一个RU才还被指定了MCS以及其对应的数据流数目，即SS Allocation，以及MCS，这是802.11协议中首次引入的机制，AP可以控制节点的发送速率。

## UL/DL-OFDMA的TXOP时间设置

在802.11协议中，TXOP机制是首次在802.11e中被引入，其允许“一次竞争，多次传输”。即在节点竞争胜利后，可以持续占用信道一段时间。标准的TXOP时间是和数据包的业务优先级AC有关的，并在802.11e中是给出了默认值的，下图我们能看到在dd-wrt下面初始给出的就是默认值（不同协议版本的TXOP时间设置还不同）：

![img](https://pic3.zhimg.com/80/v2-2741ff864c97be812b9a03e06c7c9dee_720w.jpg)

在802.11后期的发展中，TXOP成为一种机制。在一些其他用处下，比如802.11ax中的OFDMA接入过程，其TXOP的时间不是按照上图的默认机制，而是和传输数据包的大小有关。

![img](https://pic4.zhimg.com/80/v2-895c86a1d290755015a2375b16e90267_720w.jpg)参考：Draft 4.3 - 9.2.5.2 Setting for single and multiple protection under enhanced distributed channel access (EDCA)

我们可以看到协议上的描述，该TXOP时间（也就是Duration时间）被设置为TF本身的时间（MU-RTS本身就是一个TF帧）加上CTS反馈，对应传输的PPDU时间以及对应的ACK。

这里我们关注，该TXOP时间的核心设置为一次对应传输的PPDU时间（即HE_TB_PPDU）。

- 下行的情况我们好理解，由于传输方是AP，所有AP知道待传输的数据包大小，并且所有的RU传输速率都是已经设定好的，所以该PPDU传输时间是一个固定值，可以设置。
- 上行情况就比较难理解一些了，因为在传统的802.11中，AP是无法知道节点上行数据包的对应情况的。传统的802.11中，AP不仅预知节点的数据包情况（比如包大小之类），同时期物理层传输参数也是无法预知的（比如传输的速率）。

那么在802.11ax中，需要引入新的机制，已知一些信息才可以确定性的设置对应传输的TXOP时间。所以协议中有两个设置：

1. 在OFDMA传输模式时，节点传输的速率实际上是AP指定的。如前面我们介绍的一样，AP初始发送的Trigger帧中就已经指定了各个RU对应的MCS和NSS，所以传输速率是确定确定的。
2. 在802.11ax中，引入了BSR，BSRP机制。AP可以通过该机制获知节点对应的Buffer情况，进而可以获知大致对应的数据包情况。

基于以上两点，AP可以设置该传输所需要的PPDU时间。这一点是与传统的802.11有较大区别的。关于具体如何设置的，笔者还没有理解完全，如果有增加后期再补充。

上面我们简要说明了，AP是可以通过BSR机制以及确定MCS传输速率的方法，来预先计算TXOP时间，让节点可以完成上行传输。然而，我们知道除了基于BSR机制的上行传输机制外，还有一种基于随机接入的上行机制，UORA。在UORA情况下有没有什么额外的问题呢？

在UORA情况下，我们假设AP设置的时间为A。而节点上行传输所需要的时间为B。那么会分两种情况：

- 如果A>B，那么实现上问题不大，仅仅是效率低下而已。在该情况下，节点传输完自己数据包之后，需要padding，充填一些冗余数据，将时间填充满A。
- 如果A<B，那么这里有一个问题了。实际是AP给出的时间不够一个数据包传输的，在传统的TXOP中也出现过这种情况（也就是TXOP最后的时间片段，是否能够传输一个数据帧）。此时，通常802.11中的做法是不传输。但是在802.11ax中，这不仅仅是一个效率问题了，而是出现这种情况，一个上行帧都无法传输出去，造成的问题比较大。

所以在802.11ax中，为了解决该问题，引出了一个新的设计即为动态帧分片技术。

## 动态帧分片（Dynamic Fragmentation）

我们重新简单介绍下动态帧分片的场景。在802.11ax中，传输都是由AP同意调度的。无论上行还是下行，AP都会为节点分配好传输所用的RU数目，传输速率MCS之类。

然而，在OFDMA传输过程时，传输时间也是由AP设定的。标准情况下，AP可以通过BSR机制，基于节点的待传数据包大小设置。然而，在UORA传输时则无法准确设置。此时有可能会出现，节点待传数据所需时间会大于TXOP时间，比如节点传输需要30ms，但是txop时间只有20ms，此时我们就需要引入动态帧分片。动态帧分片是针对于传统的静态帧分片技术做个补充，静态帧分片之前我们有过介绍，可以直接参考：[802.11协议精读25：静态帧分片（Frame Fragment）机制](https://zhuanlan.zhihu.com/p/109842637)，在LTE中类似的分割/串接技术是在RLC机制下完成的，这里做一个记录。

其实除了上述这一个角度，我们可以理解动态帧分片技术的必要性。我们还可以换一个角度理解，也就是结合帧聚合技术理解动态帧分片。

![img](https://pic3.zhimg.com/80/v2-6d78d6e905e0bc05dfff60c8ef97d662_720w.jpg)参考：Resource Management for OFDMA based NextGeneration 802.11ax WLANs

如上图所示，如果TXOP时间较长，那么多余的部分是需要padding的。这一块padding能不能传输内容呢？在最传统的802.11中是不可以的，但是在帧聚合模式下，这是一个特例。

如果物理层传输的PPDU对应的是一个A-MPDU的话，也就是一个聚合帧的话。那么在传输过程前，节点可以决定我的聚合长度是多少。此时，如果节点一直传输的TXOP时间，并且剩余所需要的Padding的时间，那么此时节点可以利用动态帧分片技术，切出来一个短帧来补充这一块需要的Padding片段，从而提升效率。从这个角度而言，动态帧分片也是非常有价值的一个设计。

在协议中，动态帧分片一共包含3个等级：

![img](https://pic2.zhimg.com/80/v2-0e0ccdbc5293158e9525254a42cb6c95_720w.jpg)参考：Draft4.3 - 26.3 Fragmentation and defragmentation

这三个实际上是针对不同场景的帧分片，比如说针对于非帧聚合模式下，以及针对于帧聚合模式下的帧分片。细节本文暂时先不展开，如果笔者有进一步理解，再补充了。

# Preamble Puncturing

## 序言

从802.11n开始引入的信道捆绑，可以将多个20MHz信道进行捆绑，从而实现更大的带宽，提供更高的传输速率。在802.11ac开始，已经可以提供160MHz带宽了。

在前段时间，华为的新路由把160MHz作为一个主要的技术优势。然而，在Wi-Fi 6（802.11ax）协议还不仅如此，相比802.11ac，Wi-Fi 6如果还仅仅支持160MHz或者仅仅是添加80MHz+80MHz带宽的模式，改进还不是很明显。

事实上，在Wi-Fi 6协议中，定义了一种新的多带宽接入方式，就是本文介绍带来Preamble Puncturing技术。基于Wi-Fi 6的核心OFDMA，Preamble Puncturing技术可以优化80MHz和160MHz的信道接入，有效提高信道捆绑的应用场景。

*注：目前该技术在协议中应该是一种可选技术，非强制。所以目前产品可能还不支持Preamble Puncturing。*

## 802.11ac中的信道捆绑

在Wi-Fi 6（802.11ax）中，引入了一个新技术Preamble Puncturing技术，目前这项技术还没有中文翻译，Puncturing的有穿刺的意思，这里实际上是删失,屏蔽的意思，类似的命名还有Punctured coding，删余编码，是一种利用冗余编码的改进技术。

Preamble Puncturing允许STA在进行80MHz或者160MHz传输时，删失部分的20MHz信道，也就是中间信道少了一部分，类似于一种Puncturing的操作。

![img](https://pic1.zhimg.com/80/v2-cab1399116ab1b93ddcfcb7958473b90_720w.jpg)参考：https://www.extremenetworks.com/extreme-networks-blog/will-802-11ax-make-80-mhz-and-160-mhz-channels-usable-in-the-enterprise/

如上图所示，通过捆绑4个20MHz的信道，如上图就是52,56,60,64，这四个信道。可以捆绑成一个80MHz信道，在802.11中，52信道作为主信道，其他信道作为次信道。

![img](https://pic3.zhimg.com/80/v2-61b9d61e5fc8571f848520ca44ba60fe_720w.jpg)参考：https://www.extremenetworks.com/extreme-networks-blog/will-802-11ax-make-80-mhz-and-160-mhz-channels-usable-in-the-enterprise/

在802.11ac中，如果某一个次信道发现是忙的状态，比如上图中的56信道。那么802.11ac的节点只可以在主信道（Primary Channel）进行20MHz带宽的传输，从而没有太高的效率。

其实在802.11ac中已经添加了动态多信道接入的机制，但是，如果是紧邻着主信道的次信道是忙的，那么会导致整体信道只能够以最小的带宽工作。传统的信道绑定都是有连续信道的要求。所以，在Wi-Fi 6中，这一点还可以进行改进。

## Preamble Puncturing技术

在Wi-Fi 6（802.11ax）中，首次引入了Preamble Puncturing技术，该技术是基于OFDMA传输技术的，能够有效优化多信道捆绑接入。

![img](https://pic3.zhimg.com/80/v2-758d94bd16fe0c66787ad98e93b79afe_720w.jpg)参考：https://www.extremenetworks.com/extreme-networks-blog/will-802-11ax-make-80-mhz-and-160-mhz-channels-usable-in-the-enterprise/

对比前面提到的802.11ac中的情况，如果信道56是忙的（如上图所示），那么在802.11ax中，AP和节点可以把56信道进行屏蔽，利用52+60+64信道进行通信。其虽然还是工作在80MHz的信道模式下，但是实际传输的时候，可以把部分信道至于Null状态，也就是空的状态，所以不会干扰到该信道上本来正在传输的节点。

在Preamble Puncturing中，主信道是不能够被屏蔽（删失），允许被屏蔽的信道是被协议规定过的，如下图所示，是协议给定的可以屏蔽的情况。

![img](https://pic3.zhimg.com/80/v2-b370c02460fa6033a8aa2f7460d4eb36_720w.jpg)参考：IEEE 802.11ax: Highly Efficient WLANs forIntelligent Information Infrastructure

我们可以参考下图，从OFDMA RU的角度来看部分信道被屏蔽的情况。前面我们提到过，Preamble Puncturing技术是基于OFDMA的，实际上就是在OFDMA传输中，将部分子载波至于Null的状态，从而实现一个20MHz被设置为Null，进而兼容该信道上本来传输的节点。

![img](https://pic4.zhimg.com/80/v2-58e7ba273fd6a1bee8bc350e460595e7_720w.jpg)参考Matlab文档: Build HE PPDU

我们可以从实际频谱图上进一步认知该技术，如下图。图中我们可以清晰的看到，在该160MHz带宽下，有一个20MHz信道被屏蔽（Puncturing），其频谱上我们可以看到有一个明显的缺失。

![img](https://pic1.zhimg.com/80/v2-5173ff01ca7260d58b6a4893f1a7a460_720w.jpg)参考Matlab文档: Build HE PPDU

然而，在最后我们还需要说明，Preamble Puncturing目前在协议中还是一个可选的技术，应该还是属于技术成本比较高的原因，产品会不会实现该技术，我们还拭目以待。

# SRP空间复用和Adaptive-CCA

## **序言**

BSS Coloring技术是802.11ax中引入，目的进一步优化空间复用（Spatial Reuse Parameter）。我们在之前的专栏中写过关于BSS Coloring技术（[Wi-Fi 6(802.11ax)解析7：BSS Coloring技术](https://zhuanlan.zhihu.com/p/76362759)）。但是关于如何基于BSS Coloring进行Spatial Reuse Parameter，我们还没有说明清楚，同时为了解释清楚，我们还要额外理解Adaptive-CCA机制。本文就关于这两个问题做一个阐述。

本文参考自：

- Future Indoor Networks: The role of Wi-Fi and its evolution - nokia bell lab。
- IEEE 802.11ax: Highly Efficient WLANs for Intelligent Information Infrastructure
- IEEE 802.11ax draft 4.3

## SRP空间复用（Spatial Reuse Parameter）

我们先介绍SRP空间复用技术。在802.11ax中，基于BSS Coloring，我们可以区分出Inter-BSS和Intra-BSS。如果现在一个Inter-BSS的节点检测到信道是忙的，但是其知道这个信道不是自己BSS正在进行传输，那么其可以认为信道是idle状态，进而继续backoff。如果backoff到0，那么其可以进行传输。

![img](https://pic2.zhimg.com/80/v2-51a3a19dde57009c42be1d6884277fc5_720w.jpg)

如上图所示，假设一个BSS的AP发送了一个SR-enable trigger frame（协议中称为SRP PPDU），代表当前的AP是允许一个SRP传输的。目前我理解的SRP仅仅支持AP上行接收的情况。AP发送完SRP TF帧后，其执行自己BSS内的一次传输，比如说一次上行传输。此时，如果一个支持SRP技术的Inter-BSS STA，也就是其他BSS Color下的节点，收到该SRP TF帧后。其会采用adaptive-CCA机制进行信道检测。如果其在adaptive-CCA的阈值下（即OBSS_PD阈值）检测信道是idle的，那么其可以继续执行backoff的操作。当backoff到0以后，其就可以执行一次数据的传输。

SR-enable的标志位应该是在PHY头部的HE-SIG-A1里面的Spatial Reuse field，这里面一共有4个field，可以设置disable SRP技术，也可以设置对应延迟或者具体的adaptive-CCA阈值等。

另外需要注意的是，这里允许传输的inter-BSS STA的数据帧大小也是有限制的。在一开始AP发送的TF帧中，实际上是包含了duration参数设置，代表其上行接收PPDU过程所需要的时间。inter-BSS需要在该Duration时间内完成SRP空间复用的传输，这里可能又会应用到动态帧分片技术了。

SRP技术实际上是一种利用捕获效应的空间复用技术，简单理解就是，如果当前AP的接收信号质量不错，不容易被干扰。那么此时就允许在该网络内，一个其他BSS的节点传输。由于本身我的信号强度够强，所以不会受到其他节点的干扰。该技术可以利用的核心机制就是adaptive-CCA机制，AP可以控制CCA的阈值，从而控制让部分节点（也就是不对自己产生干扰的节点）进行空间复用。

## Adaptive-CCA（自适应CCA）

**CCA技术是**802.11协议用来检测信道是否有数据包在传输的**物理载波监听技术**，我们在之前的文章中写过关于CCA技术（[802.11协议精读22：CCA (Clear Channel Assessment)](https://zhuanlan.zhihu.com/p/51412066)）。

802.11ax除了传统的ED_Threshold和CS_Threshold，进一步引入了OBSS_PD这个参数。

![img](https://pic4.zhimg.com/80/v2-c237d56cd451e692aa58fd0fbeef12af_720w.jpg)参考：NI的802.11ax白皮书

上面左图描述的是传统802.11的情况，其中CCA-Energy Detection对应到EDThreshold（-82 dBm），CCA-Signal Detection对应到CS_Threshold（-62 dBm）。右边描述的是802.11ax中的情况，我们可以看到起CCA_SD实际上一个新的阈值（协议命名是OBSS_PD），其高于原来的CS_Threshold（-62 dBm），这个阈值是自适应调节的，所以被称为Adaptive-CCA。该阈值的目的就是用来区分，目前CCA检测到的数据帧是不是本BSS域内的。按照SRP的规则，如果STA检测到该数据帧不是本BSS的，而且STA的信号强度是小于该Adaptive-CCA的，那么可以认为信道是idle，可以继续backoff。

我们用下图解释。*（注：由于参考了多份材料，其所用的概念命名有所区别。在下图中，CCA_SD对应的是-82dBm，也就是传统的CS_Threshold。而OBSS_SD对应的是Adaptive-CCA的阈值，也就是上图右的CCA-SD，协议的命名是OBSS_PD）*

![img](https://pic2.zhimg.com/80/v2-8641cfd6003f0f81070b916aafcab449_720w.jpg)

该图是描述一个inter-bss的STA如何做判断的。如上图，一开始STA会判断是否有数据帧在传输（也就是和CCA_SD比较）。如果大于，那么就意味着有数据在传输，那么说明信道忙，并且要开始接收数据，接收是从物理层头部PLCP开始的，这是一个独立的片段。

- 如果PLCP失败，那么等待EIFS时间（这里笔者不是很认同上图，如果PLCP解调失败，那么EIFS等待完的结果实际上是挂起到当前数据帧的传输结束，而不仅仅是等待EIFS时间，这点记录下）。

- 如果PLCP接收成功，那么判断该数据帧是不是同一个BSS的（在PLCP中会标识，该数据帧是哪一个BSS的，标识方法是BSS Coloring）。

- - 如果是相同的BSS，那么意味着该数据帧节点需要接收，所以反馈信道忙，并进入接收状态。

    - 如果是不同BSS，那么该节点需要与OBSS_SD的阈值比较，该阈值就是我们这里所说的Adaptive-CCA阈值（按协议应该是OBSS_PD阈值）。

    - - 如果信号强度大于OBSS_SD阈值，那么意味着inter-BSS的节点和当前接收上行传输的AP干扰比较大。如果该节点传输，会影响AP的上行接收，所以无法执行SRP传输。因此信道还是busy的状态，不能够backoff。
        - 如果信号强度小于OBSS_SD阈值，那么意味着inter-BSS的节点不会干扰到AP的上行，其检测结果为idle，从而该节点可以执行backoff（这里竞争是为了多个inter-BSS的STA，同时检测到信道是idle的，从而发生冲突）。当节点backoff到0以后，那么可以进行传输。

在协议中，该OBSS_SD（本文命名有点杂，对应协议是OBSS_PD）是一个范围值，是AP根据网络情况自适应调节的，并且在Spatial Reuse field给出。

![img](https://pic2.zhimg.com/80/v2-d3df3cd947965e5a9a66400a9e803509_720w.jpg)

如上图所示，该范围是在-62dBm和-82dBm之间，也就是对应传统的ED_Threshold和CSThreshold之间。该图上的21 dBm描述的参考的发送功率，TXPWR_Ref。

综上我们阐述了802.11ax中的SRP技术，本节中的字母定义有点乱，还请见谅。

# QTP（Quiet Time Period）和QP

## **序言**

QTP（Quiet Time Period）是802.11ax中新引入的技术，而QP（Quiet Period）是802.11协议初始就有的一个技术，两者都是在802.11协议中比较冷门的一个技术。在笔者的认知中，这两个技术最大的用处就是为了兼容，毕竟是商业协议，各种场景都需要考虑到。所以本文仅仅做一个笔记记录下。

## 信道静默QP（Quiet Period）

这里Quiet Period我们翻译成信道静默，这是参考802.11权威指南的翻译。我们知道802.11协议是工作在2.4GHz和5GHz频段的，这个频段在很多国家是有雷达设备也工作的。为了避免对雷达的干扰，802.11协议中采用了TPC和DFS两项技术。然而，究竟周边有没有雷达设备呢，这个时候实际上要802.11设备做一个探测的。

但是由于无线网络传输本身会影响探测结果。此时，我们就需要把整个网络静默一段时间，也就是不允许任何的数据包传输，让网络去检测周围有没有雷达信号。这个机制就是QP（Quite Period）机制。

QP时间是一个周期的时间，该周期间隔是通过Beacon或者Probe Response中的Quiet Element元素进行安排的。而QP时间的保护是通过NAV机制来实现的，这里是通过Quiet Element来实现NAV，有点类似于CFP时间可以由CF Parameter Set里面元素设置的一样。

![img](https://pic2.zhimg.com/80/v2-df6ef2432bb63c077d4ec1572b8599a1_720w.png)

Quiet Element的结构如上图所示，其中Quiet Period是静默期，代表了QP时间的间隔（单位为几个Beacon间隔，也就是TBTT时间），Quiet Duration为静默持续的Duration时间。Quiet Offset是一个时间偏移，一般而言，Quiet时间是紧接着Beacon开始的，停止时间就是Quiet Duration，然而该时间也可以向后延迟，那么延迟的时间就是Quiet offset。

## 静默时间QTP（Quiet Time Period）

Quiet Time Period（QTP）我们目前就直译成静默时间。该机制是802.11ax中新引入的，由于802.11ax需要兼容过往的工作模式，其中最主要的就是ad-hoc模式，其他还有相关的P2P，TLS模式等，这一系列通信模式我们成为STA-STA直接通信。STA-STA通信会对密集网络场景的性能造成影响。因此，为了避免STA-STA通信对密集网络的性能影响，我们需要做一个时间调度，所以才有了QTP这个设计。

QTP是一个兼容类型的设计，其是通过设置了一个NAV保护时间，该保护时间内，基础架构模式的节点都不会通信，把信道让给STA-STA类型的节点，实际上就是进行了时间分配，关于STA-STA模式和基础架构模式下的节点。

![img](https://pic3.zhimg.com/80/v2-9cae957acc5324833310b03918591b86_720w.jpg)参考：IEEE 802.11-16/1459r0

如上图所示，这里有三个帧，QTP Request，QTP Response以及QTP Setup。在802.11ax中，网络的控制基本是掌握在AP手里的，这点是802.11ax的一个特点。因此，待传输的P2P节点首先需要向AP发送QTP Request帧，申请QTP传输。如果AP同意的话，那么AP会向其反馈QTP Response，与此同时，该AP还会向其余所有节点广播QTP Setup，这些节点收到QTP Setup后，实际上就被设置为了NAV状态。此时，收到QTP Response的节点知道信道已经被预约好了，可以直接进行一次P2P传输了，传输完成后，P2P的接收节点会反馈ACK。

这里的QTP Setup可以按照802.11ax的帧格式发送，如下图

![img](https://pic3.zhimg.com/80/v2-81473ef0bee6d98caa750043b0d26422_720w.jpg)

此时，由于传统的802.11节点无法识别该802.11ax的帧（HE PPDU），所以这些传统的节点不会被置为NAV状态，只有802.11ax的节点才会。

如果是按照传统的802.11帧的形式发送QTP Setup，那么所有的节点都会在QTP时间被设置为NAV状态，如下图：

![img](https://pic1.zhimg.com/80/v2-0fa5064049fe0afffda1ea9c18e9bd0c_720w.jpg)

以上，我们简单阐述了QTP技术的应用场景。主要是协议目前已经很复杂了，概念较多，尤其是QTP和QP这两个概念，因此做一个笔记记录下。

# 802.11ax中MU-MIMO和OFDMA的区别

## **序言**

笔者将自己对于802.11ax中的MU-MIMO和OFDMA的区别做了一个简单的总结。因为很多非通信技术专业的童鞋，关于这两项技术不是很清楚区别。同时，这两项技术在MAC层的接入机制上有很高的类似性，两种物理层的接入机制是基于同一个框架的。所以这里笔者大致按照自己的理解，把笔记做了一下。

OFDMA和MU-MIMO是两种不同的技术，二者独立存在，并可以叠加使用。这两者的共性是，这两种技术在同一个时间都可以让多个用户同时接入。除此之外，(目前在NOMA中采用被采用的) SIC（串行干扰消除）与CDMA也可以做到这一点。以下分开讨论下。

再次说明，本文仅仅作为个人笔记，并不是打算梳理清楚MIMO相关概念，所以中间有部分可能解释有不妥的地方，如果有不对的地方，还请见谅。

## OFDMA

![img](https://pic3.zhimg.com/80/v2-827a6e2699b54c1e6c6acb0b17ba9f1e_720w.jpg)OFDMA RU示意图

OFDMA是基于OFDM的物理层技术，其将频谱资源分割成多个频谱资源块，分配给多个节点同时使用。其没有多天线的要求，在单天线条件下，也可以做到OFDMA。

OFDMA中的资源是时频资源，可以理解成横轴是时间轴，纵轴是频谱轴，然后按照网格划分成多个资源片段，在Wi-Fi中称为RU，LTE里面称为RB。资源片段会根据需求被分配到各个用户上。这里要区分上下行，如果是下行的话，那么AP或者eNodeB（LTE里面基站概念），直接发送一个数据帧即可，当然，该帧内部的资源映射关系是提前告知用户的，Wi-Fi帧中是通过Trigger帧告知，LTE是在RLC子层建立连接的时候告知，然后节点对应解调的。用户实际上可以解调所有的信息，即全部片段都可以解调，然后根据映射关系，选取自己的信息即可。安全性是通过数据层的加密完成的。

上行的话，Wi-Fi是允许上行的OFDMA，LTE上行不采用OFDMA，采用的是SC-FDMA。OFDM有一个问题就是PAPR，峰均比，也就是所有的子载波由于是周期成倍数关系的，所以如果所有子载波都是加载相同数据的时候，出来的峰值就是所有子载波上单位峰值的叠加。如果大家都是1，那么这个1冲到很高，如果大家都是0，那么就是0，换言之是0（打个比方，虽然传输的时候是用双极性的，所以不会有0的存在）。（这样峰值和均值的区间很大，就会对放大器的工作区有要求)

- LTE子载波多，一共2048个，所以峰均比空间大，最后就没有采用OFDMA做上行。LTE的上行是SC-FDMA。主要原因是PAPR高，但是不是技术不可行，是相应实现时候，PA需要更高的成本，以及会产生更高的功耗。
- Wi-Fi子载波最多256个（上述都是在20MHz信道带宽下），所以峰均比还可以承受，所以上行可以允许OFDMA。

目前OFDMA在Wi-Fi 6里面是一次性添加了上行和下行，下行在整个接入过程中很简单，AP抢到的信道，然后发送即可。上行接入的时候包含了有两种接入方式，一共是基于竞争的（就是UORA），一种是基于非竞争的，也就是基于BSR的，缓存情况，根据节点的缓存情况，AP进行资源分配，然后告知。其实搞两种接入方式也是和LTE类似的，LTE中在PRACH信道上也有两种接入模式，基于竞争和基于非竞争，基于竞争的是随机选择竞争序列（也就是竞争所采用的Code），而非竞争的则是通过eNodeB指定。这点上LTE和WiFi 6在框架上是类似的。

在这里还需要注意的一个是，OFDMA和CDMA一样，存在远近效应。其含义是接收方，也就是AP，在接收信号的时候，需要所有节点发送到AP处的信号功率，近似相等。如果功率差异过大，那么就不能够很好解调了。（功率差异大就是用SIC技术，而不是OFDMA技术了）。

![img](https://pic4.zhimg.com/80/v2-0371d126d14449994729998d677f81df_720w.jpg)

所以在上行发送的时候，触发帧实际上包含了三个重要信息，1）资源分配，2）发送速率指定，3）功率指定。通过以上技术，在OFDMA的场景下，Wi-Fi基本和LTE能够做到的差不多了，精准的频谱资源分配。

## MU-MIMO

MU-MIMO是基于多天线技术的，这个技术的物理层是多天线技术。多天线可以实现多种技术，不仅仅是MU-MIMO，如下图所示：

![img](https://pic2.zhimg.com/80/v2-7b82d624afda64bdea78879ad6778095_720w.jpg)参考：aruba的802.11ax白皮书

上图中，我们可以看到多天线可以做CSD，TxBF，STBC，SDM，MRC等等，这些技术全部在802.11协议中都有应用。这里细节很多，本文不展开了，相关技术我可能会在该技术用到地方再提到。

MU-MIMO的实现是结合波束成型的，波束成型有两种实现方式，一种是智能天线波束成型，一种是基于全向天线的波束成型。在CWNA一书中，已经给出了其定义。

具体描述如原文：

![img](https://pic4.zhimg.com/80/v2-64e5de8582d187bdf1c3e1eff95959bf_720w.jpg)

翻译版：

![img](https://pic2.zhimg.com/80/v2-81e50acb85a337098fd811a4501e81fd_720w.jpg)

MIMO包含2D-MIMO和3D-MIMO两种，目前5G NR已经有3D-MIMO的波束了，Wi-Fi 6里面还停留在2D-MIMO上。打个比方就是说利用定向天线，天线辐射可以参考手电筒打光，波束的概念就是从光束来的，手电筒打的光就是定向的光束，同理，定向天线辐射的信号就是定向的波束。如果发送和接收方同时用两个手电筒打信号，那么一次性就可以传递更多的信息，这种多天线的发送方式就是MIMO。

MIMO和全双工存在区别，MIMO模式下两根天线，只能够同时处于发送，或者接收状态。而全双工可以一根天线是发送状态，一根是接收状态。（PS：全双工也可以通过EBD之类的设备，一根天线实现全双工，这里不加以讨论）

MIMO的概念比较多，是针对多根天线而言的，主要是两个概念分集和复用。如果有多个通路的时候，比如有两个通路。我们可以简单理解如下，如果两个通路传同一个信息，那么就是分集。如果两个通路传两个不同的信息，那么就是复用。在802.11协议的相关培训书籍里面，这个概念实际上给的是比较粗的解释，MIMO 实际上是分集和复用结合的技术，波束成型是发送分集。

在我们常用的路由器中都是配备了全向天线。利用全向天线实现定向天线实际上是基于干涉抵消的机制来做的，通过预编码，让数据流通过两根天线具有一定的相位差发送出去，达到接收方接收功率叠加，或者干扰方接收功率抵消的效果。

预编码可以通过数字编码的形式添加相位差，目前Wi-Fi就是采用这一种。移动通信（比如LTE或者5G NR）里面方式多了一种是电相位差，是通过基带连接到RF这一段的线路上，通过线路的长度差异来做相位差。总之，有了相位差就可以做波束成型了。2维平面上的干涉抵消就是2D-MIMO，3维平面就是3D-MIMO了。

然后需要回顾下，基于MIMO技术，可以做到多发多收。基本的MIMO就是，一个发送者有两根天线，一个接受者有两根天线，发送者一次用两根天线发，接受者用两根天线收，然后两倍传输速率，这个就是802.11n时代做的MIMO技术。

![img](https://pic3.zhimg.com/80/v2-ed1f8f95958911e0579449cd1906e21e_720w.jpg)WRT54M路由

多天线不等于MIMO，在802.11g时代，就有多天线了，Cisco当时的经典路由WRT54M就是多天线的，但是这个不是做MIMO，是做天线选择（实际上也是分集的一种），一次只用一根天线发，但是有可能用左天线，有可能用右天线，也有可能交替（技术上这属于发送分集）。在DD-WRT下我们还可以看到这个选项，如下图

![img](https://pic3.zhimg.com/80/v2-793005cf8a37fcc70c933f571ca2443e_720w.jpg)DD-WRT的配置界面

MIMO是两根天线同时发，同时在物理上两根天线需要差半个波长距离，另外两根天线不能够发送相同的信息，要编码之后，否则就会存在默认的干涉效果，对通信无意义。经过预编码后，两根天线才可以同时发送（编码后的对应两根天线上的数据不同）。

LTE，5G NR和Wi-Fi相比，在波束这一块思想差不多，不过具体实现的时候取目标函数会有点区别，前两者可能偏向波束追踪，也就是目标接收功率最大化，Wi-Fi里面是偏向对其他人的干扰最小化（比如interference nulling技术），用干扰抵消的原理来说明，就是前两者偏向干涉叠加最大，后者偏向干涉抵消最强，这会影响一些预编码结构的设计。所以Wi-Fi强调的是多个波束覆盖到多个用户，各个用户之间不会进行干扰。

在Wi-Fi中，802.11ac仅仅支持下行的MU-MIMO传输。到802.11ax，也就是wi-fi 6以后才支持上行的MU-MIMO传输。

## MAC层部分（MU-MIMO和OFDMA）

在MAC层协议部分，MU-MIMO的传输和OFDMA传输的过程很像，都是一开始一个TF帧，然后开始一个传输。两个可以叠加，不过先导过程不一样。

- OFDMA过程的先导是BSRP,BSR过程，就是问缓存情况，然后做OFDMA资源分配。如果没有先导过程的话就是UORA，基于随机接入的竞争模式。协议中还有一个BQRP，类似于BSRP但是关注的参数不一样，这也是用来做资源分配预判的，这里就不展开了。
- MU-MIMO的先导过程是NDPA,NDP,beamforming reporting，这样的过程是一个测量过程，测量每一个节点的信道状态，也就是CSI，然后基于该CSI做预编码（协议里面要旋转矩阵）。

同时我们需要注意的是，这两个先导机制都包含了主动模式和被动模式（也就是隐式反馈的模式），这也说明了两者在MAC层协议上的类似性。

![img](https://pic1.zhimg.com/80/v2-a6f2cf307f37c45d32e1c538306c12ec_720w.jpg)NDP过程

另外这两个先导的过程，NDP和BSR过程也可以结合起来一起使用，如下图

![img](https://pic1.zhimg.com/80/v2-7ba685ee6b0c0c4bb624693650913d18_720w.jpg)参考：Aruba的802.11ax白皮书

有了测量矩阵才可以做编码，所以MI-MIMO会做这样的过程。协议没有给定BSR，NDP这样的测量过程和传输过程的关系，所以不是每一次传输都需要测量一次，可选，也可不选。测量周期也是给开发商自己搞定的。关于NDP过程而言，其实与应用场景有关，Wi-Fi大概是100ms左右就可以了，这个从理论上有一个概念，叫做海森堡时间。

![img](https://pic2.zhimg.com/80/v2-9b6638ec2f970435122174f0bdcf87a9_720w.jpg)参考：802.11ac: A Survival Guide

然后有了BSP和NDP过程后，就可以执行一次传输了。这个传输过程内，可以做MU-MIMO，可以做OFDMA，也可以做OFDMA+MU-MIMO，协议不规定，给开发商自己折腾的。但是前提是要先导过程，有获取了足够信息。

还有点需要注意的是，目前Wi-Fi协议都是任意长数据帧的，不像LTE，5G NR一样，始终是按照一个小资源片的时间封帧，也就是其帧，半帧之类大小都是固定的，所以没有帧长度不等的问题。

Wi-Fi中只有一个最大帧传输时间和最大帧长度的限制，这个大小随着协议演进过程中是有变化的。下图所示是截至802.11ac目前的最大值：

![img](https://pic1.zhimg.com/80/v2-91f9ce48c6ffd8c1174b1608636a92a0_720w.jpg)参考：802.11-2016版本

在Wi-Fi中，由于是多用户同时传输，无论上行还是下行，都是存在帧长度不等的。一个基本思想是补，补随机的东西弄到长度相等。在802.11ac里面，由于只有下行发送，所以发送时间是按照最长帧来的，其他短的不够就补。在802.11ax里面，由于引入上行传输，那么传输时间是AP猜的，根据BSR之类的信息来猜的，所以这段时间有可能会长，长就补0，如果短的话，那么引入了一个新概念，就是动态帧切片，把帧给切短了，然后发送。以上这点在动态帧切换中我们已经讨论过了，所以这里就不展开了。

## 结语

以上，笔者大致把802.11ax中相关MU-MIMO和OFDMA的技术内容做一个技术笔记，本文仅仅偏向于技术笔记，以为很多物理层相关技术，尤其是MIMO的包含很多定义明确的概念，但是本文并没有考究。故本文如果有不对的地方，还请见谅。

# DCM双载波调制技术

## 序言

在802.11ax中，为了提升远距离的Wi-Fi传输能力，协议中引入了一种新的调制方式DCM。DCM（Dual Carrier Modulation），双载波调制技术。该技术最初是在UWB的MB-OFDM版本中引入的，在802.11协议中，首次采用DCM的是802.11ad技术。在802.11ax中，同样也采用了DCM提升传输距离。本文就简单对该技术做一个笔记。

## DCM技术（Dual Carrier Modulation）

DCM双载波调制，其实含义很简单，就是把一个信号在同时在两个子载波上重复进行传输，这个类似于一种基于子载波的频率分集技术了，同时两个子载波的距离要足够远，这样可以增加分集的效果。

在Trigger帧中，我们可以看到DCM的选项（图中字段按协议而言是UL_DCM选项），具体位置在在触发帧中的user information字段。

![img](https://pic2.zhimg.com/80/v2-4dd70d033cde19f28b3cc7f6173b4bc9_720w.jpg)

上图所示，基于TF帧分分配RU资源的时候，还可以指定是不是采用DCM传输机制。在802.11ax中，DCM机制是和OFDMA技术结合使用的。如果采用DCM，那么意味着信号的速率会降低，但是会有更远的传输距离。

DCM的发送是将数据分组后，映射到星座图就行了（实际上是两张星座映射1个数据），解调的时候，通常采用LLR（Log Likelihood Ratio）之类的技术，将两个星座结合起来解调。

![img](https://pic3.zhimg.com/80/v2-d612504b7878a34901b84abae49341ae_720w.jpg)参考：IEEE 802.11-15/1068r1

如上图，一个802.11的数据流在经过交织，准备进行调制的时候，此时用DCM进行调制。简单而言，就是将一个信号重复在两个子载波，Subcarrier K和Subcarrier K+N/2上进行，其中K为子载波序号，N为子载波总数。

在802.11ax中的DCM具体规则，笔者在协议中没有理解清楚，依照MB-OFDM的相关资料简单记录下，如下图

![img](https://pic4.zhimg.com/80/v2-e2ee9d398e95ec3d16515c693828502b_720w.jpg)参考：https://www.slideshare.net/ghulam_shabbir/signal-system

上图是以DCM-QPSK的角度，描述一次DCM编码机制。首先现将数据（200bits）分成50个组，每一个组4个bits。

![img](https://pic2.zhimg.com/80/v2-0ffcec7452070ea1ce648546189fa4ad_720w.jpg)

然后把这个分组后的4位bits映射到一个“4-维星座图上”，实际上就是两张星座图。映射之后添加上归一化的参数，然后发送即可。具体映射如下图：

![img](https://pic1.zhimg.com/80/v2-e9199cdf5975197fb09c42bada29f648_720w.jpg)

通过映射关系，一组4个bits的数据0000，被映射到两张星座图上，分别为[-3,-3]和[1,1]，前面是对应I坐标，后面对应是Q坐标。我们可以注意到两张星座图上的映射点位置是不同的，是因为DCM还是存在一个特定的映射关系，而不是直接复制的。对应下图我们可以清楚看到，星座点下面是描述的4个bits的数据，我们标出来的红色是0000，这个数据在第一张星座图上是第四象限，第二张星座图上是第一象限里面。

![img](https://pic3.zhimg.com/80/v2-4126523e55c5e1c0e19f48036c600ee6_720w.jpg)

简单而言，DCM就是把一个数据映射之后，重复发送即可。DCM的解调本文不讨论，主要是以LLR，由于解调已知映射的规则，同时两个子载波实际上是独立的，所以可以直接叠加，然后经过LLR判决即可。不过这一点好像通过星座图来描述不好描述，所以就不展开了。

在802.11协议中，只有三种调制机制支持DCM，分别是BPSK，QPSK和16-QAM。同时DCM也仅仅支持单流和双流两种模式。

![img](https://pic1.zhimg.com/80/v2-ac91c474950d9445a0894b0b698204a8_720w.jpg)

在802.11中的映射规则大致如下：

![img](https://pic4.zhimg.com/80/v2-56ded4fd74a7724037a67796e37e96b7_720w.jpg)

以上，我们简单对DCM做一个笔记记录下，如果有不对的地方，还请见谅。

