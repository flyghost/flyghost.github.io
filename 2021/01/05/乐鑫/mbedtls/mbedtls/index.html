<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="referrer" content="origin">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>mbedtls</title>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/LongCang.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/Monda.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/NotoSansSC.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/Playball.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/PTMono.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/RobotoSlab.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/Rosario.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/UbuntuMono.css">

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/post.css">
    
        <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/normal.css">
    

    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/jquery-3.4.1.min.js"></script>

</head>
<body>
    <a id="cover"></a>
    <div id="header">
    <div class="header">
        <div class="vertical">
            <div class="inner">
                <h1 class="header-subtitle">mbedtls</h1>
                <div class="header-subinfo">
                    <p class="article-info-text">
                        <span>
                            <i class="iconfont icon-time"></i> 发表时间：2021-01-05
                        </span>
                        
                            <span id="/2021/01/05/乐鑫/mbedtls/mbedtls/" class="leancloud_visitors" data-flag-title="mbedtls">
                                <i class="iconfont icon-browse"></i> 阅读：<sapn class="leancloud-visitors-count"></span>
                            </span>
                        
                        <span>
                            <i class="iconfont icon-interactive"></i> 评论：<span class="valine-comment-count" data-xid="/2021/01/05/乐鑫/mbedtls/mbedtls/"></span>
                        </span>  
                    </p>                 
                </div>
            </div>
        </div>
        <canvas id="articleHeaderCanvas"></canvas>
    </div>
</div>
    <div id="container">
    <div id="content">
        <div id="article">
    <div class="toc"></div>
    <div class="article-body">
        <h1 id="一、伪随机数生成器（ctr-drbg）的配置与使用"><a href="#一、伪随机数生成器（ctr-drbg）的配置与使用" class="headerlink" title="一、伪随机数生成器（ctr_drbg）的配置与使用"></a>一、伪随机数生成器（ctr_drbg）的配置与使用</h1><h2 id="真随机数和伪随机数"><a href="#真随机数和伪随机数" class="headerlink" title="真随机数和伪随机数"></a>真随机数和伪随机数</h2><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>随机数在安全技术中通常被用于生成随机序列（eg. 秘钥），对于一个随机数的生成而言，是否真正的做到“随机”是最重要的。</p>
<p>真随机数通常来源于硬件随机数生成器，每次生成的随机数都是真正的随机数，但是因为物理因素，<strong>生成的时间较慢</strong>。比如STM32中提供的RNG硬件外设。</p>
<p>伪随机数通常来源于某个生成算法，每次生成的随机数虽然是随机的，但还是遵循生成算法的规则，优点是<strong>生成速度较快</strong>。比如C库中提供的rand函数，在相同的种子下，其生成的随机数序列相同，所以称之为伪随机数。</p>
<p>所以一般情况下，有一种比较巧妙的办法：将两者结合起来，<strong>先使用真随机数生成种子，然后使用伪随机数生成算法</strong>，这样既保证了生成速度，又保证了生成的序列是真正的随机数。</p>
<p>对应到 mbedtls 中，将产生真随机数的模块称为真随机数生成器（TRNG），将    产生伪随机数的模块称为伪随机数发生器（PRNG）（也叫做确定性随机数生成器，DRBG），其中伪随机数所使用的种子称为<strong>熵源（熵池）</strong>。</p>
<h3 id="伪随机数生成算法"><a href="#伪随机数生成算法" class="headerlink" title="伪随机数生成算法"></a>伪随机数生成算法</h3><p>NIST SP 800-90A规范中描述了三种产生伪随机数的算法：</p>
<ul>
<li>Hash_DRBG：使用单向散列算法作为伪随机数生成的基础算法；</li>
<li>HMAC_DRBG：使用消息认证码算法作为随机数生成的基础算法；</li>
<li>CRT_DRBG：使用分组密码算法的计数器模式作为随机数生成的基础算法（重点）。</li>
</ul>
<p>CRT_DRBG 可以理解为一个AES加密过程，加密结果为期望随机数序列。</p>
<h2 id="自定义熵源接口"><a href="#自定义熵源接口" class="headerlink" title="自定义熵源接口"></a>自定义熵源接口</h2><p>mbedtls中可以通过开启宏定义 <strong>MBEDTLS_ENTROPY_HARDWARE_ALT</strong> 来开启熵源接口，用户可以在熵源接口中实现自己的硬件获取真随机数代码。</p>
<h3 id="开启宏定义"><a href="#开启宏定义" class="headerlink" title="开启宏定义"></a>开启宏定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义此宏，以使mbed TLS使用您自己的硬件熵收集器实现。</span></span><br><span class="line"><span class="comment">// 函数原型必须为 int mbedtls_hardware_poll( void *data, unsigned char *output, size_t len, size_t *olen );</span></span><br><span class="line"><span class="comment">// 并接受NULL作为第一个参数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br></pre></td></tr></table></figure>
<h3 id="自定义实现mbedtls-hardware-poll函数"><a href="#自定义实现mbedtls-hardware-poll函数" class="headerlink" title="自定义实现mbedtls_hardware_poll函数"></a>自定义实现mbedtls_hardware_poll函数</h3><p>创建一个新文件用于存放我们编写的该函数实现，这里我创建文件<code>entropy_hardware_alt.c</code>。</p>
<p>实现时需要包含头文件<code>entropy_poll.h</code>，其中包含了 mbedtls_hardware_poll() 函数的原型定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_ENTROPY_HARDWARE_ALT)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hardware_poll</span><span class="params">( <span class="keyword">void</span> *data, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> len, <span class="keyword">size_t</span> *olen )</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里以stm32为例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy_poll.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;main.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32l4xx_hal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy_poll.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> RNG_HandleTypeDef hrng;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hardware_poll</span><span class="params">( <span class="keyword">void</span> *Data, <span class="keyword">unsigned</span> <span class="keyword">char</span> *Output, <span class="keyword">size_t</span> Len, <span class="keyword">size_t</span> *oLen )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> index;</span><br><span class="line">    <span class="keyword">uint32_t</span> randomValue;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; Len/<span class="number">4</span>; index++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (HAL_RNG_GenerateRandomNumber(&amp;hrng, &amp;randomValue) == HAL_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            *oLen += <span class="number">4</span>;</span><br><span class="line">            <span class="built_in">memset</span>(&amp;(Output[index * <span class="number">4</span>]), (<span class="keyword">int</span>)randomValue, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Error_Handler();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/*MBEDTLS_ENTROPY_HARDWARE_ALT*/</span></span></span><br></pre></td></tr></table></figure>
<h2 id="使用mbedtls-CTR-DRBG接口生成随机数"><a href="#使用mbedtls-CTR-DRBG接口生成随机数" class="headerlink" title="使用mbedtls CTR_DRBG接口生成随机数"></a>使用mbedtls CTR_DRBG接口生成随机数</h2><h3 id="宏配置"><a href="#宏配置" class="headerlink" title="宏配置"></a>宏配置</h3><p>使用mbedtls随机数生成功能需要开启以下宏：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong><br>定义此宏，以防止加在默认的熵函数<br>基于mbedtls_timing_hardclock和基于HAVEGE的轮询功能。</td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_FORCE_SHA256</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>将AES表存储在ROM中（节约内存空间）</td>
</tr>
</tbody></table>
<p>根据以上代码，编写针对本实验的配置文件<code>mbedtls_config_ctr_drbg.h</code>：</p>
<p>cmakefile.txt中添加<code>CPPFLAGS += -DMBEDTLS_CONFIG_FILE=&#39;&quot;mbedtls/mbedtls_config_ctr_drbg.h&quot;&#39;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_CTR_DRBG_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_CTR_DRBG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT						<span class="comment">// 使用自己的硬件熵</span></span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES		// 不定义此宏，系统将调用默认的熵函数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY							<span class="comment">// 不使用系统内置熵源</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C														<span class="comment">// 使用AES算法</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES									<span class="comment">// 将aes表存储在rom中</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C											<span class="comment">// 使能随机数模块</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C												<span class="comment">// 使能熵源模块</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C												<span class="comment">// 使能sha算法</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_CTR_DRBG_H_ */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="API说明"><a href="#API说明" class="headerlink" title="API说明"></a>API说明</h3><h4 id="熵相关"><a href="#熵相关" class="headerlink" title="熵相关"></a>熵相关</h4><p>① 初始化熵</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_entropy_init</span><span class="params">( mbedtls_entropy_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 释放熵</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_entropy_free</span><span class="params">( mbedtls_entropy_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 错误码说明（用于根据返回值判定错误）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_SOURCE_FAILED                 -0x003C  <span class="comment">/**&lt; Critical entropy source failure. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_MAX_SOURCES                   -0x003E  <span class="comment">/**&lt; No more sources can be added. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_NO_SOURCES_DEFINED            -0x0040  <span class="comment">/**&lt; No sources have been added to poll. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_NO_STRONG_SOURCE              -0x003D  <span class="comment">/**&lt; No strong sources have been added to poll. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_FILE_IO_ERROR                 -0x003F  <span class="comment">/**&lt; Read/write error in file. */</span></span></span><br></pre></td></tr></table></figure>
<h4 id="crt-drbg相关"><a href="#crt-drbg相关" class="headerlink" title="crt_drbg相关"></a>crt_drbg相关</h4><p>① 初始化ctr_drbg随机数种子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ctr_drbg_init</span><span class="params">( mbedtls_ctr_drbg_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 根据熵生成随机数种子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief               This function seeds and sets up the CTR_DRBG</span></span><br><span class="line"><span class="comment"> *                      entropy source for future reseeds.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note Personalization data can be provided in addition to the more generic</span></span><br><span class="line"><span class="comment"> *       entropy source, to make this instantiation as unique as possible.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx           The CTR_DRBG context to seed.</span></span><br><span class="line"><span class="comment"> * \param f_entropy     The entropy callback, taking as arguments the</span></span><br><span class="line"><span class="comment"> *                      \p p_entropy context, the buffer to fill, and the</span></span><br><span class="line"><span class="comment">                        length of the buffer.</span></span><br><span class="line"><span class="comment"> * \param p_entropy     The entropy context.</span></span><br><span class="line"><span class="comment"> * \param custom        Personalization data, that is device-specific</span></span><br><span class="line"><span class="comment">                        identifiers. Can be NULL.</span></span><br><span class="line"><span class="comment"> * \param len           The length of the personalization data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return              \c 0 on success, or</span></span><br><span class="line"><span class="comment"> *                      #MBEDTLS_ERR_CTR_DRBG_ENTROPY_SOURCE_FAILED on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ctr_drbg_seed</span><span class="params">( mbedtls_ctr_drbg_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">int</span> (*f_entropy)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">void</span> *p_entropy,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *custom,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">size_t</span> len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 根据随机数种子生成随机数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ctr_drbg_random</span><span class="params">( <span class="keyword">void</span> *p_rng, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> output_len )</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最大生成长度是：MBEDTLS_CTR_DRBG_MAX_REQUEST（1024），如果需要修改的话可以在配置文件中定义该宏。</p>
</blockquote>
<p>④ 释放ctr_drbg随机数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void mbedtls_ctr_drbg_free( mbedtls_ctr_drbg_context *ctx );</span><br></pre></td></tr></table></figure>
<p>⑤ 错误码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_ENTROPY_SOURCE_FAILED        -0x0034  <span class="comment">/**&lt; The entropy source failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_REQUEST_TOO_BIG              -0x0036  <span class="comment">/**&lt; The requested random buffer length is too big. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_INPUT_TOO_BIG                -0x0038  <span class="comment">/**&lt; The input (entropy + additional data) is too large. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_FILE_IO_ERROR                -0x003A  <span class="comment">/**&lt; Read or write error in file. */</span></span></span><br></pre></td></tr></table></figure>
<h4 id="编写测试代码"><a href="#编写测试代码" class="headerlink" title="编写测试代码"></a>编写测试代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_CTR_DRBG_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ctr_drbg_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">uint8_t</span> data_buf[<span class="number">10</span>];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;crbg_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;			<span class="comment">// 熵</span></span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;		<span class="comment">// 随机数种子</span></span><br><span class="line"></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);				<span class="comment">// 初始化熵</span></span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);			<span class="comment">// 初始化随机数种子</span></span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// 根据熵生成随机数种子</span></span><br><span class="line">    <span class="keyword">if</span>( ( ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>( pers ) ) ) != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator... failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator... ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 根据随机数种子生成随机数</span></span><br><span class="line">    <span class="keyword">if</span> ( ( ret = mbedtls_ctr_drbg_random(&amp;ctr_drbg, data_buf, <span class="keyword">sizeof</span>(data_buf) ) ) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;\n  . generate random data... failed\n  ! mbedtls_ctr_drbg_random returned %d\n&quot;</span>, ret );</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . generate random data... ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// 打印随机数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;random data:[&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(data_buf); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, data_buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;]\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. 释放随机数种子 */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. 释放熵*/</span></span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_CTR_DRBG_C */</span></span></span><br></pre></td></tr></table></figure>


<h1 id="二、单向散列算法的配置与使用-MD5-SHA1-SHA256-SHA512"><a href="#二、单向散列算法的配置与使用-MD5-SHA1-SHA256-SHA512" class="headerlink" title="二、单向散列算法的配置与使用(MD5-SHA1-SHA256-SHA512)"></a>二、单向散列算法的配置与使用(MD5-SHA1-SHA256-SHA512)</h1><h2 id="单向散列算法"><a href="#单向散列算法" class="headerlink" title="单向散列算法"></a>单向散列算法</h2><h3 id="单向散列函数"><a href="#单向散列函数" class="headerlink" title="单向散列函数"></a>单向散列函数</h3><p>单向散列函数是一类满足密码学算法安全属性的特殊散列函数，可以根据消息的内容计算出散列值，又称为安全散列函数或者哈希函数，通常用于<strong>检验消息完整性</strong>。<br>输入数据称为<strong>消息</strong>，计算出的散列值称为<strong>消息摘要（摘要）</strong>。<br>单向散列函数具有如下特点：</p>
<ul>
<li>输入长度任意；</li>
<li><strong>输出长度固定</strong>；</li>
<li><strong>单向性</strong>：无法根据散列值还原出消息；<br>单向散列函数主要用在：</li>
<li>消息完整性检测；</li>
<li>构造伪随机数生成算法；</li>
<li>消息认证码；</li>
<li>数字签名；</li>
<li>一次性口令；</li>
</ul>
<h3 id="单向散列算法-1"><a href="#单向散列算法-1" class="headerlink" title="单向散列算法"></a>单向散列算法</h3><p>单向散列算法是单向散列函数的实现，主要包括两大算法实现：MD4/5系列实现、SHA系列实现。</p>
<h4 id="MD系列实现"><a href="#MD系列实现" class="headerlink" title="MD系列实现"></a>MD系列实现</h4><p>MD系列算法最早是MD4，后来诞生了MD5，两者都可以产生128 bit 的散列值。</p>
<h4 id="SHA系列算法"><a href="#SHA系列算法" class="headerlink" title="SHA系列算法"></a>SHA系列算法</h4><p>SHA系列算法由美国国家标准与技术研究所NIST确定，主要包含以下几个：</p>
<ul>
<li>SHA0：1993年发布，可以产生160 bit 的消息摘要，但是存在重大缺陷被撤销；</li>
<li>SHA1：1995年发布，可以产生160 bit 的消息摘要，也存在缺陷（不推荐使用）；</li>
<li>SHA2：包括SHA256算法、SHA384算法、SHA512算法；</li>
<li>SHA3：支持与SHA2相同的消息摘要长度，但是算法内部结构不同；</li>
</ul>
<h3 id="mbedtls中提供的单向散列算法"><a href="#mbedtls中提供的单向散列算法" class="headerlink" title="mbedtls中提供的单向散列算法"></a>mbedtls中提供的单向散列算法</h3><ul>
<li>MD2</li>
<li>MD4</li>
<li>MD5</li>
<li>SHA1</li>
<li>SHA224</li>
<li>SHA256</li>
<li>SHA384</li>
<li>SHA512</li>
</ul>
<h2 id="功能模块的使用"><a href="#功能模块的使用" class="headerlink" title="功能模块的使用"></a>功能模块的使用</h2><h3 id="配置宏"><a href="#配置宏" class="headerlink" title="配置宏"></a>配置宏</h3><p>mbedtls中提供的这些单向散列算法，<strong>每个都是一个独立的模块，由对应的宏控制是否开启</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD2_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD4_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD5_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA224_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA384_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA512_C</span></span><br></pre></td></tr></table></figure>
<p>在使用的时候，除了可以使用每个功能模块提供的API，还可以使用<strong>md通用接口</strong>，通过下面的宏开启：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br></pre></td></tr></table></figure>
<p>测试SHA1、SHA256、SHA512三个算法，所以编写一个新的配置头文件<code>mbedtls_config_sha_x.h</code>，内容如下：</p>
<p>cmakefile.txt中添加<code>CPPFLAGS += -DMBEDTLS_CONFIG_FILE=&#39;&quot;mbedtls_config_sha_x.h&quot;&#39;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   Minimal configuration for SHAX Function</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/09/22</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD2_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD4_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD5_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA224_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA384_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA512_C</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* enable generic message digest wrappers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_SHA_X_H_ */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="md通用接口api说明"><a href="#md通用接口api说明" class="headerlink" title="md通用接口api说明"></a>md通用接口api说明</h3><p>头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化MD结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_md_init</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 根据算法类型得到md信息结构体指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *<span class="title">mbedtls_md_info_from_type</span><span class="params">( <span class="keyword">mbedtls_md_type_t</span> md_type )</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中算法类型 mbedtls_md_type_t 是枚举类型，有以下值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    MBEDTLS_MD_NONE=<span class="number">0</span>,    <span class="comment">/**&lt; None. */</span></span><br><span class="line">    MBEDTLS_MD_MD2,       <span class="comment">/**&lt; The MD2 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_MD4,       <span class="comment">/**&lt; The MD4 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_MD5,       <span class="comment">/**&lt; The MD5 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA1,      <span class="comment">/**&lt; The SHA-1 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA224,    <span class="comment">/**&lt; The SHA-224 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA256,    <span class="comment">/**&lt; The SHA-256 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA384,    <span class="comment">/**&lt; The SHA-384 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA512,    <span class="comment">/**&lt; The SHA-512 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_RIPEMD160, <span class="comment">/**&lt; The RIPEMD-160 message digest. */</span></span><br><span class="line">&#125; <span class="keyword">mbedtls_md_type_t</span>;</span><br></pre></td></tr></table></figure>
<p>③ 设置md结构体，完成md结构体内部接口初始化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_setup</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info, <span class="keyword">int</span> hmac )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 获取单向散列算法名称：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">mbedtls_md_get_name</span><span class="params">( <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 获取单向散列算法输出消息摘要的长度：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">mbedtls_md_get_size</span><span class="params">( <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ md启动接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_starts</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ md更新接口，处理输入数据，计算散列值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_update</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑧ md完成接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_finish</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑨ 释放md结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_md_free</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑩ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FEATURE_UNAVAILABLE                -0x5080  <span class="comment">/**&lt; The selected feature is not available. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_BAD_INPUT_DATA                     -0x5100  <span class="comment">/**&lt; Bad input parameters to function. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_ALLOC_FAILED                       -0x5180  <span class="comment">/**&lt; Failed to allocate memory. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FILE_IO_ERROR                      -0x5200  <span class="comment">/**&lt; Opening or reading of file failed. */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>调用过程为：</strong></p>
<ul>
<li>starts：初始化，只需调用一次；</li>
<li>update：计算值，可以多次调用；</li>
<li>finish：获取计算出的消息摘要；</li>
</ul>
<p>新建文件<code>mbedtls_sha_x_test.c</code>，编写如下测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_MD_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_shax_test</span><span class="params">(<span class="keyword">mbedtls_md_type_t</span> md_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len, i;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *message = <span class="string">&quot;mculover666&quot;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">32</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_md_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *info;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;message is:%s\r\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init mbedtls_md_context_t structure */</span></span><br><span class="line">    mbedtls_md_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. get md info structure pointer */</span></span><br><span class="line">    info = mbedtls_md_info_from_type(md_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. setup md info structure */</span></span><br><span class="line">    ret = mbedtls_md_setup(&amp;ctx, info, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. start */</span></span><br><span class="line">    ret = mbedtls_md_starts(&amp;ctx);</span><br><span class="line">     <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 5. update */</span></span><br><span class="line">    ret = mbedtls_md_update(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 6. finish */</span></span><br><span class="line">    ret = mbedtls_md_finish(&amp;ctx, digest);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s digest context is:[&quot;</span>, mbedtls_md_get_name(info));</span><br><span class="line">    len= mbedtls_md_get_size(info);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, digest[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;]\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 7. free */</span></span><br><span class="line">    mbedtls_md_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_MD_C */</span></span></span><br></pre></td></tr></table></figure>
<h1 id="三、对称加密算法的配置与使用（AES算法）"><a href="#三、对称加密算法的配置与使用（AES算法）" class="headerlink" title="三、对称加密算法的配置与使用（AES算法）"></a>三、对称加密算法的配置与使用（AES算法）</h1><h2 id="AES对称加密算法"><a href="#AES对称加密算法" class="headerlink" title="AES对称加密算法"></a>AES对称加密算法</h2><h3 id="什么是对称加密算法"><a href="#什么是对称加密算法" class="headerlink" title="什么是对称加密算法"></a>什么是对称加密算法</h3><p>对称算法是一种通信双方使用<strong>相同的秘钥</strong>进行加密和解密的密码算法。</p>
<p>其中这份相同的秘钥称为对称秘钥或者共享秘钥，只有通信双方持有，如果传输的密文被拦截，没有秘钥也无法解密出原文。</p>
<h3 id="对称加密算法的几种模式"><a href="#对称加密算法的几种模式" class="headerlink" title="对称加密算法的几种模式"></a>对称加密算法的几种模式</h3><h4 id="分组密码模式"><a href="#分组密码模式" class="headerlink" title="分组密码模式"></a>分组密码模式</h4><p>分组密码只能加密或者加密<strong>固定长度</strong>的数据，如果需要加密的明文长度超过了分组长度，则需要对明文进行分组，然后对各分组进行处理。</p>
<p>① <strong>ECB模式（电子密码本模式）</strong></p>
<p>ECB（Electronic CodeBook）模式将明文进行分组，然后针对每组单独进行加密，处理之后再将每组密文合并在一起，同理，解析也是一样的过程。</p>
<p>这种模式之下明文和密文一一对应，存在明显的缺点，所以实际中禁止使用。</p>
<p>② <strong>CBC模式（密码分组链接模式）</strong></p>
<p>CBC（Cipher Block Chaining）模式中，每组明文在加密前都要先与前面的一组密文进行异或操作，然后使用秘钥计算出密文。</p>
<p>同理，每组密文在解密时先使用秘钥计算出明文，然后与前面的一组密文进行异或运算，还原出最终明文。</p>
<p>在这种方式下，由于第一个明文分组前面没有密文分组，所以需要提前设置一个与分组长度相等的序列来代替密文分组，称之为初始化向量（Intialization Vector）。一般在发送端使用伪随机数生成器生成一个初始化的IV，然后通过某种方式发送给接收端。</p>
<p>所以，<strong>在CBC模式下，要想通信双方能正常加密解密，除了拥有相同的秘钥，还必须要拥有相同的初始化向量</strong>。</p>
<p>③ <strong>CRT模式（计数器模式）</strong></p>
<p>CRT模式中，使用与分组长度的计数值参与运算。通过对逐次累加的计数器值进行加密来生成密钥流，然后秘钥流与明文分组进行异或运算，得到密文分组。</p>
<p>同理，接收端解密的时候：通过对逐次累加的计数器值进行加密来生成密钥流，然后秘钥流与密文分组进行异或运算，得到明文分组。</p>
<p>④ 三种模式对比</p>
<p>相比之下：</p>
<ul>
<li>CTR模式中对于每个分组的加密/解密是独立的，可以进行并行计算，大幅提高计算效率；</li>
<li>CBC模式中密文分组的解密过程依赖于前一个密文分组，而CRT模式中每个密文分组的解密过程是独立的；</li>
<li>CTR模式中仅需要加密算法（对计数值加密）、不需要解密算法，而ECB和CBC模式都需要加密和解密算法；</li>
<li>CTR模式不需要对明文进行填充，而ECB和CBC模式需要；</li>
</ul>
<h4 id="PKCS7填充方案"><a href="#PKCS7填充方案" class="headerlink" title="PKCS7填充方案"></a>PKCS7填充方案</h4><p>在EBC模式和CBC模式中，要求<strong>输入明文长度不是分组长度的整数倍时，要对明文进行填充</strong>。</p>
<p>常用的填充方案是 PKCS7 方案，规则如下：</p>
<h3 id="AES算法"><a href="#AES算法" class="headerlink" title="AES算法"></a>AES算法</h3><p>AES算法的固定分组大小为128位（16字节），秘钥长度为128、192、256位。</p>
<p>AES算法中的S盒是唯一的非线性实现，解密过程中需要使用S盒完整字节替换，<strong>通常S盒计算通过查表法实现</strong>。</p>
<h3 id="mbedtls中提供的对称加密算法"><a href="#mbedtls中提供的对称加密算法" class="headerlink" title="mbedtls中提供的对称加密算法"></a>mbedtls中提供的对称加密算法</h3><p>mbedtls中提供的对称加密算法如下：</p>
<ul>
<li>AES：支持ECB、CBC、CTR、CFB、GCM模式；</li>
<li>ARCFOUR(RC4)</li>
<li>Blowfish</li>
<li>Camellia</li>
<li>DES/3DES</li>
<li>XTEA</li>
</ul>
<h2 id="AES功能模块的配置与使用"><a href="#AES功能模块的配置与使用" class="headerlink" title="AES功能模块的配置与使用"></a>AES功能模块的配置与使用</h2><h3 id="配置宏定义"><a href="#配置宏定义" class="headerlink" title="配置宏定义"></a>配置宏定义</h3><h4 id="AES功能相关宏"><a href="#AES功能相关宏" class="headerlink" title="AES功能相关宏"></a>AES功能相关宏</h4><p>mbedtls中提供的这些对称加密算法，每个都是一个独立的模块，由对应的宏控制是否开启，要使用AES相关功能，需要开启以下宏：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_AES_C</td>
<td>开启AES算法</td>
</tr>
<tr>
<td>MBEDTLS_CIPHER_MODE_CBC</td>
<td>开启CBC模式</td>
</tr>
<tr>
<td>MBEDTLS_CIPHER_MODE_CTR</td>
<td>开启CRT模式</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>开启预定义S盒</td>
</tr>
<tr>
<td>MBEDTLS_CIPHER_PADDING_PKCS7</td>
<td>开启PKCS7填充方案</td>
</tr>
</tbody></table>
<p>① <strong>MBEDTLS_AES_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_CIPHER_MODE_CBC</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CBC</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_CIPHER_MODE_CTR</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CTR</span></span><br></pre></td></tr></table></figure>
<p>④ <strong>MBEDTLS_AES_ROM_TABLES</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br></pre></td></tr></table></figure>
<p>⑤<strong>MBEDTLS_CIPHER_PADDING_PKCS7</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_PADDING_PKCS7</span></span><br></pre></td></tr></table></figure>
<h4 id="cipher通用接口"><a href="#cipher通用接口" class="headerlink" title="cipher通用接口"></a>cipher通用接口</h4><p>除了使用功能模块所提供的接口，mbedtls还提供了cipher通用接口，通过宏定义 <strong>MBEDTLS_CIPHER_C</strong> 开启：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_C</span></span><br></pre></td></tr></table></figure>
<h4 id="编写本实验配置文件"><a href="#编写本实验配置文件" class="headerlink" title="编写本实验配置文件"></a>编写本实验配置文件</h4><p>编写<code>mbedtls_config_aes.h</code>文件，作为针对本实验的mbedtls配置文件，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_AES_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_AES_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CBC				<span class="comment">// 开启CBC模式</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CTR				<span class="comment">// 开启CRT模式</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C									<span class="comment">// 开启AES算法</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES				<span class="comment">// 开启预定义S盒</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_PADDING_PKCS7	<span class="comment">// 开启PKCS7填充方案</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_CTR_DRBG_H_ */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cipher通用接口API说明"><a href="#cipher通用接口API说明" class="headerlink" title="cipher通用接口API说明"></a>cipher通用接口API说明</h3><p>包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化cipher结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_cipher_init</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 通过加密算法名类型获取cipher信息结构体指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *<span class="title">mbedtls_cipher_info_from_type</span><span class="params">( <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_type_t</span> cipher_type )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 设置cipher结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_setup</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *cipher_info )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 获取算法名称：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">mbedtls_cipher_get_name</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MBEDTLS_INTERNAL_VALIDATE_RET( ctx != <span class="literal">NULL</span>, <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( ctx-&gt;cipher_info == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx-&gt;cipher_info-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>⑤ 获取算法分组长度：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">mbedtls_cipher_get_block_size</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MBEDTLS_INTERNAL_VALIDATE_RET( ctx != <span class="literal">NULL</span>, <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( ctx-&gt;cipher_info == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx-&gt;cipher_info-&gt;block_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>⑥ 设置解密秘钥接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_setkey</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">int</span> key_bitlen,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">mbedtls_operation_t</span> operation )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ 设置iv接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_set_iv</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> iv_len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑧ cipher更新接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_update</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> ilen, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> *olen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑨ cipher完成接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_finish</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> *olen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑩ 释放cipher结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_cipher_free</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数"><a href="#编写测试函数" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>新建demo文件<code>mbedtls_aes_test.c</code>，编写以下测试内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_CIPHER_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Private Key */</span></span><br><span class="line"><span class="keyword">uint8_t</span> key[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0x06</span>, <span class="number">0xa9</span>, <span class="number">0x21</span>, <span class="number">0x40</span>, <span class="number">0x36</span>, <span class="number">0xb8</span>, <span class="number">0xa1</span>, <span class="number">0x5b</span>,</span><br><span class="line">    <span class="number">0x51</span>, <span class="number">0x2e</span>, <span class="number">0x03</span>, <span class="number">0xd5</span>, <span class="number">0x34</span>, <span class="number">0x12</span>, <span class="number">0x00</span>, <span class="number">0x06</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Intialization Vector */</span></span><br><span class="line"><span class="keyword">uint8_t</span> iv[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0x3d</span>, <span class="number">0xaf</span>, <span class="number">0xba</span>, <span class="number">0x42</span>, <span class="number">0x9d</span>, <span class="number">0x9e</span>, <span class="number">0xb4</span>, <span class="number">0x30</span>,</span><br><span class="line">    <span class="number">0xb4</span>, <span class="number">0x22</span>, <span class="number">0xda</span>, <span class="number">0x80</span>, <span class="number">0x2c</span>, <span class="number">0x9f</span>, <span class="number">0xac</span>, <span class="number">0x41</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf:&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aes_test</span><span class="params">(<span class="keyword">mbedtls_cipher_type_t</span> cipher_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">int</span> olen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> output_buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *input = <span class="string">&quot;creekwater is learning aes of mbedtls.&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_cipher_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 1. 初始化cipher context结构体 */</span></span><br><span class="line">    mbedtls_cipher_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. 从类型获取cipher info */</span></span><br><span class="line">    info = mbedtls_cipher_info_from_type(cipher_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. 设置cipher context结构体 */</span></span><br><span class="line">    ret = mbedtls_cipher_setup(&amp;ctx, info);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. 设置key */</span></span><br><span class="line">    ret = mbedtls_cipher_setkey(&amp;ctx, key, <span class="keyword">sizeof</span>(key) * <span class="number">8</span>, MBEDTLS_ENCRYPT);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. 设置iv */</span></span><br><span class="line">    ret = mbedtls_cipher_set_iv(&amp;ctx, iv, <span class="keyword">sizeof</span>(iv));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. 更新 cipher */</span></span><br><span class="line">    ret = mbedtls_cipher_update(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)input, <span class="built_in">strlen</span>(input), output_buf, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. 结束 cipher */</span></span><br><span class="line">    ret = mbedtls_cipher_finish(&amp;ctx, output_buf, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 打印结果 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\nsource_context:%s\r\n&quot;</span>, input);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher name:%s block size is:%d\r\n&quot;</span>, mbedtls_cipher_get_name(&amp;ctx), mbedtls_cipher_get_block_size(&amp;ctx));</span><br><span class="line">    dump_buf(output_buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 8. 释放 cipher 结构体 */</span></span><br><span class="line">    mbedtls_cipher_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_CIPHER_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><p>从结果可以看到：</p>
<ul>
<li>AES算法分组大小为16个字节（128位）；</li>
<li>CBC模式下，AES算法会将55个字节的明文加密为64个字节；</li>
<li>CRT模式下，AES算法加密之后的密文长度仍然是55个字节，和明文长度相同；</li>
</ul>
<h1 id="四、消息认证码"><a href="#四、消息认证码" class="headerlink" title="四、消息认证码"></a>四、消息认证码</h1><h2 id="什么是消息认证码"><a href="#什么是消息认证码" class="headerlink" title="什么是消息认证码"></a>什么是消息认证码</h2><p>消息认证码（Message Authentication Code）可<strong>用来检查消息的完整性和消息来源的可靠性</strong>。</p>
<p>消息认证码算法的输入为任意长度的消息和通信双方共享的秘钥，消息认证码的输出为固定长度的数据，该输出数据称为MAC值、Tag值、T值。</p>
<h2 id="消息认证码的实现方式"><a href="#消息认证码的实现方式" class="headerlink" title="消息认证码的实现方式"></a>消息认证码的实现方式</h2><h3 id="基于单向散列算法实现"><a href="#基于单向散列算法实现" class="headerlink" title="基于单向散列算法实现"></a>基于单向散列算法实现</h3><p>这类实现称为<strong>HMAC</strong>，比如HMAC-SHA1、HMAC-SHA256等。因为单向散列算法无法验证消息来源的可靠性，所以不能直接用于生成消息认证码。</p>
<p>另外，在HMAC算法中，<strong>通信双方共享秘钥没有长度限制，明文也没有长度限制，但是最后生成的消息认证码长度是固定的</strong>。</p>
<p>比如基于SHA256算法的HAMC算法，因为SHA256计算出的消息摘要是256字节，32个字节，所以最后生成的消息认证码长度也是32个字节固定长度。</p>
<h3 id="基于分组加密算法实现"><a href="#基于分组加密算法实现" class="headerlink" title="基于分组加密算法实现"></a>基于分组加密算法实现</h3><p>比如将CBC分组加密结果的最后一个分组作为消息认证码的<strong>CBC-MAC</strong>算法。</p>
<p>还有通过共享秘钥派生出两个中间秘钥的<strong>CMAC</strong>算法，安全性更高。</p>
<h3 id="认证加密算法实现"><a href="#认证加密算法实现" class="headerlink" title="认证加密算法实现"></a>认证加密算法实现</h3><p>认证加密算法在通信过程中提供数据机密性和完整性的密码算法，是对称加密算法（eg. AES）和消息认证码的结合，典型实现包括<strong>GCM</strong>、<strong>CCM</strong>等。</p>
<p>CCM认证加密过程对明文进行两次处理，第一次使用CBC-MAC计算消息认证码，第二次使用CRT模式将消息认证码（明文）加密。</p>
<p>GCM认证加密过程和CCM类似，只不过第一次计算使用的是GHASH算法，第二次计算使用的是GCTR算法。</p>
<p>另外，<strong>GCM的消息认证码长度只能为16字节，而CCM模式的消息认证码长度最小为4字节、最大为16字节</strong>。</p>
<h2 id="mbedtls中的消息认证码实现"><a href="#mbedtls中的消息认证码实现" class="headerlink" title="mbedtls中的消息认证码实现"></a>mbedtls中的消息认证码实现</h2><p>mbedtls中提供了HMAC计算接口和GCM计算接口。</p>
<h2 id="配置宏-1"><a href="#配置宏-1" class="headerlink" title="配置宏"></a>配置宏</h2><p>开启一种单向散列函数功能和MD通用接口即可：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>开启SHA256单向散列算法</td>
</tr>
</tbody></table>
<p>新建一个针对本实验的配置文件<code>mbedtls_config_hmac.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD2_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD4_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD5_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA224_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA384_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA512_C</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* enable generic message digest wrappers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_SHA_X_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>cmakefile.txt中添加<code>CPPFLAGS += -DMBEDTLS_CONFIG_FILE=&#39;&quot;mbedtls_config_hmac.h&quot;&#39;</code></p>
<h2 id="HMAC功能模块API说明"><a href="#HMAC功能模块API说明" class="headerlink" title="HMAC功能模块API说明"></a>HMAC功能模块API说明</h2><p>① hmac启动接口（完成秘钥、ipad、opad计算）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_hmac_starts</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">size_t</span> keylen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② hmac更新接口（处理输入数据）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_hmac_update</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">size_t</span> ilen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ hmac完成接口（输出消息认证码）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_hmac_finish</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output)</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FEATURE_UNAVAILABLE                -0x5080  <span class="comment">/**&lt; The selected feature is not available. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_BAD_INPUT_DATA                     -0x5100  <span class="comment">/**&lt; Bad input parameters to function. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_ALLOC_FAILED                       -0x5180  <span class="comment">/**&lt; Failed to allocate memory. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FILE_IO_ERROR                      -0x5200  <span class="comment">/**&lt; Opening or reading of file failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MBEDTLS_ERR_MD_HW_ACCEL_FAILED is deprecated and should not be used. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_HW_ACCEL_FAILED                    -0x5280  <span class="comment">/**&lt; MD hardware accelerator failed. */</span></span></span><br></pre></td></tr></table></figure>
<p>特别注意，与计算单向散列值不同，<strong>在计算消息认证码的时候要在设置时表明使用HMAC</strong>，也就是 mbedtls_md_setup 函数的第三个参数要设置为非零值，通常设为1即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_setup</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info, <span class="keyword">int</span> hmac )</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="编写测试函数-1"><a href="#编写测试函数-1" class="headerlink" title="编写测试函数"></a>编写测试函数</h2><p>新建文件<code>mbedtls_hmac_test.c</code>，编写如下测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_MD_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hmac_test</span><span class="params">(<span class="keyword">mbedtls_md_type_t</span> md_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len, i;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *key     = <span class="string">&quot;mculover666&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *message = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> hmac[<span class="number">32</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_md_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *info;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;message is:%s\r\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. 初始化 mbedtls_md_context_t 结构体 */</span></span><br><span class="line">    mbedtls_md_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. get md info structure pointer */</span></span><br><span class="line">    info = mbedtls_md_info_from_type(md_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. setup md info structure */</span></span><br><span class="line">    ret = mbedtls_md_setup(&amp;ctx, info, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. start */</span></span><br><span class="line">    ret = mbedtls_md_hmac_starts(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)key, <span class="built_in">strlen</span>(key));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 5. update */</span></span><br><span class="line">    ret = mbedtls_md_hmac_update(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 6. finish */</span></span><br><span class="line">    ret = mbedtls_md_hmac_finish(&amp;ctx, hmac);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s hmac context is:[&quot;</span>, mbedtls_md_get_name(info));</span><br><span class="line">    len= mbedtls_md_get_size(info);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, hmac[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;]\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 7. free */</span></span><br><span class="line">    mbedtls_md_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_MD_C */</span></span></span><br></pre></td></tr></table></figure>
<h2 id="测试结果-1"><a href="#测试结果-1" class="headerlink" title="测试结果"></a>测试结果</h2><p>在main.c中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Private user code ---------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">/* USER CODE BEGIN 0 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hmac_test</span><span class="params">(<span class="keyword">mbedtls_md_type_t</span> md_type)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* USER CODE END 0 */</span></span><br></pre></td></tr></table></figure>
<p>然后在main函数中调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 3. hamc test */</span></span><br><span class="line">mbedtls_hmac_test(MBEDTLS_MD_SHA256);</span><br></pre></td></tr></table></figure>
<p>编译、下载、测试结果如图：</p>
<p>在MDK中配置：<br><img src="https://img-blog.csdnimg.cn/20200926151128537.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h2 id="GCM功能模块相关的API说明"><a href="#GCM功能模块相关的API说明" class="headerlink" title="GCM功能模块相关的API说明"></a>GCM功能模块相关的API说明</h2><p>① cipher认证加密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_auth_encrypt</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv, <span class="keyword">size_t</span> iv_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ad, <span class="keyword">size_t</span> ad_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">char</span> *tag, <span class="keyword">size_t</span> tag_len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② cipher认证解密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_auth_decrypt</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv, <span class="keyword">size_t</span> iv_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ad, <span class="keyword">size_t</span> ad_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *tag, <span class="keyword">size_t</span> tag_len )</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="编写测试代码-1"><a href="#编写测试代码-1" class="headerlink" title="编写测试代码"></a>编写测试代码</h2><p>新建文件<code>mbedtls_config_gcm.c</code>，编写测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_GCM_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* source context */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> input[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0xc3</span>, <span class="number">0xb3</span>, <span class="number">0xc4</span>, <span class="number">0x1f</span>, <span class="number">0x11</span>, <span class="number">0x3a</span>, <span class="number">0x31</span>, <span class="number">0xb7</span>, </span><br><span class="line">    <span class="number">0x3d</span>, <span class="number">0x9a</span>, <span class="number">0x5c</span>, <span class="number">0xd4</span>, <span class="number">0x32</span>, <span class="number">0x10</span>, <span class="number">0x30</span>, <span class="number">0x69</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Private Key */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> key[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0xc9</span>, <span class="number">0x39</span>, <span class="number">0xcc</span>, <span class="number">0x13</span>, <span class="number">0x39</span>, <span class="number">0x7c</span>, <span class="number">0x1d</span>, <span class="number">0x37</span>,</span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0x6a</span>, <span class="number">0xe0</span>, <span class="number">0xe1</span>, <span class="number">0xcb</span>, <span class="number">0x7c</span>, <span class="number">0x42</span>, <span class="number">0x3c</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Intialization Vector */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> iv[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0xb3</span>, <span class="number">0xd8</span>, <span class="number">0xcc</span>, <span class="number">0x01</span>, </span><br><span class="line">    <span class="number">0x7c</span>, <span class="number">0xbb</span>, <span class="number">0x89</span>, <span class="number">0xb3</span>,</span><br><span class="line">    <span class="number">0x9e</span>, <span class="number">0x0f</span>, <span class="number">0x67</span>, <span class="number">0xe2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The additional data to authenticate */</span></span><br><span class="line"><span class="keyword">uint8_t</span> add[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0x24</span>, <span class="number">0x82</span>, <span class="number">0x56</span>, <span class="number">0x02</span>, <span class="number">0xbd</span>, <span class="number">0x12</span>, <span class="number">0xa9</span>, <span class="number">0x84</span>, </span><br><span class="line">    <span class="number">0xe0</span>, <span class="number">0x09</span>, <span class="number">0x2d</span>, <span class="number">0x3e</span>, <span class="number">0x44</span>, <span class="number">0x8e</span>, <span class="number">0xda</span>, <span class="number">0x5f</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcm_test</span><span class="params">(<span class="keyword">mbedtls_cipher_type_t</span> cipher_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">int</span> olen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> output_buf[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> tag_buf[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> decrypt_out_buf[<span class="number">16</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_cipher_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 1. init cipher structuer */</span></span><br><span class="line">    mbedtls_cipher_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. get info structuer from type */</span></span><br><span class="line">    info = mbedtls_cipher_info_from_type(cipher_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. setup cipher structuer */</span></span><br><span class="line">    ret = mbedtls_cipher_setup(&amp;ctx, info);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. set encrypt key */</span></span><br><span class="line">    ret = mbedtls_cipher_setkey(&amp;ctx, key, <span class="keyword">sizeof</span>(key) * <span class="number">8</span>, MBEDTLS_ENCRYPT);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. auth encrypt */</span></span><br><span class="line">    ret = mbedtls_cipher_auth_encrypt(&amp;ctx, </span><br><span class="line">                                      iv, <span class="keyword">sizeof</span>(iv), add, <span class="keyword">sizeof</span>(add), </span><br><span class="line">                                      (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)input, <span class="keyword">sizeof</span>(input), </span><br><span class="line">                                      output_buf, &amp;len, tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher name:%s block size is:%d\r\n&quot;</span>, mbedtls_cipher_get_name(&amp;ctx), mbedtls_cipher_get_block_size(&amp;ctx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\noutput_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf((<span class="keyword">uint8_t</span> *)output_buf, olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\ntag_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf(tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. set decrypt key */</span></span><br><span class="line">    ret = mbedtls_cipher_setkey(&amp;ctx, key, <span class="keyword">sizeof</span>(key) * <span class="number">8</span>, MBEDTLS_DECRYPT);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. auth decrypt */</span></span><br><span class="line">    olen = <span class="number">0</span>;</span><br><span class="line">    len  = <span class="number">0</span>;</span><br><span class="line">    ret = mbedtls_cipher_auth_decrypt(&amp;ctx, </span><br><span class="line">                                      iv, <span class="keyword">sizeof</span>(iv), add, <span class="keyword">sizeof</span>(add), </span><br><span class="line">                                      (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)output_buf, <span class="keyword">sizeof</span>(output_buf), </span><br><span class="line">                                      decrypt_out_buf, &amp;len, tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher name:%s block size is:%d\r\n&quot;</span>, mbedtls_cipher_get_name(&amp;ctx), mbedtls_cipher_get_block_size(&amp;ctx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\ndecrypt_out_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf((<span class="keyword">uint8_t</span> *)decrypt_out_buf, olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\ntag_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf(tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 8. free cipher structure */</span></span><br><span class="line">    mbedtls_cipher_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_CIPHER_C */</span></span></span><br></pre></td></tr></table></figure>
<h2 id="测试结果-2"><a href="#测试结果-2" class="headerlink" title="测试结果"></a>测试结果</h2><p>在main.c 中声明该外部函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Private user code ---------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">/* USER CODE BEGIN 0 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcm_test</span><span class="params">(<span class="keyword">mbedtls_cipher_type_t</span> cipher_type)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* USER CODE END 0 */</span></span><br></pre></td></tr></table></figure>
<p>接着在main函数中调用测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 4.gcm test */</span></span><br><span class="line">gcm_test(MBEDTLS_CIPHER_AES_128_GCM);</span><br></pre></td></tr></table></figure>
<p>编译、下载，测试结果为：<br><img src="https://img-blog.csdnimg.cn/20200926151709761.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h1 id="五、非对称加密算法的配置与使用（RSA算法）"><a href="#五、非对称加密算法的配置与使用（RSA算法）" class="headerlink" title="五、非对称加密算法的配置与使用（RSA算法）"></a>五、非对称加密算法的配置与使用（RSA算法）</h1><h2 id="非对称加密算法——RSA"><a href="#非对称加密算法——RSA" class="headerlink" title="非对称加密算法——RSA"></a>非对称加密算法——RSA</h2><h3 id="对称加密算法和非对称加密算法"><a href="#对称加密算法和非对称加密算法" class="headerlink" title="对称加密算法和非对称加密算法"></a>对称加密算法和非对称加密算法</h3><p>对称加密算法，比如AES算法，在发送端（加密）和接收端（解密）使用相同的一份秘钥，称为共享秘钥。</p>
<p>非对称加密算法，比如RSA算法，在加密使用<strong>公钥</strong>，而在解密时使用<strong>私钥</strong>。</p>
<h3 id="RSA算法"><a href="#RSA算法" class="headerlink" title="RSA算法"></a>RSA算法</h3><p>RSA算法是一种常用的非对称加密算法。</p>
<p>RSA算法主要包括三个过程：</p>
<ul>
<li>生成秘钥对</li>
<li>使用公钥加密明文</li>
<li>使用私钥解密密文</li>
</ul>
<h3 id="RSA加速技术"><a href="#RSA加速技术" class="headerlink" title="RSA加速技术"></a>RSA加速技术</h3><p>RSA算法在计算过程中存在较多的取模运算和幂运算，计算速度比对称加密算法要慢，所以不适合对大量数据进行加密和解密，在实际中常用于加密或解密小数据片段。</p>
<p>RSA公钥加密过程可使用短公开指数进行快速计算，而RSA私钥解密过程可使用中国剩余定理（CRT）进行加速执行。</p>
<h3 id="RSA填充方法"><a href="#RSA填充方法" class="headerlink" title="RSA填充方法"></a>RSA填充方法</h3><p>RSA加密结果是<strong>确定的</strong>。当公钥确定的时候，一段明文总是会加密的到对应的密文，这样未免存在安全隐患。</p>
<p>实际使用RSA算法中需要包含填充方案，在计算之前会对明文进行随机注入，这样在公钥和明文相同的情况下，也不会生成相同的秘文。</p>
<p>常用的RSA填充方案有两种：RSAES-OAEP（推荐使用）和RSAES-PKCS1V1_5（较早、不推荐使用）。</p>
<h2 id="RSA功能模块的配置与使用"><a href="#RSA功能模块的配置与使用" class="headerlink" title="RSA功能模块的配置与使用"></a>RSA功能模块的配置与使用</h2><h3 id="配置宏-2"><a href="#配置宏-2" class="headerlink" title="配置宏"></a>配置宏</h3><p>使用RSA功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_GENPRIME</td>
<td>开启生成素数</td>
</tr>
<tr>
<td>MBEDTLS_OID_C</td>
<td>开启OID数据结构模块</td>
</tr>
<tr>
<td>MBEDTLS_RSA_C</td>
<td>开启RSA算法</td>
</tr>
<tr>
<td>MBEDTLS_PKCS1_V21</td>
<td>开启PKCS#1 v2.1填充方案（OAEP）</td>
</tr>
</tbody></table>
<p>下面补充几个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_BIGNUM_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the multi-precision integer library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/bignum.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/dhm.c</span></span><br><span class="line"><span class="comment"> *          library/ecp.c</span></span><br><span class="line"><span class="comment"> *          library/ecdsa.c</span></span><br><span class="line"><span class="comment"> *          library/rsa.c</span></span><br><span class="line"><span class="comment"> *          library/rsa_internal.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_tls.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is required for RSA, DHM and ECC (ECDH, ECDSA) support.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_GENPRIME</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the prime-number generation code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_OID_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_OID_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the OID database.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/oid.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/asn1write.c</span></span><br><span class="line"><span class="comment"> *          library/pkcs5.c</span></span><br><span class="line"><span class="comment"> *          library/pkparse.c</span></span><br><span class="line"><span class="comment"> *          library/pkwrite.c</span></span><br><span class="line"><span class="comment"> *          library/rsa.c</span></span><br><span class="line"><span class="comment"> *          library/x509.c</span></span><br><span class="line"><span class="comment"> *          library/x509_create.c</span></span><br><span class="line"><span class="comment"> *          library/x509_crl.c</span></span><br><span class="line"><span class="comment"> *          library/x509_crt.c</span></span><br><span class="line"><span class="comment"> *          library/x509_csr.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_crt.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_csr.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This modules translates between OIDs and internal values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br></pre></td></tr></table></figure>
<p>④ <strong>MBEDTLS_RSA_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_RSA_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the RSA public-key cryptosystem.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/rsa.c</span></span><br><span class="line"><span class="comment"> *          library/rsa_internal.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ssl_cli.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_srv.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_tls.c</span></span><br><span class="line"><span class="comment"> *          library/x509.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      RSA, DHE-RSA, ECDHE-RSA, RSA-PSK</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_BIGNUM_C, MBEDTLS_OID_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br></pre></td></tr></table></figure>
<p>⑤ <strong>MBEDTLS_PKCS1_V21</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_PKCS1_V21</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable support for PKCS#1 v2.1 encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_MD_C, MBEDTLS_RSA_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This enables support for RSAES-OAEP and RSASSA-PSS operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br></pre></td></tr></table></figure>
<p>编辑针对本实验的配置文件<code>mbedtls_config_rsa.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_RSA_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_RSA_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_RSA_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK配置mbedtls使用该配置文件：<br><img src="https://img-blog.csdnimg.cn/20200927110342915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="RSA功能模块API说明"><a href="#RSA功能模块API说明" class="headerlink" title="RSA功能模块API说明"></a>RSA功能模块API说明</h3><p>使用该功能模块需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化RSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function initializes an RSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Set padding to #MBEDTLS_RSA_PKCS_V21 for the RSAES-OAEP</span></span><br><span class="line"><span class="comment"> *                 encryption scheme and the RSASSA-PSS signature scheme.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The \p hash_id parameter is ignored when using</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PKCS_V15 padding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The choice of padding mode is strictly enforced for private key</span></span><br><span class="line"><span class="comment"> *                 operations, since there might be security concerns in</span></span><br><span class="line"><span class="comment"> *                 mixing padding modes. For public key operations it is</span></span><br><span class="line"><span class="comment"> *                 a default value, which can be overridden by calling specific</span></span><br><span class="line"><span class="comment"> *                 \c rsa_rsaes_xxx or \c rsa_rsassa_xxx functions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The hash selected in \p hash_id is always used for OEAP</span></span><br><span class="line"><span class="comment"> *                 encryption. For PSS signatures, it is always used for</span></span><br><span class="line"><span class="comment"> *                 making signatures, but can be overridden for verifying them.</span></span><br><span class="line"><span class="comment"> *                 If set to #MBEDTLS_MD_NONE, it is always overridden.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The RSA context to initialize. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param padding  The padding mode to use. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PKCS_V15 or #MBEDTLS_RSA_PKCS_V21.</span></span><br><span class="line"><span class="comment"> * \param hash_id  The hash identifier of ::mbedtls_md_type_t type, if</span></span><br><span class="line"><span class="comment"> *                 \p padding is #MBEDTLS_RSA_PKCS_V21. It is unused</span></span><br><span class="line"><span class="comment"> *                 otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_rsa_init</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> padding,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> hash_id )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② RSA生成秘钥对：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function generates an RSA keypair.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           mbedtls_rsa_init() must be called before this function,</span></span><br><span class="line"><span class="comment"> *                 to set up the RSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context used to hold the key.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to be used for key generation.</span></span><br><span class="line"><span class="comment"> *                 This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng.</span></span><br><span class="line"><span class="comment"> *                 This may be \c NULL if \p f_rng doesn&#x27;t need a context.</span></span><br><span class="line"><span class="comment"> * \param nbits    The size of the public key in bits.</span></span><br><span class="line"><span class="comment"> * \param exponent The public exponent to use. For example, \c 65537.</span></span><br><span class="line"><span class="comment"> *                 This must be odd and greater than \c 1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_gen_key</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">int</span> nbits, <span class="keyword">int</span> exponent )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ RSA加密操作，通过参数指定公钥加密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function adds the message padding, then performs an RSA</span></span><br><span class="line"><span class="comment"> *                 operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 It is the generic wrapper for performing a PKCS#1 encryption</span></span><br><span class="line"><span class="comment"> *                 operation using the \p mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PRIVATE mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 implicitly set to #MBEDTLS_RSA_PUBLIC.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PRIVATE and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG to use. It is mandatory for PKCS#1 v2.1 padding</span></span><br><span class="line"><span class="comment"> *                 encoding, and for PKCS#1 v1.5 padding encoding when used</span></span><br><span class="line"><span class="comment"> *                 with \p mode set to #MBEDTLS_RSA_PUBLIC. For PKCS#1 v1.5</span></span><br><span class="line"><span class="comment"> *                 padding encoding and \p mode set to #MBEDTLS_RSA_PRIVATE,</span></span><br><span class="line"><span class="comment"> *                 it is used for blinding and should be provided in this</span></span><br><span class="line"><span class="comment"> *                 case; see mbedtls_rsa_private() for more.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. May be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng is \c NULL or if \p f_rng doesn&#x27;t</span></span><br><span class="line"><span class="comment"> *                 need a context argument.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PUBLIC or #MBEDTLS_RSA_PRIVATE (deprecated).</span></span><br><span class="line"><span class="comment"> * \param ilen     The length of the plaintext in Bytes.</span></span><br><span class="line"><span class="comment"> * \param input    The input data to encrypt. This must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of size \p ilen Bytes. It may be \c NULL if</span></span><br><span class="line"><span class="comment"> *                 `ilen == 0`.</span></span><br><span class="line"><span class="comment"> * \param output   The output buffer. This must be a writable buffer</span></span><br><span class="line"><span class="comment"> *                 of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_encrypt</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> mode, <span class="keyword">size_t</span> ilen,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">char</span> *output )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ RSA解密操作，通过指定私钥解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function performs an RSA operation, then removes the</span></span><br><span class="line"><span class="comment"> *                 message padding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 It is the generic wrapper for performing a PKCS#1 decryption</span></span><br><span class="line"><span class="comment"> *                 operation using the \p mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The output buffer length \c output_max_len should be</span></span><br><span class="line"><span class="comment"> *                 as large as the size \p ctx-&gt;len of \p ctx-&gt;N (for example,</span></span><br><span class="line"><span class="comment"> *                 128 Bytes if RSA-1024 is used) to be able to hold an</span></span><br><span class="line"><span class="comment"> *                 arbitrary decrypted message. If it is not large enough to</span></span><br><span class="line"><span class="comment"> *                 hold the decryption of the particular ciphertext provided,</span></span><br><span class="line"><span class="comment"> *                 the function returns \c MBEDTLS_ERR_RSA_OUTPUT_TOO_LARGE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PUBLIC mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 implicitly set to #MBEDTLS_RSA_PRIVATE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PUBLIC and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function. If \p mode is #MBEDTLS_RSA_PRIVATE,</span></span><br><span class="line"><span class="comment"> *                 this is used for blinding and should be provided; see</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_private() for more. If \p mode is</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PUBLIC, it is ignored.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng is \c NULL or doesn&#x27;t need a context.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PRIVATE or #MBEDTLS_RSA_PUBLIC (deprecated).</span></span><br><span class="line"><span class="comment"> * \param olen     The address at which to store the length of</span></span><br><span class="line"><span class="comment"> *                 the plaintext. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param input    The ciphertext buffer. This must be a readable buffer</span></span><br><span class="line"><span class="comment"> *                 of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus.</span></span><br><span class="line"><span class="comment"> * \param output   The buffer used to hold the plaintext. This must</span></span><br><span class="line"><span class="comment"> *                 be a writable buffer of length \p output_max_len Bytes.</span></span><br><span class="line"><span class="comment"> * \param output_max_len The length in Bytes of the output buffer \p output.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_decrypt</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> mode, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">char</span> *output,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">size_t</span> output_max_len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 释放RSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function frees the components of an RSA key.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The RSA context to free. May be \c NULL, in which case</span></span><br><span class="line"><span class="comment"> *                 this function is a no-op. If it is not \c NULL, it must</span></span><br><span class="line"><span class="comment"> *                 point to an initialized RSA context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_rsa_free</span><span class="params">( mbedtls_rsa_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-2"><a href="#编写测试函数-2" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>新建文件<code>mbedtls_rsa_test.c</code>，编写以下测试内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   RSA Function demo</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/09/27</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_RSA_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">516</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_rsa_key</span><span class="params">(mbedtls_rsa_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;N , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;N: %s\n&quot;</span>, buf); </span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;E , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;E: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;D , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;D: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;P , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;P: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;Q , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Q: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DP: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DQ, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DQ: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;QP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;QP: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> output_buf[<span class="number">2048</span>/<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> decrypt_buf[<span class="number">20</span>];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;rsa_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_rsa_context ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_rsa_init(&amp;ctx, MBEDTLS_RSA_PKCS_V21, MBEDTLS_MD_SHA256);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. generate an RSA keypair */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Generate RSA keypair...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_gen_key(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, <span class="number">2048</span>, <span class="number">65537</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_gen_key returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* shwo RSA keypair */</span></span><br><span class="line">    dump_rsa_key(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. encrypt */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 encrypt...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_encrypt(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PUBLIC, </span><br><span class="line">                                    <span class="built_in">strlen</span>(msg), (<span class="keyword">uint8_t</span> *)msg, output_buf);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_encrypt returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show encrypt result */</span></span><br><span class="line">    dump_buf(output_buf, <span class="keyword">sizeof</span>(output_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. decrypt */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 decrypt...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_decrypt(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PRIVATE, </span><br><span class="line">                                    &amp;olen, output_buf, decrypt_buf, <span class="keyword">sizeof</span>(decrypt_buf));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_decrypt returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show decrypt result */</span></span><br><span class="line">    decrypt_buf[olen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;decrypt result:[%s]\r\n&quot;</span>, decrypt_buf);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_rsa_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_RSA_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-3"><a href="#测试结果-3" class="headerlink" title="测试结果"></a>测试结果</h3><p>在 main.c 中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_rsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后在main函数中调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 5. rsa test */</span></span><br><span class="line">mbedtls_rsa_test();</span><br></pre></td></tr></table></figure>
<h3 id="堆内存空间的设置"><a href="#堆内存空间的设置" class="headerlink" title="堆内存空间的设置"></a>堆内存空间的设置</h3><p><strong>特别注意：</strong></p>
<p>mbedtls RSA算法中的生成秘钥对比较占用空间，再加上RSA算法计算过程涉及到大数运算，所以RSA算法对内存的消耗比较大。</p>
<p>mbedtls使用的是动态内存，从堆空间中分配，所以要在STM32启动文件中将堆空间设置的大一点：<br><img src="https://img-blog.csdnimg.cn/20200928201926696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="测试结果-4"><a href="#测试结果-4" class="headerlink" title="测试结果"></a>测试结果</h3><p>编译、下载到开发板中，可以看到：</p>
<p>① 秘钥对生成结果（花费大概5min左右，主控芯片STM32L431主频为80Mhz）：<br><img src="https://img-blog.csdnimg.cn/20200927143614723.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<p>② 使用公钥加密结果（因为RSA算法中的特性，所以同一份程序，同一份明文，每次重新运行生成的密文也不同）：<br><img src="https://img-blog.csdnimg.cn/20200927143637213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>③ 使用私钥解密结果：<br><img src="https://img-blog.csdnimg.cn/20200927143743879.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h1 id="六、DH秘钥协商算法的配置与使用"><a href="#六、DH秘钥协商算法的配置与使用" class="headerlink" title="六、DH秘钥协商算法的配置与使用"></a>六、DH秘钥协商算法的配置与使用</h1><h2 id="DH秘钥协商算法"><a href="#DH秘钥协商算法" class="headerlink" title="DH秘钥协商算法"></a>DH秘钥协商算法</h2><p>DH是一种秘钥协商算法，使得通信双方在不安全通道交换共享参数，从而协商出一个会话秘钥。</p>
<p>DH秘钥协商的过程如下：</p>
<p>① 通信双方A和B确认共享参数；<br>② A生成随机秘钥x；<br>③ B生成随机秘钥y；<br>④ A计算共享秘钥；<br>⑤ B计算共享秘钥；</p>
<p>DH秘钥协商算法可以有效防止中间窃听者，但是无法方式中间拦截者。</p>
<h2 id="DH秘钥协商功能的配置和使用"><a href="#DH秘钥协商功能的配置和使用" class="headerlink" title="DH秘钥协商功能的配置和使用"></a>DH秘钥协商功能的配置和使用</h2><h3 id="配置宏-3"><a href="#配置宏-3" class="headerlink" title="配置宏"></a>配置宏</h3><p>使用DH秘钥协商功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_GENPRIME</td>
<td>开启生成素数</td>
</tr>
<tr>
<td>MBEDTLS_DHM_C</td>
<td>开启DH秘钥协商模块</td>
</tr>
</tbody></table>
<p>下面补充几个一个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_DHM_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_DHM_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the Diffie-Hellman-Merkle module.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/dhm.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ssl_cli.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_srv.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      DHE-RSA, DHE-PSK</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \warning    Using DHE constitutes a security risk as it</span></span><br><span class="line"><span class="comment"> *             is not possible to validate custom DH parameters.</span></span><br><span class="line"><span class="comment"> *             If possible, it is recommended users should consider</span></span><br><span class="line"><span class="comment"> *             preferring other methods of key exchange.</span></span><br><span class="line"><span class="comment"> *             See dhm.h for more details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_DHM_C</span></span><br></pre></td></tr></table></figure>
<p>编辑针对本实验的配置文件<code>mbedtls_config_dhm.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   Minimal configuration for DHM Function</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/09/28</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_DHM_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_DHM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_DHM_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_DHM_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK配置mbedtls使用该配置文件：<br><img src="https://img-blog.csdnimg.cn/20200928201900998.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="DH秘钥协商功能API说明"><a href="#DH秘钥协商功能API说明" class="headerlink" title="DH秘钥协商功能API说明"></a>DH秘钥协商功能API说明</h3><p>使用该功能模块需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/dhm.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化DH结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function initializes the DHM context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to initialize.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_dhm_init</span><span class="params">( mbedtls_dhm_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 生成公开参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function creates a DHM key pair and exports</span></span><br><span class="line"><span class="comment"> *                 the raw public key in big-endian format.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The destination buffer is always fully written</span></span><br><span class="line"><span class="comment"> *                 so as to contain a big-endian representation of G^X mod P.</span></span><br><span class="line"><span class="comment"> *                 If it is larger than \c ctx-&gt;len, it is padded accordingly</span></span><br><span class="line"><span class="comment"> *                 with zero-bytes at the beginning.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to use. This must be initialized and</span></span><br><span class="line"><span class="comment"> *                 have the DHM parameters set. It may or may not already</span></span><br><span class="line"><span class="comment"> *                 have imported the peer&#x27;s public key.</span></span><br><span class="line"><span class="comment"> * \param x_size   The private key size in Bytes.</span></span><br><span class="line"><span class="comment"> * \param output   The destination buffer. This must be a writable buffer of</span></span><br><span class="line"><span class="comment"> *                 size \p olen Bytes.</span></span><br><span class="line"><span class="comment"> * \param olen     The length of the destination buffer. This must be at least</span></span><br><span class="line"><span class="comment"> *                 equal to `ctx-&gt;len` (the size of \c P).</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be \c NULL</span></span><br><span class="line"><span class="comment"> *                 if \p f_rng doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_DHM_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_make_public</span><span class="params">( mbedtls_dhm_context *ctx, <span class="keyword">int</span> x_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 读取公开参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function imports the raw public value of the peer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           In a TLS handshake, this is the how the server imports</span></span><br><span class="line"><span class="comment"> *                 the Client&#x27;s public DHM key.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to use. This must be initialized and have</span></span><br><span class="line"><span class="comment"> *                 its DHM parameters set, e.g. via mbedtls_dhm_set_group().</span></span><br><span class="line"><span class="comment"> *                 It may or may not already have generated its own private key.</span></span><br><span class="line"><span class="comment"> * \param input    The input buffer containing the \c G^Y value of the peer.</span></span><br><span class="line"><span class="comment"> *                 This must be a readable buffer of size \p ilen Bytes.</span></span><br><span class="line"><span class="comment"> * \param ilen     The size of the input buffer \p input in Bytes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_DHM_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_read_public</span><span class="params">( mbedtls_dhm_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 计算共享秘钥：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function derives and exports the shared secret</span></span><br><span class="line"><span class="comment"> *                 \c (G^Y)^X mod \c P.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           If \p f_rng is not \c NULL, it is used to blind the input as</span></span><br><span class="line"><span class="comment"> *                 a countermeasure against timing attacks. Blinding is used</span></span><br><span class="line"><span class="comment"> *                 only if our private key \c X is re-used, and not used</span></span><br><span class="line"><span class="comment"> *                 otherwise. We recommend always passing a non-NULL</span></span><br><span class="line"><span class="comment"> *                 \p f_rng argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx           The DHM context to use. This must be initialized</span></span><br><span class="line"><span class="comment"> *                      and have its own private key generated and the peer&#x27;s</span></span><br><span class="line"><span class="comment"> *                      public key imported.</span></span><br><span class="line"><span class="comment"> * \param output        The buffer to write the generated shared key to. This</span></span><br><span class="line"><span class="comment"> *                      must be a writable buffer of size \p output_size Bytes.</span></span><br><span class="line"><span class="comment"> * \param output_size   The size of the destination buffer. This must be at</span></span><br><span class="line"><span class="comment"> *                      least the size of \c ctx-&gt;len (the size of \c P).</span></span><br><span class="line"><span class="comment"> * \param olen          On exit, holds the actual number of Bytes written.</span></span><br><span class="line"><span class="comment"> * \param f_rng         The RNG function, for blinding purposes. This may</span></span><br><span class="line"><span class="comment"> *                      b \c NULL if blinding isn&#x27;t needed.</span></span><br><span class="line"><span class="comment"> * \param p_rng         The RNG context. This may be \c NULL if \p f_rng</span></span><br><span class="line"><span class="comment"> *                      doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return              \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return              An \c MBEDTLS_ERR_DHM_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_calc_secret</span><span class="params">( mbedtls_dhm_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> output_size, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 释放DH结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function frees and clears the components</span></span><br><span class="line"><span class="comment"> *                 of a DHM context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to free and clear. This may be \c NULL,</span></span><br><span class="line"><span class="comment"> *                 in which case this function is a no-op. If it is not \c NULL,</span></span><br><span class="line"><span class="comment"> *                 it must point to an initialized DHM context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_dhm_free</span><span class="params">( mbedtls_dhm_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_BAD_INPUT_DATA                    -0x3080  <span class="comment">/**&lt; Bad input parameters. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_READ_PARAMS_FAILED                -0x3100  <span class="comment">/**&lt; Reading of the DHM parameters failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_MAKE_PARAMS_FAILED                -0x3180  <span class="comment">/**&lt; Making of the DHM parameters failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_READ_PUBLIC_FAILED                -0x3200  <span class="comment">/**&lt; Reading of the public values failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_MAKE_PUBLIC_FAILED                -0x3280  <span class="comment">/**&lt; Making of the public value failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_CALC_SECRET_FAILED                -0x3300  <span class="comment">/**&lt; Calculation of the DHM secret failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_INVALID_FORMAT                    -0x3380  <span class="comment">/**&lt; The ASN.1 data is not formatted correctly. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_ALLOC_FAILED                      -0x3400  <span class="comment">/**&lt; Allocation of memory failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_FILE_IO_ERROR                     -0x3480  <span class="comment">/**&lt; Read or write of file failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MBEDTLS_ERR_DHM_HW_ACCEL_FAILED is deprecated and should not be used. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_HW_ACCEL_FAILED                   -0x3500  <span class="comment">/**&lt; DHM hardware accelerator failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_SET_GROUP_FAILED                  -0x3580  <span class="comment">/**&lt; Setting the modulus and generator failed. */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-3"><a href="#编写测试函数-3" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>新建测试文件``，编写以下测试内容，其中服务器和客户端之间直接通信，没有采用网络通信：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_DHM_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/dhm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATOR   <span class="meta-string">&quot;2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T_P          <span class="meta-string">&quot;FFFFFFFFFFFFFFFFADF85458A2BB4A9AAFDC5620273D3CF1D8B9C583CE2D3695&quot;</span> \</span></span><br><span class="line">                     <span class="string">&quot;A9E13641146433FBCC939DCE249B3EF97D2FE363630C75D8F681B202AEC4617A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;D3DF1ED5D5FD65612433F51F5F066ED0856365553DED1AF3B557135E7F57C935&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;984F0C70E0E68B77E2A689DAF3EFE8721DF158A136ADE73530ACCA4F483A797A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;BC0AB182B324FB61D108A94BB2C8E3FBB96ADAB760D7F4681D4F42A3DE394DF4&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;AE56EDE76372BB190B07A7C8EE0A6D709E02FCE1CDF7E2ECC03404CD28342F61&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;9172FE9CE98583FF8E4F1232EEF28183C3FE3B1B4C6FAD733BB5FCBC2EC22005&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;C58EF1837D1683B2C6F34A26C1B2EFFA886B423861285C97FFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> server_pub[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> client_pub[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> server_secret[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> client_secret[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;dhm_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_dhm_context dhm_server, dhm_client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_dhm_init(&amp;dhm_server);</span><br><span class="line">    mbedtls_dhm_init(&amp;dhm_client);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. genetate 2048 bit prime(G, P) */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Genetate 2048 bit prime(G, P)...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_server.P, <span class="number">16</span>, T_P);</span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_server.G, <span class="number">10</span>, GENERATOR);</span><br><span class="line">    dhm_server.len = mbedtls_mpi_size(&amp;dhm_server.P);</span><br><span class="line">    </span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_client.P, <span class="number">16</span>, T_P);</span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_client.G, <span class="number">10</span>, GENERATOR);</span><br><span class="line">    dhm_client.len = mbedtls_mpi_size(&amp;dhm_client.P);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ok\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. Server create a DHM key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server creates a DHM key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_make_public(&amp;dhm_server, <span class="number">256</span>, server_pub, <span class="keyword">sizeof</span>(server_pub), mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_make_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    dump_buf(server_pub, <span class="keyword">sizeof</span>(server_pub));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. Client creates a DHM key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client create a DHM key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_make_public(&amp;dhm_client, <span class="number">256</span>, client_pub, <span class="keyword">sizeof</span>(client_pub), mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_make_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    dump_buf(client_pub, <span class="keyword">sizeof</span>(client_pub));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. Server Read public key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server Read public key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_read_public(&amp;dhm_server, client_pub, <span class="keyword">sizeof</span>(client_pub));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_read_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. Client Read public key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client Read public key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_read_public(&amp;dhm_client, server_pub, <span class="keyword">sizeof</span>(server_pub));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_read_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> ); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 8. calc the shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server calc the shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_calc_secret(&amp;dhm_server, server_secret, <span class="keyword">sizeof</span>(server_secret), &amp;olen, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_calc_secret returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> ); </span><br><span class="line">    dump_buf(server_secret, <span class="keyword">sizeof</span>(server_secret));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 9. calc the shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client calc the shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_calc_secret(&amp;dhm_client, client_secret, <span class="keyword">sizeof</span>(client_secret), &amp;olen, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_calc_secret returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> ); </span><br><span class="line">    dump_buf(client_secret, <span class="keyword">sizeof</span>(client_secret));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 10. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_dhm_free(&amp;dhm_server);</span><br><span class="line">    mbedtls_dhm_free(&amp;dhm_client);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_DHM_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-5"><a href="#测试结果-5" class="headerlink" title="测试结果"></a>测试结果</h3><p>在 mian.c 中声明此测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_dhm_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后在main函数中调用测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 6. dh test */</span></span><br><span class="line">mbedtls_dhm_test();</span><br></pre></td></tr></table></figure>
<p>因为本实验内存消耗较大，需要加大堆空间：<br><img src="https://img-blog.csdnimg.cn/20200929152619282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>编译、下载、测试结果如下。</p>
<p>① 服务端生成的公开参数：<br><img src="https://img-blog.csdnimg.cn/20200929152724594.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>② 客户端生成的公开参数（<strong>可以看到与服务端的公开参数不同</strong>）：<br><img src="https://img-blog.csdnimg.cn/20200929152750286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>③ 服务端计算共享秘钥：<br><img src="https://img-blog.csdnimg.cn/20200929152846684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>④ 客户端计算共享秘钥（<strong>可以看到与服务端相同</strong>）：<br><img src="https://img-blog.csdnimg.cn/20200929152907206.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h1 id="七、ECDH秘钥协商算法的配置与使用"><a href="#七、ECDH秘钥协商算法的配置与使用" class="headerlink" title="七、ECDH秘钥协商算法的配置与使用"></a>七、ECDH秘钥协商算法的配置与使用</h1><h2 id="ECDH秘钥协商算法"><a href="#ECDH秘钥协商算法" class="headerlink" title="ECDH秘钥协商算法"></a>ECDH秘钥协商算法</h2><p>ECDH是一种秘钥协商算法，使得通信双方在不安全通道交换共享参数，从而使用共享参数和自身私密参数计算出一个会话秘钥。</p>
<p>ECDH秘钥协商算法基于椭圆曲线密码系统（ECC），使用较短的秘钥长度可提供与RSA或DH算法同样的安全等级，<strong>秘钥长度为160-256bit的椭圆曲线算法，与1024-3072bit的非ECC算法安全强度相同</strong>。</p>
<p>ECDH秘钥协商的过程如下：</p>
<p>① 通信双方选择共同的椭圆曲线方程、相同的大素数P、相同的生成元G；</p>
<p>② 通信方A生成一个随机数作为自己的私钥，通过椭圆曲线标量乘法得到公开参数（公钥）；</p>
<p>③ 通信方B生成一个随机数作为自己的私钥，通过椭圆曲线标量乘法得到公开参数（公钥）；</p>
<p>④ 通信双方交换公钥，和自己的私钥一起计算得到共同的会话秘钥。</p>
<h2 id="ECDH秘钥协商功能的配置和使用"><a href="#ECDH秘钥协商功能的配置和使用" class="headerlink" title="ECDH秘钥协商功能的配置和使用"></a>ECDH秘钥协商功能的配置和使用</h2><h3 id="配置宏-4"><a href="#配置宏-4" class="headerlink" title="配置宏"></a>配置宏</h3><p>使用ECDH秘钥协商功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_ECP_C</td>
<td>开启椭圆曲线基础运算</td>
</tr>
<tr>
<td>MBEDTLS_ECDH_C</td>
<td>开启椭圆曲线秘钥协商算法模块</td>
</tr>
<tr>
<td>MBEDTLS_ECP_DP_SECP256R1_ENABLED</td>
<td>选择secp256r1曲线参数</td>
</tr>
</tbody></table>
<p>下面补充几个一个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_ECP_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECP_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the elliptic curve over GF(p) library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/ecp.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ecdh.c</span></span><br><span class="line"><span class="comment"> *          library/ecdsa.c</span></span><br><span class="line"><span class="comment"> *          library/ecjpake.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_BIGNUM_C and at least one MBEDTLS_ECP_DP_XXX_ENABLED</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_ECDH_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECDH_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the elliptic curve Diffie-Hellman library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/ecdh.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ssl_cli.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_srv.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      ECDHE-ECDSA, ECDHE-RSA, DHE-PSK</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_ECP_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDH_C</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_ECP_DP_SECP256R1_ENABLED</strong>（至少开启一种）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECP_DP_SECP192R1_ENABLED</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * MBEDTLS_ECP_XXXX_ENABLED: Enables specific curves within the Elliptic Curve</span></span><br><span class="line"><span class="comment"> * module.  By default all supported curves are enabled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Comment macros to disable the curve and functions for it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP192R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP224R1_ENABLED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP384R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP521R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP192K1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP224K1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP256K1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_BP256R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_BP384R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_BP512R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_CURVE25519_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_CURVE448_ENABLED</span></span><br></pre></td></tr></table></figure>
<p>编辑针对本实验的配置文件<code>mbedtls_config_ecdh.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_ECDH_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_ECDH_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDH_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_ECDH_H_ */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="ECDH秘钥协商功能API说明"><a href="#ECDH秘钥协商功能API说明" class="headerlink" title="ECDH秘钥协商功能API说明"></a>ECDH秘钥协商功能API说明</h3><p>① 初始化椭圆曲线群结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function initializes an ECP group context</span></span><br><span class="line"><span class="comment"> *                  without loading any domain parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            After this function is called, domain parameters</span></span><br><span class="line"><span class="comment"> *                  for various ECP groups can be loaded through the</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_group_load() or mbedtls_ecp_tls_read_group()</span></span><br><span class="line"><span class="comment"> *                  functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_group_init</span><span class="params">( mbedtls_ecp_group *grp )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 初始化椭圆曲线点结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function initializes an ECP group context</span></span><br><span class="line"><span class="comment"> *                  without loading any domain parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            After this function is called, domain parameters</span></span><br><span class="line"><span class="comment"> *                  for various ECP groups can be loaded through the</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_group_load() or mbedtls_ecp_tls_read_group()</span></span><br><span class="line"><span class="comment"> *                  functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_group_init</span><span class="params">( mbedtls_ecp_group *grp )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 加载椭圆曲线：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function sets up an ECP group context</span></span><br><span class="line"><span class="comment"> *                  from a standardized set of domain parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            The index should be a value of the NamedCurve enum,</span></span><br><span class="line"><span class="comment"> *                  as defined in &lt;em&gt;RFC-4492: Elliptic Curve Cryptography</span></span><br><span class="line"><span class="comment"> *                  (ECC) Cipher Suites for Transport Layer Security (TLS)&lt;/em&gt;,</span></span><br><span class="line"><span class="comment"> *                  usually in the form of an \c MBEDTLS_ECP_DP_XXX macro.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The group context to setup. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param id        The identifier of the domain parameter set to load.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          #MBEDTLS_ERR_ECP_FEATURE_UNAVAILABLE if \p id doesn&#x27;t</span></span><br><span class="line"><span class="comment"> *                  correspond to a known group.</span></span><br><span class="line"><span class="comment"> * \return          Another negative error code on other kinds of failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecp_group_load</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_ecp_group_id id )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 生成公开参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function generates an ECDH keypair on an elliptic</span></span><br><span class="line"><span class="comment"> *                  curve.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                  This function performs the first of two core computations</span></span><br><span class="line"><span class="comment"> *                  implemented during the ECDH key exchange. The second core</span></span><br><span class="line"><span class="comment"> *                  computation is performed by mbedtls_ecdh_compute_shared().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The ECP group to use. This must be initialized and have</span></span><br><span class="line"><span class="comment"> *                  domain parameters loaded, for example through</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_load() or mbedtls_ecp_tls_read_group().</span></span><br><span class="line"><span class="comment"> * \param d         The destination MPI (private key).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param Q         The destination point (public key).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param f_rng     The RNG function to use. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng     The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                  \c NULL in case \p f_rng doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          Another \c MBEDTLS_ERR_ECP_XXX or</span></span><br><span class="line"><span class="comment"> *                  \c MBEDTLS_MPI_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdh_gen_public</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_mpi *d, mbedtls_ecp_point *Q,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 计算共享秘钥：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function computes the shared secret.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                  This function performs the second of two core computations</span></span><br><span class="line"><span class="comment"> *                  implemented during the ECDH key exchange. The first core</span></span><br><span class="line"><span class="comment"> *                  computation is performed by mbedtls_ecdh_gen_public().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            If \p f_rng is not NULL, it is used to implement</span></span><br><span class="line"><span class="comment"> *                  countermeasures against side-channel attacks.</span></span><br><span class="line"><span class="comment"> *                  For more information, see mbedtls_ecp_mul().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The ECP group to use. This must be initialized and have</span></span><br><span class="line"><span class="comment"> *                  domain parameters loaded, for example through</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_load() or mbedtls_ecp_tls_read_group().</span></span><br><span class="line"><span class="comment"> * \param z         The destination MPI (shared secret).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param Q         The public key from another party.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param d         Our secret exponent (private key).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param f_rng     The RNG function. This may be \c NULL if randomization</span></span><br><span class="line"><span class="comment"> *                  of intermediate results during the ECP computations is</span></span><br><span class="line"><span class="comment"> *                  not needed (discouraged). See the documentation of</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_mul() for more.</span></span><br><span class="line"><span class="comment"> * \param p_rng     The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                  \c NULL if \p f_rng is \c NULL or doesn&#x27;t need a</span></span><br><span class="line"><span class="comment"> *                  context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          Another \c MBEDTLS_ERR_ECP_XXX or</span></span><br><span class="line"><span class="comment"> *                  \c MBEDTLS_MPI_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdh_compute_shared</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_mpi *z,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> mbedtls_ecp_point *Q, <span class="keyword">const</span> mbedtls_mpi *d,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ 释放椭圆曲线群结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function frees the components of an ECP group.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The group to free. This may be \c NULL, in which</span></span><br><span class="line"><span class="comment"> *                  case this function returns immediately. If it is not</span></span><br><span class="line"><span class="comment"> *                  \c NULL, it must point to an initialized ECP group.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_group_free</span><span class="params">( mbedtls_ecp_group *grp )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ 释放椭圆曲线点结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function frees the components of a point.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param pt        The point to free.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_point_free</span><span class="params">( mbedtls_ecp_point *pt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑧ 错误码（ECP计算部分）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ECP error codes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_BAD_INPUT_DATA                    -0x4F80  <span class="comment">/**&lt; Bad input parameters to function. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_BUFFER_TOO_SMALL                  -0x4F00  <span class="comment">/**&lt; The buffer is too small to write to. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_FEATURE_UNAVAILABLE               -0x4E80  <span class="comment">/**&lt; The requested feature is not available, for example, the requested curve is not supported. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_VERIFY_FAILED                     -0x4E00  <span class="comment">/**&lt; The signature is not valid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_ALLOC_FAILED                      -0x4D80  <span class="comment">/**&lt; Memory allocation failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_RANDOM_FAILED                     -0x4D00  <span class="comment">/**&lt; Generation of random value, such as ephemeral key, failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_INVALID_KEY                       -0x4C80  <span class="comment">/**&lt; Invalid private or public key. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_SIG_LEN_MISMATCH                  -0x4C00  <span class="comment">/**&lt; The buffer contains a valid signature followed by more data. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MBEDTLS_ERR_ECP_HW_ACCEL_FAILED is deprecated and should not be used. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_HW_ACCEL_FAILED                   -0x4B80  <span class="comment">/**&lt; The ECP hardware accelerator failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_IN_PROGRESS                       -0x4B00  <span class="comment">/**&lt; Operation in progress, call again with the same parameters to continue. */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-4"><a href="#编写测试函数-4" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>新建测试文件<code>mbedtls_ecdh_test.c</code>，编写以下测试内容，其中服务器和客户端之间直接通信，没有采用网络通信：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_ECDH_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ecdh.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATOR   <span class="meta-string">&quot;2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T_P          <span class="meta-string">&quot;FFFFFFFFFFFFFFFFADF85458A2BB4A9AAFDC5620273D3CF1D8B9C583CE2D3695&quot;</span> \</span></span><br><span class="line">                     <span class="string">&quot;A9E13641146433FBCC939DCE249B3EF97D2FE363630C75D8F681B202AEC4617A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;D3DF1ED5D5FD65612433F51F5F066ED0856365553DED1AF3B557135E7F57C935&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;984F0C70E0E68B77E2A689DAF3EFE8721DF158A136ADE73530ACCA4F483A797A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;BC0AB182B324FB61D108A94BB2C8E3FBB96ADAB760D7F4681D4F42A3DE394DF4&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;AE56EDE76372BB190B07A7C8EE0A6D709E02FCE1CDF7E2ECC03404CD28342F61&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;9172FE9CE98583FF8E4F1232EEF28183C3FE3B1B4C6FAD733BB5FCBC2EC22005&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;C58EF1837D1683B2C6F34A26C1B2EFFA886B423861285C97FFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> buf[<span class="number">65</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdh_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;ecdh_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_ecp_point client_pub, server_pub;</span><br><span class="line">    mbedtls_ecp_group grp;</span><br><span class="line">    mbedtls_mpi client_secret, server_secret;</span><br><span class="line">    mbedtls_mpi client_pri, server_pri;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_mpi_init(&amp;client_secret);</span><br><span class="line">    mbedtls_mpi_init(&amp;server_secret);</span><br><span class="line">    mbedtls_mpi_init(&amp;client_pri);</span><br><span class="line">    mbedtls_mpi_init(&amp;server_pri);</span><br><span class="line">    mbedtls_ecp_group_init(&amp;grp);</span><br><span class="line">    mbedtls_ecp_point_init(&amp;client_pub);</span><br><span class="line">    mbedtls_ecp_point_init(&amp;server_pub);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3.  select ecp group SECP256R1 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Select ecp group SECP256R1...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecp_group_load(&amp;grp, MBEDTLS_ECP_DP_SECP256R1);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecp_group_load returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ok\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. Client generate public parameter */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client Generate public parameter...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_gen_public(&amp;grp, &amp;client_pri, &amp;client_pub, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_gen_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_ecp_point_write_binary(&amp;grp, &amp;client_pub, MBEDTLS_ECP_PF_UNCOMPRESSED, &amp;olen, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. Client generate public parameter */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server Generate public parameter...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_gen_public(&amp;grp, &amp;server_pri, &amp;server_pub, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_gen_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_ecp_point_write_binary(&amp;grp, &amp;server_pub, MBEDTLS_ECP_PF_UNCOMPRESSED, &amp;olen, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. Calc shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client Calc shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_compute_shared(&amp;grp, &amp;client_secret, &amp;server_pub, &amp;client_pri, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_compute_shared returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_mpi_write_binary(&amp;client_secret, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. Server Calc shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server Calc shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_compute_shared(&amp;grp, &amp;server_secret, &amp;client_pub, &amp;server_pri, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_compute_shared returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_mpi_write_binary(&amp;server_secret, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 8. mpi compare */</span></span><br><span class="line">    ret = mbedtls_mpi_cmp_mpi(&amp;server_secret, &amp;client_secret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;compare result: %d\r\n&quot;</span>, ret);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 10. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_mpi_free(&amp;client_secret);</span><br><span class="line">    mbedtls_mpi_free(&amp;server_secret);</span><br><span class="line">    mbedtls_mpi_free(&amp;client_pri);</span><br><span class="line">    mbedtls_mpi_free(&amp;server_pri);</span><br><span class="line">    mbedtls_ecp_group_free(&amp;grp);</span><br><span class="line">    mbedtls_ecp_point_free(&amp;client_pub);</span><br><span class="line">    mbedtls_ecp_point_free(&amp;server_pub);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_DHM_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="调用测试函数"><a href="#调用测试函数" class="headerlink" title="调用测试函数"></a>调用测试函数</h3><p>在 main.c 中声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_ecdh_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在 main 函数中调用此测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 7. ecdh test */</span></span><br><span class="line">mbedtls_ecdh_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载、在串口助手查看结果：<br><img src="https://img-blog.csdnimg.cn/20200930161558673.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h1 id="八、数字签名算法的配置与使用（RSA数字签名算法、ECDSA数字签名算法）"><a href="#八、数字签名算法的配置与使用（RSA数字签名算法、ECDSA数字签名算法）" class="headerlink" title="八、数字签名算法的配置与使用（RSA数字签名算法、ECDSA数字签名算法）"></a>八、数字签名算法的配置与使用（RSA数字签名算法、ECDSA数字签名算法）</h1><h2 id="数字签名算法"><a href="#数字签名算法" class="headerlink" title="数字签名算法"></a>数字签名算法</h2><h3 id="什么是数字签名"><a href="#什么是数字签名" class="headerlink" title="什么是数字签名"></a>什么是数字签名</h3><p>数字签名类似于盖章和签字，数字签名可以检查消息是否被篡改、并验证消息的可靠性，因为私钥只有签名者持有，所以还可以防止否认。</p>
<h3 id="数字签名算法-1"><a href="#数字签名算法-1" class="headerlink" title="数字签名算法"></a>数字签名算法</h3><p>① <strong>RSA数字签名</strong></p>
<p>RSA数字签名算法基于RSA非对称加密算法，在用于数字签名时公钥和私钥的用法刚好相反：</p>
<ul>
<li>发送方使用私钥对消息执行加密操作 = 对消息进行签名；</li>
<li>接收方使用公钥对签名进行解密 = 对签名进行认证；</li>
</ul>
<p>RSA签名算法还需要包括填充方法，有两种：PKCS1-V1.5和PSS（使用随机数填充，<strong>推荐使用</strong>）。</p>
<p>② <strong>DSA算法</strong></p>
<p>③ <strong>ECDSA算法</strong></p>
<p>在相同的安全等级下，ECDSA算法具有秘钥短、执行效率高的特点，更适合物联网应用。</p>
<h2 id="RSA数字签名功能模块的配置与使用"><a href="#RSA数字签名功能模块的配置与使用" class="headerlink" title="RSA数字签名功能模块的配置与使用"></a>RSA数字签名功能模块的配置与使用</h2><h3 id="配置宏-5"><a href="#配置宏-5" class="headerlink" title="配置宏"></a>配置宏</h3><p>使用RSA功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_GENPRIME</td>
<td>开启生成素数</td>
</tr>
<tr>
<td>MBEDTLS_OID_C</td>
<td>开启OID数据结构模块</td>
</tr>
<tr>
<td>MBEDTLS_RSA_C</td>
<td>开启RSA算法</td>
</tr>
<tr>
<td>MBEDTLS_PKCS1_V21</td>
<td>开启PKCS#1 v2.1填充方案（OAEP）</td>
</tr>
</tbody></table>
<p>新建配置文件<code>mbedtls_config_rsa_sign.h</code>，编写以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_RSA_SIGN_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_RSA_SIGN_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_RSA_SIGN_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK中设置使用该配置文件：<br><img src="https://img-blog.csdnimg.cn/20201003110740288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="RSA数字签名功能模块API说明"><a href="#RSA数字签名功能模块API说明" class="headerlink" title="RSA数字签名功能模块API说明"></a>RSA数字签名功能模块API说明</h3><p>使用该功能模块需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① RSA签名接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function performs a private RSA operation to sign</span></span><br><span class="line"><span class="comment"> *                 a message digest using PKCS#1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 It is the generic wrapper for performing a PKCS#1</span></span><br><span class="line"><span class="comment"> *                 signature using the \p mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The \p sig buffer must be as large as the size</span></span><br><span class="line"><span class="comment"> *                 of \p ctx-&gt;N. For example, 128 Bytes if RSA-1024 is used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           For PKCS#1 v2.1 encoding, see comments on</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_rsassa_pss_sign() for details on</span></span><br><span class="line"><span class="comment"> *                 \p md_alg and \p hash_id.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PUBLIC mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 implicitly set to #MBEDTLS_RSA_PRIVATE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PUBLIC and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to use. If the padding mode is PKCS#1 v2.1,</span></span><br><span class="line"><span class="comment"> *                 this must be provided. If the padding mode is PKCS#1 v1.5 and</span></span><br><span class="line"><span class="comment"> *                 \p mode is #MBEDTLS_RSA_PRIVATE, it is used for blinding</span></span><br><span class="line"><span class="comment"> *                 and should be provided; see mbedtls_rsa_private() for more</span></span><br><span class="line"><span class="comment"> *                 more. It is ignored otherwise.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be \c NULL</span></span><br><span class="line"><span class="comment"> *                 if \p f_rng is \c NULL or doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PRIVATE or #MBEDTLS_RSA_PUBLIC (deprecated).</span></span><br><span class="line"><span class="comment"> * \param md_alg   The message-digest algorithm used to hash the original data.</span></span><br><span class="line"><span class="comment"> *                 Use #MBEDTLS_MD_NONE for signing raw data.</span></span><br><span class="line"><span class="comment"> * \param hashlen  The length of the message digest.</span></span><br><span class="line"><span class="comment"> *                 Ths is only used if \p md_alg is #MBEDTLS_MD_NONE.</span></span><br><span class="line"><span class="comment"> * \param hash     The buffer holding the message digest or raw data.</span></span><br><span class="line"><span class="comment"> *                 If \p md_alg is #MBEDTLS_MD_NONE, this must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \p hashlen Bytes. If \p md_alg is not</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_MD_NONE, it must be a readable buffer of length</span></span><br><span class="line"><span class="comment"> *                 the size of the hash corresponding to \p md_alg.</span></span><br><span class="line"><span class="comment"> * \param sig      The buffer to hold the signature. This must be a writable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus. A buffer length of</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_MPI_MAX_SIZE is always safe.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if the signing operation was successful.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_sign</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mbedtls_md_type_t</span> md_alg,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> hashlen,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *hash,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">char</span> *sig )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② RSA验证签名接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function performs a public RSA operation and checks</span></span><br><span class="line"><span class="comment"> *                 the message digest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 This is the generic wrapper for performing a PKCS#1</span></span><br><span class="line"><span class="comment"> *                 verification using the mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           For PKCS#1 v2.1 encoding, see comments on</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_rsassa_pss_verify() about \p md_alg and</span></span><br><span class="line"><span class="comment"> *                 \p hash_id.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PRIVATE mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 set to #MBEDTLS_RSA_PUBLIC.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PRIVATE and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA public key context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to use. If \p mode is #MBEDTLS_RSA_PRIVATE,</span></span><br><span class="line"><span class="comment"> *                 this is used for blinding and should be provided; see</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_private() for more. Otherwise, it is ignored.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng is \c NULL or doesn&#x27;t need a context.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PUBLIC or #MBEDTLS_RSA_PRIVATE (deprecated).</span></span><br><span class="line"><span class="comment"> * \param md_alg   The message-digest algorithm used to hash the original data.</span></span><br><span class="line"><span class="comment"> *                 Use #MBEDTLS_MD_NONE for signing raw data.</span></span><br><span class="line"><span class="comment"> * \param hashlen  The length of the message digest.</span></span><br><span class="line"><span class="comment"> *                 This is only used if \p md_alg is #MBEDTLS_MD_NONE.</span></span><br><span class="line"><span class="comment"> * \param hash     The buffer holding the message digest or raw data.</span></span><br><span class="line"><span class="comment"> *                 If \p md_alg is #MBEDTLS_MD_NONE, this must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \p hashlen Bytes. If \p md_alg is not</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_MD_NONE, it must be a readable buffer of length</span></span><br><span class="line"><span class="comment"> *                 the size of the hash corresponding to \p md_alg.</span></span><br><span class="line"><span class="comment"> * \param sig      The buffer holding the signature. This must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if the verify operation was successful.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_verify</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">mbedtls_md_type_t</span> md_alg,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> <span class="keyword">int</span> hashlen,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *hash,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *sig )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-5"><a href="#编写测试函数-5" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>新建文件<code>mbedtls_rsa_sign_test.c</code>，编写以下测试内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_RSA_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">516</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_rsa_key</span><span class="params">(mbedtls_rsa_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;N , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;N: %s\n&quot;</span>, buf); </span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;E , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;E: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;D , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;D: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;P , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;P: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;Q , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Q: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DP: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DQ, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DQ: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;QP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;QP: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> output_buf[<span class="number">2048</span>/<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_sign_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;rsa_sign_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_rsa_context ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_rsa_init(&amp;ctx, MBEDTLS_RSA_PKCS_V21, MBEDTLS_MD_SHA256);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. generate an RSA keypair */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Generate RSA keypair...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_gen_key(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, <span class="number">2048</span>, <span class="number">65537</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_gen_key returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* shwo RSA keypair */</span></span><br><span class="line">    dump_rsa_key(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. sign */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 sign...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_sign(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PRIVATE, MBEDTLS_MD_SHA256, <span class="built_in">strlen</span>(msg), (<span class="keyword">uint8_t</span> *)msg, output_buf);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_sign returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show sign result */</span></span><br><span class="line">    dump_buf(output_buf, <span class="keyword">sizeof</span>(output_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. verify sign*/</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 verify...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_verify(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PUBLIC, MBEDTLS_MD_SHA256, <span class="built_in">strlen</span>(msg), (<span class="keyword">uint8_t</span> *)msg, output_buf);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_encrypt returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_rsa_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_RSA_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-6"><a href="#测试结果-6" class="headerlink" title="测试结果"></a>测试结果</h3><p>在main.c中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_rsa_sign_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在main函数中调用该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 8. rsa sign test */</span></span><br><span class="line">mbedtls_rsa_sign_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载，在串口助手中查看测试结果：</p>
<p>① 生成秘钥对成功（需要几min的时间）：<br><img src="https://img-blog.csdnimg.cn/20201003113344994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>② 生成签名和验证签名成功：<br><img src="https://img-blog.csdnimg.cn/20201003113416619.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h2 id="ECDSA数字签名功能模块的配置与使用"><a href="#ECDSA数字签名功能模块的配置与使用" class="headerlink" title="ECDSA数字签名功能模块的配置与使用"></a>ECDSA数字签名功能模块的配置与使用</h2><h3 id="配置宏-6"><a href="#配置宏-6" class="headerlink" title="配置宏"></a>配置宏</h3><p>使用ECDSA秘钥协商功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_ECP_C</td>
<td>开启椭圆曲线基础运算</td>
</tr>
<tr>
<td>MBEDTLS_ECP_DP_SECP256R1_ENABLED</td>
<td>选择secp256r1曲线参数</td>
</tr>
<tr>
<td>MBEDTLS_ECDSA_C</td>
<td>开启ECDSA算法</td>
</tr>
<tr>
<td>MBEDTLS_ASN1_WRITE_C</td>
<td>开启ASN1格式写入</td>
</tr>
<tr>
<td>MBEDTLS_ASN1_PARSE_C</td>
<td>开启ASN1结构解析</td>
</tr>
</tbody></table>
<p>下面补充几个一个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_ECDSA_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECDSA_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the elliptic curve DSA library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/ecdsa.c</span></span><br><span class="line"><span class="comment"> * Caller:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      ECDHE-ECDSA</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_ECP_C, MBEDTLS_ASN1_WRITE_C, MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDSA_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_ASN1_WRITE_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ASN1_WRITE_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the generic ASN1 writer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/asn1write.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ecdsa.c</span></span><br><span class="line"><span class="comment"> *          library/pkwrite.c</span></span><br><span class="line"><span class="comment"> *          library/x509_create.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_crt.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_csr.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_ASN1_PARSE_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the generic ASN1 parser.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/asn1.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/x509.c</span></span><br><span class="line"><span class="comment"> *          library/dhm.c</span></span><br><span class="line"><span class="comment"> *          library/pkcs12.c</span></span><br><span class="line"><span class="comment"> *          library/pkcs5.c</span></span><br><span class="line"><span class="comment"> *          library/pkparse.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>新建配置文件<code>mbedtls_config_ecdsa.h</code>，编写以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_ECDSA_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_ECDSA_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_ECDSA_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK中配置使用该配置文件：<img src="https://img-blog.csdnimg.cn/20201003170538611.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="ECDSA签名功能API说明"><a href="#ECDSA签名功能API说明" class="headerlink" title="ECDSA签名功能API说明"></a>ECDSA签名功能API说明</h3><p>① 初始化ECDSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function initializes an ECDSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx       The ECDSA context to initialize.</span></span><br><span class="line"><span class="comment"> *                  This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecdsa_init</span><span class="params">( mbedtls_ecdsa_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② ECDSA生成秘钥接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function generates an ECDSA keypair on the given curve.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see            ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The ECDSA context to store the keypair in.</span></span><br><span class="line"><span class="comment"> *                 This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param gid      The elliptic curve to use. One of the various</span></span><br><span class="line"><span class="comment"> *                 \c MBEDTLS_ECP_DP_XXX macros depending on configuration.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to use. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_ECP_XXX code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_genkey</span><span class="params">( mbedtls_ecdsa_context *ctx, mbedtls_ecp_group_id gid,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>), <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ ECDSA签名接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function computes the ECDSA signature of a</span></span><br><span class="line"><span class="comment"> *                  previously-hashed message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            The deterministic version implemented in</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecdsa_sign_det() is usually preferred.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            If the bitlength of the message hash is larger than the</span></span><br><span class="line"><span class="comment"> *                  bitlength of the group order, then the hash is truncated</span></span><br><span class="line"><span class="comment"> *                  as defined in &lt;em&gt;Standards for Efficient Cryptography Group</span></span><br><span class="line"><span class="comment"> *                  (SECG): SEC1 Elliptic Curve Cryptography&lt;/em&gt;, section</span></span><br><span class="line"><span class="comment"> *                  4.1.3, step 5.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The context for the elliptic curve to use.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized and have group parameters</span></span><br><span class="line"><span class="comment"> *                  set, for example through mbedtls_ecp_group_load().</span></span><br><span class="line"><span class="comment"> * \param r         The MPI context in which to store the first part</span></span><br><span class="line"><span class="comment"> *                  the signature. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param s         The MPI context in which to store the second part</span></span><br><span class="line"><span class="comment"> *                  the signature. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param d         The private signing key. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param buf       The content to be signed. This is usually the hash of</span></span><br><span class="line"><span class="comment"> *                  the original data to be signed. This must be a readable</span></span><br><span class="line"><span class="comment"> *                  buffer of length \p blen Bytes. It may be \c NULL if</span></span><br><span class="line"><span class="comment"> *                  \p blen is zero.</span></span><br><span class="line"><span class="comment"> * \param blen      The length of \p buf in Bytes.</span></span><br><span class="line"><span class="comment"> * \param f_rng     The RNG function. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng     The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                  \c NULL if \p f_rng doesn&#x27;t need a context parameter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          An \c MBEDTLS_ERR_ECP_XXX</span></span><br><span class="line"><span class="comment"> *                  or \c MBEDTLS_MPI_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_sign</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_mpi *r, mbedtls_mpi *s,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> mbedtls_mpi *d, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> blen,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>), <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ ECDSA验证签名接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function verifies the ECDSA signature of a</span></span><br><span class="line"><span class="comment"> *                  previously-hashed message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            If the bitlength of the message hash is larger than the</span></span><br><span class="line"><span class="comment"> *                  bitlength of the group order, then the hash is truncated as</span></span><br><span class="line"><span class="comment"> *                  defined in &lt;em&gt;Standards for Efficient Cryptography Group</span></span><br><span class="line"><span class="comment"> *                  (SECG): SEC1 Elliptic Curve Cryptography&lt;/em&gt;, section</span></span><br><span class="line"><span class="comment"> *                  4.1.4, step 3.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The ECP group to use.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized and have group parameters</span></span><br><span class="line"><span class="comment"> *                  set, for example through mbedtls_ecp_group_load().</span></span><br><span class="line"><span class="comment"> * \param buf       The hashed content that was signed. This must be a readable</span></span><br><span class="line"><span class="comment"> *                  buffer of length \p blen Bytes. It may be \c NULL if</span></span><br><span class="line"><span class="comment"> *                  \p blen is zero.</span></span><br><span class="line"><span class="comment"> * \param blen      The length of \p buf in Bytes.</span></span><br><span class="line"><span class="comment"> * \param Q         The public key to use for verification. This must be</span></span><br><span class="line"><span class="comment"> *                  initialized and setup.</span></span><br><span class="line"><span class="comment"> * \param r         The first integer of the signature.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param s         The second integer of the signature.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          #MBEDTLS_ERR_ECP_BAD_INPUT_DATA if the signature</span></span><br><span class="line"><span class="comment"> *                  is invalid.</span></span><br><span class="line"><span class="comment"> * \return          An \c MBEDTLS_ERR_ECP_XXX or \c MBEDTLS_MPI_XXX</span></span><br><span class="line"><span class="comment"> *                  error code on failure for any other reason.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_verify</span><span class="params">( mbedtls_ecp_group *grp,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> blen,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> mbedtls_ecp_point *Q, <span class="keyword">const</span> mbedtls_mpi *r,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> mbedtls_mpi *s)</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 释放ECDSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function frees an ECDSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx       The ECDSA context to free. This may be \c NULL,</span></span><br><span class="line"><span class="comment"> *                  in which case this function does nothing. If it</span></span><br><span class="line"><span class="comment"> *                  is not \c NULL, it must be initialized.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecdsa_free</span><span class="params">( mbedtls_ecdsa_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-6"><a href="#编写测试函数-6" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>新建文件<code>mbedtls_ecdsa_test</code>，编写以下测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_ECDSA_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ecdsa.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> buf[<span class="number">97</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> qlen, dlen;</span><br><span class="line">    <span class="keyword">size_t</span> rlen, slen;</span><br><span class="line">    <span class="keyword">uint8_t</span> hash[<span class="number">32</span>];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *msg  = <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;ecdsa_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_mpi r, s;</span><br><span class="line">    mbedtls_ecdsa_context ctx;</span><br><span class="line">    <span class="keyword">mbedtls_md_context_t</span> md_ctx;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_md_init(&amp;md_ctx);</span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_mpi_init(&amp;r);</span><br><span class="line">    mbedtls_mpi_init(&amp;s);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. hash message */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Hash message...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_md(mbedtls_md_info_from_type(MBEDTLS_MD_SHA256), (<span class="keyword">uint8_t</span> *)msg, <span class="built_in">strlen</span>(msg), hash);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_md returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show hash */</span></span><br><span class="line">    dump_buf(hash, <span class="keyword">sizeof</span>(hash));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. generate keypair */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Generate ecdsa keypair...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdsa_genkey(&amp;ctx, MBEDTLS_ECP_DP_SECP256R1, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdsa_genkey returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show keypair */</span></span><br><span class="line">    mbedtls_ecp_point_write_binary(&amp;ctx.grp, &amp;ctx.Q, MBEDTLS_ECP_PF_UNCOMPRESSED, &amp;qlen, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dlen = mbedtls_mpi_size(&amp;ctx.d);</span><br><span class="line">    mbedtls_mpi_write_binary(&amp;ctx.d, buf + qlen, dlen);</span><br><span class="line">    dump_buf(buf, qlen + dlen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. ecdsa sign */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . ECDSA sign...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdsa_sign(&amp;ctx.grp, &amp;r, &amp;s, &amp;ctx.d, hash, <span class="keyword">sizeof</span>(hash), mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdsa_sign returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show sign */</span></span><br><span class="line">    rlen = mbedtls_mpi_size(&amp;r);</span><br><span class="line">    slen = mbedtls_mpi_size(&amp;s);</span><br><span class="line">    mbedtls_mpi_write_binary(&amp;r, buf, rlen);</span><br><span class="line">    mbedtls_mpi_write_binary(&amp;s, buf + rlen, slen);</span><br><span class="line">    dump_buf(buf, rlen + slen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. ecdsa verify */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . ECDSA verify...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdsa_verify(&amp;ctx.grp, hash, <span class="keyword">sizeof</span>(hash), &amp;ctx.Q, &amp;r, &amp;s);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdsa_verify returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_mpi_free(&amp;r);</span><br><span class="line">    mbedtls_mpi_free(&amp;s);</span><br><span class="line">    mbedtls_md_free(&amp;md_ctx);</span><br><span class="line">    mbedtls_ecdsa_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_DHM_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-7"><a href="#测试结果-7" class="headerlink" title="测试结果"></a>测试结果</h3><p>在main.c中声明该函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_ecdsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在main函数中调用该函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 9. ecdsa sign test */</span></span><br><span class="line">mbedtls_ecdsa_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载，在串口助手中查看结果：<br><img src="https://img-blog.csdnimg.cn/20201003193818564.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h1 id="九、数字证书及-X-509-证书标准"><a href="#九、数字证书及-X-509-证书标准" class="headerlink" title="九、数字证书及 X.509 证书标准"></a>九、数字证书及 X.509 证书标准</h1><h2 id="X-509证书标准"><a href="#X-509证书标准" class="headerlink" title="X.509证书标准"></a>X.509证书标准</h2><p>X.509是数字证书的一种标准格式，由国际电信联盟的标准化部分定义。</p>
<h3 id="X-509证书的结构"><a href="#X-509证书的结构" class="headerlink" title="X.509证书的结构"></a>X.509证书的结构</h3><p>X.509证书主要包括12个字段，如下表：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>字段</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>Version</td>
<td>版本</td>
<td>证书版本</td>
</tr>
<tr>
<td>Serial number</td>
<td>序列号</td>
<td>证书的唯一序列号</td>
</tr>
<tr>
<td>Signature</td>
<td>签名算法</td>
<td>CA对证书进行签名所使用的签名算法</td>
</tr>
<tr>
<td>Issuer</td>
<td>发行商名称</td>
<td>标识对证书进行签名并颁发的实体</td>
</tr>
<tr>
<td>Validity</td>
<td>有效期</td>
<td>标识证书的生效日期和终止日期</td>
</tr>
<tr>
<td>Subject</td>
<td>证书主体名称</td>
<td>标识获得证书的主体</td>
</tr>
<tr>
<td>Subject public key infomation</td>
<td>公钥</td>
<td>用于指示使用者公钥信息</td>
</tr>
<tr>
<td>Issure unique ID</td>
<td>颁发者唯一标识</td>
<td>用于标识证书签发机构</td>
</tr>
<tr>
<td>subject unique ID</td>
<td>使用者唯一标识</td>
<td>用于标识证书使用者实体</td>
</tr>
<tr>
<td>Extensions</td>
<td>扩展</td>
<td>一个或多个扩展域</td>
</tr>
<tr>
<td>signature Algorithm</td>
<td>签名算法</td>
<td>标识CA对证书签名所使用的签名算法和参数</td>
</tr>
<tr>
<td>signature Value</td>
<td>签名值</td>
<td>CA对证书的签名结果</td>
</tr>
</tbody></table>
<h3 id="获取证书示例（百度）"><a href="#获取证书示例（百度）" class="headerlink" title="获取证书示例（百度）"></a>获取证书示例（百度）</h3><p>下面以百度的证书为例讲解X.509证书标准。</p>
<p>使用浏览器访问百度首页：<a target="_blank" rel="noopener" href="https://www.baidu.com/%EF%BC%8C%E7%82%B9%E5%87%BB%E5%9F%9F%E5%90%8D%E6%97%81%E8%BE%B9%E7%9A%84%E3%80%90%E5%B0%8F%E7%BB%BF%E9%94%81%E3%80%91%EF%BC%8C%E7%82%B9%E5%87%BB%E3%80%90%E8%AF%81%E4%B9%A6%E3%80%91%E3%80%82">https://www.baidu.com/，点击域名旁边的【小绿锁】，点击【证书】。</a><br><img src="https://img-blog.csdnimg.cn/20201003204805665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>点击之后即可查看到百度的证书：<br><img src="https://img-blog.csdnimg.cn/20201003204907406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>① 点击【证书路径】，将一级证书（根证书）导出：<br><img src="https://img-blog.csdnimg.cn/20201003205037671.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>点击【详细信息】，将此证书内容【复制到文件】：<br><img src="https://img-blog.csdnimg.cn/20201003205127263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="、"><br>进入证书导出向导：<br><img src="https://img-blog.csdnimg.cn/2020100320522449.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>选择使用【Base64编码】导出：<br><img src="https://img-blog.csdnimg.cn/2020100320531961.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>选择导出文件路径：<br><img src="https://img-blog.csdnimg.cn/20201003205427731.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>导出成功：<img src="https://img-blog.csdnimg.cn/20201003205524237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>② 同样的方法，将二级证书导出为baidu_2.cer：<br><img src="https://img-blog.csdnimg.cn/20201003205629372.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>③ 同样的方法，将三级证书导出为baidu_3.cer：<br><img src="https://img-blog.csdnimg.cn/20201003205710197.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>三份证书如图：<br><img src="https://img-blog.csdnimg.cn/2020100320581770.png#pic_center" alt="img"><br>使用记事本打开任意一份，可以看到该证书内容：<img src="https://img-blog.csdnimg.cn/20201003205912844.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br><strong>新建一个空文件<code>baidu_ca.txt</code>，将三份内容按照次序复制到该文件中，后续使用</strong>。<br><img src="https://img-blog.csdnimg.cn/20201003210126170.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="查看百度证书内容"><a href="#查看百度证书内容" class="headerlink" title="查看百度证书内容"></a>查看百度证书内容</h3><p>使用openssl工具查看刚刚获取的百度证书内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -text -<span class="keyword">in</span> baidu_3.cer -noout</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>① 证书颁发者和使用者信息：<br><img src="https://img-blog.csdnimg.cn/20201004102053366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>② 公钥算法和公钥内容：<br><img src="https://img-blog.csdnimg.cn/20201004101257191.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>③ 签名算法和内容：<br><img src="https://img-blog.csdnimg.cn/2020100410141193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"><br>同样的方法可以查看百度二级证书和百度一级证书（根证书）的内容。</p>
<h2 id="X509证书解析验证功能的配置与使用"><a href="#X509证书解析验证功能的配置与使用" class="headerlink" title="X509证书解析验证功能的配置与使用"></a>X509证书解析验证功能的配置与使用</h2><h3 id="配置宏-7"><a href="#配置宏-7" class="headerlink" title="配置宏"></a>配置宏</h3><p>①</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_C</span></span><br></pre></td></tr></table></figure>
<p>②</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>③</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>④</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br></pre></td></tr></table></figure>
<p>⑤</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_USE_C</span></span><br></pre></td></tr></table></figure>
<p>⑥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BASE64_C</span></span><br></pre></td></tr></table></figure>
<p>⑦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PEM_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>⑧</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>新建配置文件<code>mbedtls_config_x509.h</code>，编辑以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_X509_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_X509_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_PARSE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_USE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BASE64_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PEM_PARSE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_X509_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK中配置使用该文件：<br><img src="https://img-blog.csdnimg.cn/20201004132201128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<h3 id="API说明-1"><a href="#API说明-1" class="headerlink" title="API说明"></a>API说明</h3><p>使用时需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/x509_crt.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化证书结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_x509_crt_init</span><span class="params">( mbedtls_x509_crt *crt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 证书解析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Parse one DER-encoded or one or more concatenated PEM-encoded</span></span><br><span class="line"><span class="comment"> *                 certificates and add them to the chained list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 For CRTs in PEM encoding, the function parses permissively:</span></span><br><span class="line"><span class="comment"> *                 if at least one certificate can be parsed, the function</span></span><br><span class="line"><span class="comment"> *                 returns the number of certificates for which parsing failed</span></span><br><span class="line"><span class="comment"> *                 (hence \c 0 if all certificates were parsed successfully).</span></span><br><span class="line"><span class="comment"> *                 If no certificate could be parsed, the function returns</span></span><br><span class="line"><span class="comment"> *                 the first (negative) error encountered during parsing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 PEM encoded certificates may be interleaved by other data</span></span><br><span class="line"><span class="comment"> *                 such as human readable descriptions of their content, as</span></span><br><span class="line"><span class="comment"> *                 long as the certificates are enclosed in the PEM specific</span></span><br><span class="line"><span class="comment"> *                 &#x27;-----&#123;BEGIN/END&#125; CERTIFICATE-----&#x27; delimiters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param chain    The chain to which to add the parsed certificates.</span></span><br><span class="line"><span class="comment"> * \param buf      The buffer holding the certificate data in PEM or DER format.</span></span><br><span class="line"><span class="comment"> *                 For certificates in PEM encoding, this may be a concatenation</span></span><br><span class="line"><span class="comment"> *                 of multiple certificates; for DER encoding, the buffer must</span></span><br><span class="line"><span class="comment"> *                 comprise exactly one certificate.</span></span><br><span class="line"><span class="comment"> * \param buflen   The size of \p buf, including the terminating \c NULL byte</span></span><br><span class="line"><span class="comment"> *                 in case of PEM encoded data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if all certificates were parsed successfully.</span></span><br><span class="line"><span class="comment"> * \return         The (positive) number of certificates that couldn&#x27;t</span></span><br><span class="line"><span class="comment"> *                 be parsed if parsing was partly successful (see above).</span></span><br><span class="line"><span class="comment"> * \return         A negative X509 or PEM error code otherwise.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_parse</span><span class="params">( mbedtls_x509_crt *chain, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> buflen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 获取证书信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Returns an informational string about the</span></span><br><span class="line"><span class="comment"> *                 certificate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param buf      Buffer to write to</span></span><br><span class="line"><span class="comment"> * \param size     Maximum size of buffer</span></span><br><span class="line"><span class="comment"> * \param prefix   A line prefix</span></span><br><span class="line"><span class="comment"> * \param crt      The X509 certificate to represent</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         The length of the string written (not including the</span></span><br><span class="line"><span class="comment"> *                 terminated nul byte), or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_info</span><span class="params">( <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *prefix,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> mbedtls_x509_crt *crt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 获取证书认证信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Returns an informational string about the</span></span><br><span class="line"><span class="comment"> *                 verification status of a certificate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param buf      Buffer to write to</span></span><br><span class="line"><span class="comment"> * \param size     Maximum size of buffer</span></span><br><span class="line"><span class="comment"> * \param prefix   A line prefix</span></span><br><span class="line"><span class="comment"> * \param flags    Verification flags created by mbedtls_x509_crt_verify()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         The length of the string written (not including the</span></span><br><span class="line"><span class="comment"> *                 terminated nul byte), or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_verify_info</span><span class="params">( <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *prefix,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">uint32_t</span> flags )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 证书认证</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Verify a chain of certificates.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 The verify callback is a user-supplied callback that</span></span><br><span class="line"><span class="comment"> *                 can clear / modify / add flags for a certificate. If set,</span></span><br><span class="line"><span class="comment"> *                 the verification callback is called for each</span></span><br><span class="line"><span class="comment"> *                 certificate in the chain (from the trust-ca down to the</span></span><br><span class="line"><span class="comment"> *                 presented crt). The parameters for the callback are:</span></span><br><span class="line"><span class="comment"> *                 (void *parameter, mbedtls_x509_crt *crt, int certificate_depth,</span></span><br><span class="line"><span class="comment"> *                 int *flags). With the flags representing current flags for</span></span><br><span class="line"><span class="comment"> *                 that specific certificate and the certificate depth from</span></span><br><span class="line"><span class="comment"> *                 the bottom (Peer cert depth = 0).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 All flags left after returning from the callback</span></span><br><span class="line"><span class="comment"> *                 are also returned to the application. The function should</span></span><br><span class="line"><span class="comment"> *                 return 0 for anything (including invalid certificates)</span></span><br><span class="line"><span class="comment"> *                 other than fatal error, as a non-zero return code</span></span><br><span class="line"><span class="comment"> *                 immediately aborts the verification process. For fatal</span></span><br><span class="line"><span class="comment"> *                 errors, a specific error code should be used (different</span></span><br><span class="line"><span class="comment"> *                 from MBEDTLS_ERR_X509_CERT_VERIFY_FAILED which should not</span></span><br><span class="line"><span class="comment"> *                 be returned at this point), or MBEDTLS_ERR_X509_FATAL_ERROR</span></span><br><span class="line"><span class="comment"> *                 can be used if no better code is available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           In case verification failed, the results can be displayed</span></span><br><span class="line"><span class="comment"> *                 using \c mbedtls_x509_crt_verify_info()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Same as \c mbedtls_x509_crt_verify_with_profile() with the</span></span><br><span class="line"><span class="comment"> *                 default security profile.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           It is your responsibility to provide up-to-date CRLs for</span></span><br><span class="line"><span class="comment"> *                 all trusted CAs. If no CRL is provided for the CA that was</span></span><br><span class="line"><span class="comment"> *                 used to sign the certificate, CRL verification is skipped</span></span><br><span class="line"><span class="comment"> *                 silently, that is *without* setting any flag.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The \c trust_ca list can contain two types of certificates:</span></span><br><span class="line"><span class="comment"> *                 (1) those of trusted root CAs, so that certificates</span></span><br><span class="line"><span class="comment"> *                 chaining up to those CAs will be trusted, and (2)</span></span><br><span class="line"><span class="comment"> *                 self-signed end-entity certificates to be trusted (for</span></span><br><span class="line"><span class="comment"> *                 specific peers you know) - in that case, the self-signed</span></span><br><span class="line"><span class="comment"> *                 certificate doesn&#x27;t need to have the CA bit set.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param crt      The certificate chain to be verified.</span></span><br><span class="line"><span class="comment"> * \param trust_ca The list of trusted CAs.</span></span><br><span class="line"><span class="comment"> * \param ca_crl   The list of CRLs for trusted CAs.</span></span><br><span class="line"><span class="comment"> * \param cn       The expected Common Name. This will be checked to be</span></span><br><span class="line"><span class="comment"> *                 present in the certificate&#x27;s subjectAltNames extension or,</span></span><br><span class="line"><span class="comment"> *                 if this extension is absent, as a CN component in its</span></span><br><span class="line"><span class="comment"> *                 Subject name. Currently only DNS names are supported. This</span></span><br><span class="line"><span class="comment"> *                 may be \c NULL if the CN need not be verified.</span></span><br><span class="line"><span class="comment"> * \param flags    The address at which to store the result of the verification.</span></span><br><span class="line"><span class="comment"> *                 If the verification couldn&#x27;t be completed, the flag value is</span></span><br><span class="line"><span class="comment"> *                 set to (uint32_t) -1.</span></span><br><span class="line"><span class="comment"> * \param f_vrfy   The verification callback to use. See the documentation</span></span><br><span class="line"><span class="comment"> *                 of mbedtls_x509_crt_verify() for more information.</span></span><br><span class="line"><span class="comment"> * \param p_vrfy   The context to be passed to \p f_vrfy.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if the chain is valid with respect to the</span></span><br><span class="line"><span class="comment"> *                 passed CN, CAs, CRLs and security profile.</span></span><br><span class="line"><span class="comment"> * \return         #MBEDTLS_ERR_X509_CERT_VERIFY_FAILED in case the</span></span><br><span class="line"><span class="comment"> *                 certificate chain verification failed. In this case,</span></span><br><span class="line"><span class="comment"> *                 \c *flags will have one or more</span></span><br><span class="line"><span class="comment"> *                 \c MBEDTLS_X509_BADCERT_XXX or \c MBEDTLS_X509_BADCRL_XXX</span></span><br><span class="line"><span class="comment"> *                 flags set.</span></span><br><span class="line"><span class="comment"> * \return         Another negative error code in case of a fatal error</span></span><br><span class="line"><span class="comment"> *                 encountered during the verification process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_verify</span><span class="params">( mbedtls_x509_crt *crt,</span></span></span><br><span class="line"><span class="function"><span class="params">                     mbedtls_x509_crt *trust_ca,</span></span></span><br><span class="line"><span class="function"><span class="params">                     mbedtls_x509_crl *ca_crl,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> <span class="keyword">char</span> *cn, <span class="keyword">uint32_t</span> *flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_vrfy)(<span class="keyword">void</span> *, mbedtls_x509_crt *, <span class="keyword">int</span>, <span class="keyword">uint32_t</span> *),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_vrfy )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ 释放证书结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Unallocate all certificate data</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param crt      Certificate chain to free</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_x509_crt_free</span><span class="params">( mbedtls_x509_crt *crt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \name X509 Error codes</span></span><br><span class="line"><span class="comment"> * \&#123;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_FEATURE_UNAVAILABLE              -0x2080  <span class="comment">/**&lt; Unavailable feature, e.g. RSA hashing/encryption combination. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_UNKNOWN_OID                      -0x2100  <span class="comment">/**&lt; Requested OID is unknown. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_FORMAT                   -0x2180  <span class="comment">/**&lt; The CRT/CRL/CSR format is invalid, e.g. different type expected. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_VERSION                  -0x2200  <span class="comment">/**&lt; The CRT/CRL/CSR version element is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_SERIAL                   -0x2280  <span class="comment">/**&lt; The serial tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_ALG                      -0x2300  <span class="comment">/**&lt; The algorithm tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_NAME                     -0x2380  <span class="comment">/**&lt; The name tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_DATE                     -0x2400  <span class="comment">/**&lt; The date tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_SIGNATURE                -0x2480  <span class="comment">/**&lt; The signature tag or value invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_EXTENSIONS               -0x2500  <span class="comment">/**&lt; The extension tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_UNKNOWN_VERSION                  -0x2580  <span class="comment">/**&lt; CRT/CRL/CSR has an unsupported version number. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_UNKNOWN_SIG_ALG                  -0x2600  <span class="comment">/**&lt; Signature algorithm (oid) is unsupported. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_SIG_MISMATCH                     -0x2680  <span class="comment">/**&lt; Signature algorithms do not match. (see \c ::mbedtls_x509_crt sig_oid) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_CERT_VERIFY_FAILED               -0x2700  <span class="comment">/**&lt; Certificate verification failed, e.g. CRL, CA or signature check failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_CERT_UNKNOWN_FORMAT              -0x2780  <span class="comment">/**&lt; Format not recognized as DER or PEM. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_BAD_INPUT_DATA                   -0x2800  <span class="comment">/**&lt; Input invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_ALLOC_FAILED                     -0x2880  <span class="comment">/**&lt; Allocation of memory failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_FILE_IO_ERROR                    -0x2900  <span class="comment">/**&lt; Read/write of file failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_BUFFER_TOO_SMALL                 -0x2980  <span class="comment">/**&lt; Destination buffer is too small. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_FATAL_ERROR                      -0x3000  <span class="comment">/**&lt; A fatal error occurred, eg the chain is too long or the vrfy callback failed. */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-7"><a href="#编写测试函数-7" class="headerlink" title="编写测试函数"></a>编写测试函数</h3><p>编写头文件<code>baidu_certs.h</code>，将百度的证书存储：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __CERTS_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CERTS_H__</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> baidu_ca_cert[] =</span><br><span class="line"><span class="string">&quot;-----BEGIN CERTIFICATE-----\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;MIIKLjCCCRagAwIBAgIMclh4Nm6fVugdQYhIMA0GCSqGSIb3DQEBCwUAMGYxCzAJ\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BgNVBAYTAkJFMRkwFwYDVQQKExBHbG9iYWxTaWduIG52LXNhMTwwOgYDVQQDEzNH\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bG9iYWxTaWduIE9yZ2FuaXphdGlvbiBWYWxpZGF0aW9uIENBIC0gU0hBMjU2IC0g\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;RzIwHhcNMjAwNDAyMDcwNDU4WhcNMjEwNzI2MDUzMTAyWjCBpzELMAkGA1UEBhMC\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;Q04xEDAOBgNVBAgTB2JlaWppbmcxEDAOBgNVBAcTB2JlaWppbmcxJTAjBgNVBAsT\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;HHNlcnZpY2Ugb3BlcmF0aW9uIGRlcGFydG1lbnQxOTA3BgNVBAoTMEJlaWppbmcg\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;QmFpZHUgTmV0Y29tIFNjaWVuY2UgVGVjaG5vbG9neSBDby4sIEx0ZDESMBAGA1UE\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;AxMJYmFpZHUuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwamw\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;rkca0lfrHRUfblyy5PgLINvqAN8p/6RriSZLnyMv7FewirhGQCp+vNxaRZdPrUEO\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;vCCGSwxdVSFH4jE8V6fsmUfrRw1y18gWVHXv00URD0vOYHpGXCh0ro4bvthwZnuo\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;k0ko0qN2lFXefCfyD/eYDK2G2sau/Z/w2YEympfjIe4EkpbkeBHlxBAOEDF6Speg\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;68ebxNqJN6nDN9dWsX9Sx9kmCtavOBaxbftzebFoeQOQ64h7jEiRmFGlB5SGpXhG\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;eY9Ym+k1Wafxe1cxCpDPJM4NJOeSsmrp5pY3Crh8hy900lzoSwpfZhinQYbPJqYI\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;jqVJF5JTs5Glz1OwMQIDAQABo4IGmDCCBpQwDgYDVR0PAQH/BAQDAgWgMIGgBggr\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BgEFBQcBAQSBkzCBkDBNBggrBgEFBQcwAoZBaHR0cDovL3NlY3VyZS5nbG9iYWxz\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;aWduLmNvbS9jYWNlcnQvZ3Nvcmdhbml6YXRpb252YWxzaGEyZzJyMS5jcnQwPwYI\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;KwYBBQUHMAGGM2h0dHA6Ly9vY3NwMi5nbG9iYWxzaWduLmNvbS9nc29yZ2FuaXph\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dGlvbnZhbHNoYTJnMjBWBgNVHSAETzBNMEEGCSsGAQQBoDIBFDA0MDIGCCsGAQUF\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BwIBFiZodHRwczovL3d3dy5nbG9iYWxzaWduLmNvbS9yZXBvc2l0b3J5LzAIBgZn\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;gQwBAgIwCQYDVR0TBAIwADBJBgNVHR8EQjBAMD6gPKA6hjhodHRwOi8vY3JsLmds\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;b2JhbHNpZ24uY29tL2dzL2dzb3JnYW5pemF0aW9udmFsc2hhMmcyLmNybDCCA04G\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;A1UdEQSCA0UwggNBggliYWlkdS5jb22CDGJhaWZ1YmFvLmNvbYIMd3d3LmJhaWR1\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;LmNughB3d3cuYmFpZHUuY29tLmNugg9tY3QueS5udW9taS5jb22CC2Fwb2xsby5h\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dXRvggZkd3ouY26CCyouYmFpZHUuY29tgg4qLmJhaWZ1YmFvLmNvbYIRKi5iYWlk\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dXN0YXRpYy5jb22CDiouYmRzdGF0aWMuY29tggsqLmJkaW1nLmNvbYIMKi5oYW8x\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;MjMuY29tggsqLm51b21pLmNvbYINKi5jaHVhbmtlLmNvbYINKi50cnVzdGdvLmNv\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bYIPKi5iY2UuYmFpZHUuY29tghAqLmV5dW4uYmFpZHUuY29tgg8qLm1hcC5iYWlk\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dS5jb22CDyoubWJkLmJhaWR1LmNvbYIRKi5mYW55aS5iYWlkdS5jb22CDiouYmFp\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;ZHViY2UuY29tggwqLm1pcGNkbi5jb22CECoubmV3cy5iYWlkdS5jb22CDiouYmFp\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;ZHVwY3MuY29tggwqLmFpcGFnZS5jb22CCyouYWlwYWdlLmNugg0qLmJjZWhvc3Qu\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;Y29tghAqLnNhZmUuYmFpZHUuY29tgg4qLmltLmJhaWR1LmNvbYISKi5iYWlkdWNv\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bnRlbnQuY29tggsqLmRsbmVsLmNvbYILKi5kbG5lbC5vcmeCEiouZHVlcm9zLmJh\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;aWR1LmNvbYIOKi5zdS5iYWlkdS5jb22CCCouOTEuY29tghIqLmhhbzEyMy5iYWlk\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dS5jb22CDSouYXBvbGxvLmF1dG+CEioueHVlc2h1LmJhaWR1LmNvbYIRKi5iai5i\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;YWlkdWJjZS5jb22CESouZ3ouYmFpZHViY2UuY29tgg4qLnNtYXJ0YXBwcy5jboIN\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;Ki5iZHRqcmN2LmNvbYIMKi5oYW8yMjIuY29tggwqLmhhb2thbi5jb22CDyoucGFl\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;LmJhaWR1LmNvbYIRKi52ZC5iZHN0YXRpYy5jb22CEmNsaWNrLmhtLmJhaWR1LmNv\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bYIQbG9nLmhtLmJhaWR1LmNvbYIQY20ucG9zLmJhaWR1LmNvbYIQd24ucG9zLmJh\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;aWR1LmNvbYIUdXBkYXRlLnBhbi5iYWlkdS5jb20wHQYDVR0lBBYwFAYIKwYBBQUH\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;AwEGCCsGAQUFBwMCMB8GA1UdIwQYMBaAFJbeYfG9HBYpUxzAzH07gwBA5hp8MB0G\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;A1UdDgQWBBSeyXnX6VurihbMMo7GmeafIEI1hzCCAX4GCisGAQQB1nkCBAIEggFu\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BIIBagFoAHYAXNxDkv7mq0VEsV6a1FbmEDf71fpH3KFzlLJe5vbHDsoAAAFxObU8\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;ugAABAMARzBFAiBphmgxIbNZXaPWiUqXRWYLaRST38KecoekKIof5fXmsgIhAMkZ\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;tF8XyKCu/nZll1e9vIlKbW8RrUr/74HpmScVRRsBAHYAb1N2rDHwMRnYmQCkURX/\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dxUcEdkCwQApBo2yCJo32RMAAAFxObU85AAABAMARzBFAiBURWwwTgXZ+9IV3mhm\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;E0EOzbg901DLRszbLIpafDY/XgIhALsvEGqbBVrpGxhKoTVlz7+GWom8SrfUeHcn\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;4+9Dn7xGAHYA9lyUL9F3MCIUVBgIMJRWjuNNExkzv98MLyALzE7xZOMAAAFxObU8\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;qwAABAMARzBFAiBFBYPxKEdhlf6bqbwxQY7tskgdoFulPxPmdrzS5tNpPwIhAKnK\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;qwzch98lINQYzLAV52+C8GXZPXFZNfhfpM4tQ6xbMA0GCSqGSIb3DQEBCwUAA4IB\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;AQC83ALQ2d6MxeLZ/k3vutEiizRCWYSSMYLVCrxANdsGshNuyM8B8V/A57c0Nzqo\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;CPKfMtX5IICfv9P/bUecdtHL8cfx24MzN+U/GKcA4r3a/k8pRVeHeF9ThQ2zo1xj\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;k/7gJl75koztdqNfOeYiBTbFMnPQzVGqyMMfqKxbJrfZlGAIgYHT9bd6T985IVgz\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;tRVjAoy4IurZenTsWkG7PafJ4kAh6jQaSu1zYEbHljuZ5PXlkhPO9DwW1WIPug6Z\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;rlylLTTYmlW3WETOATi70HYsZN6NACuZ4t1hEO3AsF7lqjdA2HwTN10FX2HuaUvf\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;5OzP+PKupV9VKw8x8mQKU6vr\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;-----END CERTIFICATE-----\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>编写测试函数文件<code>mbedtls_x509_test.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   X509 Function demo</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/10/04</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_X509_CRT_PARSE_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/x509_crt.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;baidu_certs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">   </span><br><span class="line">    mbedtls_x509_crt cert, cacert;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_x509_crt_init(&amp;cert);</span><br><span class="line">    mbedtls_x509_crt_init(&amp;cacert);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. Parser cacert */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Parse cacert...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_x509_crt_parse(&amp;cacert, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)baidu_ca_cert, <span class="keyword">sizeof</span>(baidu_ca_cert));</span><br><span class="line">     <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_x509_crt_parse cacert returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. Cacert parser result */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Cacert parser result...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_x509_crt_info(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, <span class="string">&quot;      &quot;</span>, &amp;cacert);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail! mbedtls_x509_crt_info return %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buf[ret] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ok!\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;crt info has %d chars\r\n&quot;</span>, <span class="built_in">strlen</span>(buf));    </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:  </span><br><span class="line">    <span class="comment">/* 3. release structure */</span></span><br><span class="line">    mbedtls_x509_crt_free(&amp;cert);</span><br><span class="line">    mbedtls_x509_crt_free(&amp;cacert);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_RSA_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-8"><a href="#测试结果-8" class="headerlink" title="测试结果"></a>测试结果</h3><p>在main.c中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_x509_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在main函数中调用该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 10. x509 test */</span></span><br><span class="line">mbedtls_x509_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载、测试结果为：<br><img src="https://img-blog.csdnimg.cn/20201004131906865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>

        <p class="suffix-end">__END__</p>
        <div class="suffix-box">
            <div class="suffix-box-left">
                <img src="https://www.notes.worstone.cn/image/hexo.png" alt="creekwater">
            </div>
            <div class="suffix-box-right">
                <span class="suffix-box-title">文章作者</span>：creekwater
                <br>
                <span class="suffix-box-title">文章出处</span>：<a href="www.creekwater.cn" target="_blank">灵溪驿站</a>
                <br>
                <span class="suffix-box-title">作者签名</span>：当生活心怀歹毒地将一切都搞成了黑色幽默，我顺水推舟把自己变成了一个受过高等教育的流氓。
                <br>
                <span class="suffix-box-title">关于主题</span>：<a href="https://github.com/first19326/Hexo-LiveForCode" target="_blank">Hexo - Live For Code</a>
                <br>
                <span class="suffix-box-title">版权声明</span>：文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" title="BY-NC-SA" target="_blank">BY-NC-SA</a> 许可协议，转载请注明出处
                <br>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>
    <div class="article-footer">
        
            <div class="category">
                分类：
                
                    <a href="/category/ESP/">ESP</a>
                
            </div>
        
        
            <div class="tag">
                标签：
                
                    <a href="/tag/ESP/">ESP</a>
                
            </div>
        
        <div class="article-prev-next">
            
                <a href="/2021/01/05/%E4%B9%90%E9%91%AB/panic%E5%88%86%E6%9E%90/2%E3%80%81%E5%86%99%E5%85%A5%E4%B8%B2%E5%8F%A3/" class="prev-prefix">« </a> 上一篇：    <a href="/2021/01/05/%E4%B9%90%E9%91%AB/panic%E5%88%86%E6%9E%90/2%E3%80%81%E5%86%99%E5%85%A5%E4%B8%B2%E5%8F%A3/" title="发布于 2021-01-05 12:00">panic写入串口</a>
                <br>
            
            
        </div>
    </div>
    
    <div class="article-comments">
        <div class="comments-title">
            评论列表
        </div>
        <div class="comments-content">
        </div>
    </div>

</div>

    </div>
</div>
    <div id="footer"></div>
    <div id="sidebar">
    <div class="menu-wrap" style="display:none;">
        <nav class="menu">
            <div class="menu-introduce"> 
                <div class="introduce-avatar"></div> 
                <div class="introduce-info"> 
                    <div class="introduce-user"><span></span></div>        
                </div> 
            </div> 
            <div class="menu-list">
                <ul></ul> 
            </div> 
            <div class="menu-link"></div> 
        </nav>
        <button class="menu-button-close"></button>
        <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
            </svg>
        </div>
    </div>
    <button class="menu-button-open">MENU</button>
    <div class="menu-cover"></div>
</div>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/search.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/iscroll.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/instantsearch.min.js"></script>
<div class="search-window">
    <div class="search-content">
        <div class="search-content-icon">
            <i class="iconfont icon-search"></i>
        </div>
        <div id="search-input" class="search-input"></div>
    </div>

    <div class="search-scroll">
        <div class="search-result">
            <div id="search-stats" class="search-stats"></div>
            <div id="search-hits"></div>
            <div id="search-pagination" class="search-pagination"></div>
        </div>
    </div>

    <span class="search-close-icon">
        <i class="iconfont icon-close"></i>
    </span>
</div>
    <div id="tools">
    <div class="progressbar-top"></div>

    
        <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/Meting.min.js"></script>
        <meting-js id="3778678" lrcshow="false" server="netease" type="playlist" fixed="true" autoplay="false" loop="all" order="random" preload="auto" volume="0.67" mutex="true"></meting-js>
    
    
    <div class="wrap-right"></div>
    <div class="loading"></div>
</div>
    <script>
    window.config = {
        GitHubUserName     : 'first19326',
        GitHubRepositories : 'Hexo-LiveForCode',

        BlogUser      : 'creekwater',
        BlogAvatar    : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/sidebar/avatar.jpg',
        BlogStartDate : '2020-01-01',

        WebsiteTitleBlur         : '小可爱呢 (◍´꒳`◍)',
        WebsiteTitleBlurTimeOut  : 500,
        WebsiteTitleFocus        : '(*´∇｀*) 欢迎回来!',
        WebsiteTitleFocusTimeOut : 1000,
        WebsiteFavicon           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/website/logo.png',

        ProgressBar: {
            id       : 'topProgressBar',
            color    : '#77B6FF',
            height   : '2px',
            duration : 0.2
        },

        Loading: {
            rebound: {
                tension  : 16,
                friction : 5
            },
            spinner: {
                id     : 'spinner',
                radius : 90,
                sides  : 3,
                depth  : 4,
                colors : {
                    background : '#F0F0F0',
                    stroke     : '#272633',
                    base       : '',
                    child      : '#272633'
                },
                alwaysForward : true,
                restAt        : 0.5,
                renderBase    : false
            }
        },

        HomeHeaderAnimationRendered : true,
        HomeHeaderAnimation         : {
            radius      : 15,
            density     : 0.2,
            color       : 'rgba(255, 255, 255, .2)',
            clearOffset : 0.3
        },

        ArticleHeaderAnimationRendered : false,
        ArticleHeaderAnimation         : {
            triW                  : 14,
            triH                  : 20,
            neighbours            : [
                
                    'side',
                
                    'top',
                
                    'bottom',
                
            ],
            speedTrailAppear      : 0.1,
            speedTrailDisappear   : 0.1,
            speedTriOpen          : 1,
            trailMaxLength        : 30,
            trailIntervalCreation : 100,
            delayBeforeDisappear  : 2,
            colors                : [
                
                    '#96EDA6',
                
                    '#5BC6A9',
                
                    '#38668C',
                
                    '#374D84',
                
                    '#BED5CB',
                
                    '#62ADC6',
                
                    '#8EE5DE',
                
                    '#304E7B',
                
            ]
        },

        BackAnimationRendered          : true,
        IEBrowserBackAnimationRendered : false,
        BackAnimation                  : {
            colorSaturation  : '60%',
            colorBrightness  : '50%',
            colorAlpha       : 0.5,
            colorCycleSpeed  : 5,
            verticalPosition : 'random',
            horizontalSpeed  : 200,
            ribbonCount      : 3,
            strokeSize       : 0,
            parallaxAmount   : -0.2,
            animateSections  : true
        },

        HomeHeaderImage : [
            
                'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/header/home.jpg',
            
                'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/header/home.jpeg',
            
        ],
        HomeBannerText  : '',

        ArticleHeaderImage : [
            
                'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/header/article.jpg',
            
        ],

        OtherBannerText : '',

        MenuList : [
            
                {
                    name   : '首页',
                    href   : '/',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '标签',
                    href   : '/tag',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '分类',
                    href   : '/category',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '归档',
                    href   : '/archive',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '赞赏',
                    href   : '/donate',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '关于',
                    href   : '/about',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '订阅',
                    href   : '/atom.xml',    
                    target : '_blank',
                    class  : ''
                },
            
                {
                    name   : '搜索',
                    href   : '',    
                    target : '',
                    class  : 'search'
                },
            
                {
                    name   : '留言板',
                    href   : '/comment',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '友情链接',
                    href   : '/friend',    
                    target : '',
                    class  : ''
                },
            
        ],
        MenuLink : [
            
                
                    {
                        icon : 'icon-weibo', 
                        url  : ''
                    },
                
                    {
                        icon : 'icon-wechat', 
                        url  : ''
                    },
                
                    {
                        icon : 'icon-qq', 
                        url  : ''
                    },
                
                    {
                        icon : 'icon-github', 
                        url  : 'https://github.com/flyghost'
                    },
                
            
        ],

        FooterStyle : 2,
        BottomText  : {
            icon    : 'like-fill',
            left    : '人生若只如初见',
            right   : '何事秋风悲画扇'
        },
        ThemeInfo   : false,

        ConsoleList : [
            
                
                    [
                        
                            
                                'Based on cnblogs theme SimpleMemory.',
                            
                                '',
                            
                        
                    ],
                
                    [
                        
                            
                                'SimpleMemory Author:',
                            
                                'BNDong',
                            
                        
                    ],
                
                    [
                        
                            
                                'Theme:',
                            
                                'LiveForCode',
                            
                        
                    ],
                
            
        ],

        FontIconExtend : '',

        Donate : {
            paypal  : '',
            bitcoin : '',
            alipay  : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/donate/alipay.png',
            wechat  : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/donate/wechat.png'
        },

        Code : {
            style : 'normal'
        },  

        Search : {
            applicationID : '010C3EANT8',
            apiKey        : 'c7abab9f11b79102b9aff7fe6d41447d',
            indexName     : 'Notes',
            hits          : {
                page : 10
            },
            labels        : {
                placeholder : '搜索',
                empty       : '未发现与 「${query}」 相关的内容',
                stats       : '${hits} 条相关条目，使用了 ${time} 毫秒',
            }
        }, 

        Valine : {
            switch         : true,
            el             : '.comments-content',
            appId          : 'srhKtvWPQTWYKh3qX8G8M7v0-gzGzoHsz',
            appKey         : '8uVSP1q6UlALVC5igYfIfv2h',
            placeholder    : '你是我一生只会遇见一次的惊喜...',
            avatar         : 'mm',
            meta           : 'nick,mail,link',
            requiredFields : 'nick,mail',
            pageSize       : 5,
            lang           : 'zh-cn',
            visitor        : true,
            enableQQ       : true
        },

        Tocbot : {
            switch                : true,
            tocSelector           : '.toc',
            contentSelector       : '.article-body',
            headingSelector       : 'h1, h2, h3, h4, h5',
            headingsOffset        : 0,
            scrollSmooth          : true,
            scrollSmoothOffset    : -5,
            positionFixedSelector : '.toc',
            positionFixedClass    : 'toc-fixed',
            fixedSidebarOffset    : '',
        },

        Require : {
            baseUrl     : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/',
            waitSeconds : 100
        },

        Music : {
            type : 'Meting'
        },
        APlayer : {
            container : '.aplayer',
            fixed     : true,
            autoplay  : false,
            loop      : 'all',
            order     : 'random',
            preload   : 'auto',
            volume    : 0.67,
            mutex     : true,
            lrcType   : 3,
            audio     : [
                
                    {
                        name   : 'aLIEz',
                        artist : 'mizuki（瑞葵）',
                        cover  : '/music/cover/aLIEz.jpg',
                        url    : '/music/song/aLIEz.mp3',
                        lrc    : '/music/lrc/aLIEz.lrc'
                    },
                
                    {
                        name   : 'Endless Tears',
                        artist : 'CLIFF EDGE',
                        cover  : '/music/cover/Endless Tears.jpg',
                        url    : '/music/song/Endless Tears.mp3',
                        lrc    : '/music/lrc/Endless Tears.lrc'
                    },
                
                    {
                        name   : 'Miracle',
                        artist : 'Cascada',
                        cover  : '/music/cover/Miracle.jpg',
                        url    : '/music/song/Miracle.mp3',
                        lrc    : '/music/lrc/Miracle.lrc'
                    },
                
                    {
                        name   : 'Roll The Dice',
                        artist : '高珊',
                        cover  : '/music/cover/Roll The Dice.jpg',
                        url    : '/music/song/Roll The Dice.mp3',
                        lrc    : '/music/lrc/Roll The Dice.lrc'
                    },
                
                    {
                        name   : 'See You Again',
                        artist : 'Charlie Puth, Wiz Khalifa',
                        cover  : '/music/cover/See You Again.jpg',
                        url    : '/music/song/See You Again.mp3',
                        lrc    : '/music/lrc/See You Again.lrc'
                    },
                
                    {
                        name   : 'Traveling Light',
                        artist : 'Joel Hanson, Sara Groves',
                        cover  : '/music/cover/Traveling Light.jpg',
                        url    : '/music/song/Traveling Light.mp3',
                        lrc    : '/music/lrc/Traveling Light.lrc'
                    },
                
                    {
                        name   : '痴心绝对',
                        artist : '李圣杰',
                        cover  : '/music/cover/痴心绝对.jpg',
                        url    : '/music/song/痴心绝对.mp3',
                        lrc    : '/music/lrc/痴心绝对.lrc'
                    },
                
                    {
                        name   : '好想大声说爱你',
                        artist : 'BAAD（バード）',
                        cover  : '/music/cover/好想大声说爱你.jpg',
                        url    : '/music/song/好想大声说爱你.mp3',
                        lrc    : '/music/lrc/好想大声说爱你.lrc'
                    },
                
            ]
        },
        Meting : {
            id       : '3778678', 
            lrcshow  : false, 
            server   : 'netease', 
            type     : 'playlist', 
            fixed    : true, 
            autoplay : false, 
            loop     : 'all', 
            order    : 'random', 
            preload  : 'auto', 
            volume   : 0.67, 
            mutex    : true
        },

        LazyLoad : {
            default : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/image/website/lazyload.svg'
        },
  
        Style : {
            aplayer          : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/APlayer.css',
            archive          : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/archive.css',
            donate           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/donate.css',
            fancybox         : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/jquery.fancybox.css',
            footer           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/footer.css',
            iconfont         : 'https://at.alicdn.com/t/font_1546312_l3yohatebw.css',
            index            : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/index.css',
            menuBubble       : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/menu-bubble.css',
            page             : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/page.css',
            post             : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/post.css',
            search           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/search.css',
            tocbot           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/tocbot.css',
            normal           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/normal.css',
            night            : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/night.css',
            clipboard        : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/css/clipboard.css'
        },

        Script: {
            aplayer          : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/APlayer.min.js',
            config           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/require.config.js',
            index            : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/index.js',
            instantSearch    : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/instantsearch.min.js',
            jQuery           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/jquery-3.4.1.min.js',
            loading          : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/loading.js',
            meting           : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/Meting.min.js',
            iscroll          : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/iscroll.js',
            require          : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/require.min.js'
        },

        Font: {
            LongCang   : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/LongCang.css',
            Monda      : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/Monda.css',
            NotoSansSC : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/NotoSansSC.css',
            Playball   : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/Playball.css',
            PTMono     : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/PTMono.css',
            RobotoSlab : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/RobotoSlab.css',
            Rosario    : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/Rosario.css',
            UbuntuMono : 'https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/font/UbuntuMono.css'
        },

        Suffix : {
            about : '简单地活着, 肆意又精彩.'
        },
            
        Theme : {
            url  : 'https://github.com/first19326/Hexo-LiveForCode',
            name : 'Hexo - Live For Code'
        }  
    };
</script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/hexo-liveforcode@master/static/js/index.js"></script>
</body>
</html>
